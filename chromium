# ------------------------------------------------------------------
#
#    Copyright (C) 2016 Mikhail Kurinnoi
#
#    This program is free software; you can redistribute it and/or
#    modify it under the terms of version 2 of the GNU General Public
#    License published by the Free Software Foundation.
#
# ------------------------------------------------------------------

#include <tunables/global>
profile chromium /usr/{bin,lib,lib64}/{chromium,chromium-browser}{,/chrome,/chromium-launcher.sh} flags=(attach_disconnected) {
  #include <abstractions/base>
  #include <abstractions/freedesktop.org>
  #include <abstractions/fonts>
  #include <abstractions/audio>
  #include <abstractions/cups-client>
  #include <abstractions/dbus-session>
  #include <abstractions/gtk>
  #include <abstractions/nameservice>
  #include <abstractions/user-tmp>
  #include <abstractions/nvidia>
  #include <abstractions/X>
  #include <abstractions/user-download>
  #include <abstractions/user-upload>
  #include <abstractions/xdg-open>
  #include <abstractions/dconf>

  capability sys_admin,
  capability sys_chroot,
  ptrace (trace) peer=@{profile_name},
  
  /dev/ r,
  /dev/tty rw,
  /dev/tty[0-9]* w,
  /dev/pts/[0-9]* rw,
  /dev/video[0-9]* r,
  /sys/devices/pci**/usb*/**/idVendor r,
  /sys/devices/pci**/usb*/**/idProduct r,

  @{PROC}/ r,
  @{PROC}/filesystems r,
  @{PROC}/sys/kernel/shmmax r,
  @{PROC}/@{pid}/sched r,
  @{PROC}/@{pid}/smaps r,
  @{PROC}/@{pid}/statm r,
  @{PROC}/@{pid}/stat r,
  @{PROC}/@{pid}/task/ r,
  @{PROC}/@{pid}/task/@{pid}/stat r,
  owner @{PROC}/@{pid}/io r,
  owner @{PROC}/@{pid}/oom_{,score_}adj w,
  owner /{dev,run}/shm/{,.}org.chromium.* mrw,
  # Networking
  @{PROC}/@{pid}/net/if_inet6 r,
  @{PROC}/@{pid}/net/ipv6_route r,
  @{PROC}/sys/net/ipv4/tcp_fastopen r,

  # Should maybe be in abstractions
  /etc/mime.types r,
  /etc/mtab r,

  # Needed for the crash reporter
  owner @{PROC}/@{pid}/auxv r,
  @{PROC}/@{pid}/setgroups rw,
  @{PROC}/@{pid}/uid_map rw,
  @{PROC}/@{pid}/gid_map rw,
  
  # Newer chromium needs these now
  /etc/udev/udev.conf r,
  /sys/bus/pci/** r,
  /sys/devices/system/cpu/ r,
  /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_max_freq r,
  /sys/devices/system/cpu/cpufreq/policy*/cpuinfo_max_freq r,
  /sys/devices/pci[0-9]*/**/class r,
  /sys/devices/pci[0-9]*/**/device r,
  /sys/devices/pci[0-9]*/**/irq r,
  /sys/devices/pci[0-9]*/**/resource r,
  /sys/devices/pci[0-9]*/**/vendor r,
  /sys/devices/pci[0-9]*/**/removable r,
  /sys/devices/pci[0-9]*/**/uevent r,
  /sys/devices/pci[0-9]*/**/block/**/size r,
  /sys/devices/virtual/block/**/removable r,
  /sys/devices/virtual/block/**/uevent r,
  /sys/devices/virtual/block/**/size r,


  /bin/bash r,
  /bin/ps Pxr,
  /usr/bin/xdg-settings Cxr -> xdgsettings,
  /usr/bin/lsb_release Cxr -> lsb_release,
  /bin/readlink ixr,

  # Allow transitions to ourself and our sandbox
  /usr/bin/chromium-browser Pxr,
  /usr/lib64/chromium-browser/chrome ix,
  /usr/lib64/chromium-browser/chromium-launcher.sh Px,
  /usr/lib64/chromium-browser/chrome-sandbox cx -> sandbox,
  # Helpers
  /usr/bin/gvfs-open ixr,
  

  # chromium mmaps all kinds of things for speed.
  /etc/passwd m,
  /usr/share/fonts/truetype/**/*.tt[cf] m,
  /usr/share/fonts/**/*.pfb m,
  /usr/share/mime/mime.cache m,
  /usr/share/icons/**/*.cache m,
  /usr/lib64/chromium-browser/*.pak mr,
  /usr/lib64/chromium-browser/locales/* mr,
  owner /{dev,run}/shm/pulse-shm* m,
  owner @{HOME}/.local/share/mime/mime.cache m,
  owner /tmp/** m,


#  # Importing firefox settings
#  @{PROC}/@{pid}/oom_{,score_}adj w,
#  /etc/firefox/profile/bookmarks.html r,
#  owner @{HOME}/.mozilla/** k,
#  # For migration
#  owner @{HOME}/.mozilla/firefox/profiles.ini r,
#  owner @{HOME}/.mozilla/firefox/*/prefs.js r,
  deny owner @{HOME}/.mozilla/firefox/profiles.ini r,
  deny owner @{HOME}/.mozilla/firefox/*/prefs.js r,

  # Chromium configuration
  /etc/chromium/ r,
  /etc/chromium/** r,
  owner @{HOME}/.pki/nssdb/* rwk,
  owner @{HOME_CACHE}/chromium/ rw,
  owner @{HOME_CACHE}/chromium/** rw,
  owner @{HOME_CACHE}/chromium/Cache/* mr,
  owner @{HOME}/.config/chromium/ rw,
  owner @{HOME}/.config/chromium/** rwk,
  owner @{HOME}/.config/chromium/**/Cache/* mr,
  owner @{HOME}/.config/chromium/Dictionaries/*.bdic mr,
  owner @{HOME}/.config/chromium/**/Dictionaries/*.bdic mr,

  # Noisy
  deny /dev/bus/usb/ r,
  deny /run/udev/data/** r,
  deny /usr/lib64/chromium-browser/** w,
  deny @{HOMEDIRS}/* w,
  deny @{HOMEDIRS}/*/ w,
  deny owner @{HOME}/* r,
  

  profile xdgsettings {
    #include <abstractions/base>
    #include <abstractions/freedesktop.org>
    #include <abstractions/fonts>
    #include <abstractions/bash>
    #include <abstractions/gtk>

    /usr/bin/xdg-settings r,

    # Checking default browser
    /bin/grep ixr,
    /bin/readlink ixr,
    /bin/sed ixr,
    /bin/which ixr,
    /usr/bin/basename ixr,
    /usr/bin/cut ixr,
    deny /bin/bash xr,

    # Setting the default browser
    /bin/mkdir ixr,
    /bin/mv ixr,
    /bin/touch ixr,
    /usr/bin/dirname ixr,
    /usr/bin/gconftool-2 ix,
    /usr/bin/[gm]awk ixr,
    /usr/bin/xdg-mime ixr,
    
    owner @{HOME}/.local/share/applications/ w,
    owner @{HOME}/.local/share/applications/mimeapps.list* rw,
  }

  profile lsb_release {
    #include <abstractions/base>
    #include <abstractions/python>
    
    /dev/tty rw,
    
    /usr/bin/getopt ixr,
    /bin/sed ixr,
    /bin/head ixr,
    /usr/bin/lsb_release r,
    /bin/bash ixr,
    /usr/bin/dpkg-query ixr,
    /etc/lsb-release r,
    /var/lib/dpkg/** r,
    deny /usr/bin/find xr,

    /usr/bin/ r,
  }


  profile sandbox {
    # Be fanatical since it is setuid root and don't use an abstraction
    /lib/libgcc_s.so* mr,
    /lib{,32,64}/libm-*.so* mr,
    /lib{,32,64}/libpthread-*.so* mr,
    /lib{,32,64}/libc-*.so* mr,
    /lib{,32,64}/libld-*.so* mr,
    /lib{,32,64}/ld-*.so* mr,
    /etc/ld.so.cache r,

    # Required for dropping into PID namespace. Keep in mind that until the
    # process drops this capability it can escape confinement, but once it
    # drops CAP_SYS_ADMIN we are ok.
    capability sys_admin,

    # All of these are for sanely dropping from root and chrooting
    capability chown,
    capability fsetid,
    capability setgid,
    capability setuid,
    capability dac_override,
    capability sys_chroot,

    capability sys_ptrace,
    ptrace (read, readby),

    @{PROC}/ r,
    @{PROC}/@{pid}/ r,
    @{PROC}/@{pid}/fd/ r,
    owner @{PROC}/@{pid}/oom_adj w,
    owner @{PROC}/@{pid}/oom_score_adj w,
    @{PROC}/@{pid}/status r,
    @{PROC}/@{pid}/task/@{pid}/stat r,

    /usr/bin/chromium-browser r,
    /usrbin/chromium r,
    /usr/lib64/chromium-browser/chrome Px,
    /usr/lib64/chromium-browser/chrome-sandbox r,

    /dev/null rw,

    owner /tmp/** rw,
  }
}
