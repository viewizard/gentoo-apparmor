# ------------------------------------------------------------------
#
#  Copyright (C) 2016,2017 Mikhail Kurinnoi
#
#  This program is free software; you can redistribute it and/or
#  modify it under the terms of version 2 of the GNU General Public
#  License published by the Free Software Foundation.
#
# ------------------------------------------------------------------

#include <tunables/global>

# предустановка для abstractions/fs/access-by-user-preset-{rk,rwk,rwkl}
@{USERS_DIR}="[^.]**"
@{USERS_FILE}="[^.]*.{png,PNG}"  # xfce4-screenshooter

profile xfce4-panel /usr/bin/xfce4-panel {
  #include <abstractions/base>
  #include <abstractions/freedesktop.org>
  #include <abstractions/fonts>
  #include <abstractions/gtk>
  #include <abstractions/video>
  #include <abstractions/X>
  #include <abstractions/dbus/session-strict>
  #include <abstractions/dbus/accessibility-strict>
  #include <abstractions/dbus/at-spi>
  #include <abstractions/dbus/xfconf>
  #include <abstractions/dbus/gvfs>
  #include <abstractions/dbus/session-bind>
  #include <abstractions/nameservice>
  #include <abstractions/binary-helper>
  #include <local/xfce4-panel-custom>
  
  # DBUS -----------------------------------------------
  dbus send
  	bus=session
  	path="/org/xfce/Panel/Wrapper/[0-9]*"
  	interface="org.xfce.Panel.Wrapper"
  	peer=(name="org.freedesktop.DBus",label="xfce4-panel*"),
  dbus receive
  	bus=session
  	path="/org/xfce/Panel/Wrapper/[0-9]*"
  	interface="org.xfce.Panel.Wrapper"
  	peer=(name=":[0-9]*.[0-9]*",label="xfce4-panel*"),
  dbus (send, receive)
  	bus=session
  	path="/org/xfce/Panel"
  	interface="org.xfce.Panel"
  	peer=(name=":[0-9]*.[0-9]*",label=@{profile_name}),
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  @{PROC}/@{pid}/fd/					r,
  
  # EXECUTABLES ----------------------------------------
  /usr/bin/xfce4-panel					Pxmr,	# Все парвильно, запуск и mmap.
  /usr/lib{,32,64}/xfce4/panel/wrapper-[1-2].0		Px,
  /usr/lib{,32,64}/xfce4/panel-plugins/xfce4-*-plugin	Px,
  /usr/bin/exo-desktop-item-edit			Px,
  /usr/bin/xfce4-session-logout				Px,
  /usr/bin/xfce4-session-settings			Px,
  /usr/bin/passwd.sh					Px,
  
  # READS/WRITES ---------------------------------------
  /etc/xdg/menus/**.menu				r,
  /etc/xdg/menus/applications-merged/			r,
  /usr/share/xfce4/panel/plugins/{,*.desktop}		r,
  /usr/share/xfce4/panel-plugins/{,*.desktop}		r,
  /usr/share/desktop-directories/*.directory		r,
  /opt/**.png						r,
  
  # USERS ----------------------------------------------
  owner @{HOME}/.config/xfce4/help.rc*			rw,
  owner @{HOME}/.config/xfce4/panel/{,*.rc*}		rw,
  owner @{HOME}/.config/xfce4/panel/launcher-**.desktop	r,
  owner @{HOME}/.config/menus/**.menu			rw,
  owner @{HOME}/.config/menus/applications-merged/	r,
  owner @{HOME}/.config/xfce4/panel/launcher-*/{,**}	rw,
  owner @{HOME}/.local/share/desktop-directories/*.directory r,
  owner @{HOME}/.local/share/gvfs-metadata/{,*}		r,
  owner @{HOME}/.xfce4-session.verbose-log		w,
}

profile xfce4-panel.wrapper-1.0 /usr/lib{,32,64}/xfce4/panel/wrapper-1.0 {
  #include <abstractions/base>
  #include <abstractions/freedesktop.org>
  #include <abstractions/fonts>
  #include <abstractions/X>
  #include <abstractions/dbus/system-strict>
  #include <abstractions/dbus/session-strict>
  #include <abstractions/dbus/accessibility-strict>
  #include <abstractions/dbus/at-spi>
  #include <abstractions/dbus/xfconf>
  #include <abstractions/dbus/gvfs>
  #include <abstractions/dbus/upower>
  #include <abstractions/gtk>
  #include <abstractions/audio>
  #include <abstractions/nameservice>
  #include <abstractions/binary-helper>
  #include <abstractions/fs/access-by-users-preset-rwk>		# xfce4-screenshooter
  #include <abstractions/fs/deny-by-pattern-internet>		# xfce4-screenshooter
  #include <abstractions/fs/deny-private-strict>		# xfce4-screenshooter
  #include <local/xfce4-panel-custom>
  
  # DBUS -----------------------------------------------
  dbus (send, receive)
  	bus=session
  	path="/org/xfce/Panel/Wrapper/[0-9]*"
  	interface="org.xfce.Panel.Wrapper"
  	peer=(name=":[0-9]*.[0-9]*",label="xfce4-panel*"),
  dbus send
  	bus=session
  	path="/org/xfce/FileManager"
  	interface="org.xfce.Trash"
  	peer=(name="org.xfce.FileManager",label="thunar"),
  dbus receive
  	bus=session
  	path="/org/xfce/FileManager"
  	interface="org.xfce.Trash"
  	peer=(name=":[0-9]*.[0-9]*",label="thunar"),
  dbus send
  	bus=session
  	path="/org/xfce/SessionManager"
  	interface="org.xfce.Session.Manager"
  	peer=(name="org.xfce.SessionManager",label="xfce4-session"),
  
  # NETWORK --------------------------------------------
  network netlink raw,
  network inet dgram,
  network inet6 dgram,
  network inet stream,
  network inet6 stream,
  
  # PSEUDO ---------------------------------------------
  /dev/tty						rw,
  /dev/tty[0-9]*					rw,
  /sys/devices/system/cpu/cpufreq/policy[0-9]*/scaling_* r,
  @{PROC}/uptime					r,
  @{PROC}/@{pid}/fd/					r,
  
  # EXECUTABLES ----------------------------------------
  /usr/lib{,32,64}/xfce4/panel/wrapper-1.0		m,
  /bin/env						Cx,
  /usr/bin/xflock4					Px,
  /usr/bin/alock					Px,
  /usr/bin/passwd.sh					Px,
  /usr/bin/xfce4-notes-settings				Px,
  
  # READS/WRITES ---------------------------------------
  /etc/xdg/menus/**.menu				r,
  /etc/xdg/menus/applications-merged/			r,
  /usr/share/alacarte/*					r,
  /usr/share/desktop-directories/{,*.directory}		r,
  /usr/share/xfce4/weather/icons/{,**.info,**.png}	r,
  /usr/share/xfce4-notes-plugin/{,**}			r,
  
  # USERS ----------------------------------------------
  owner @{HOME}/.face					r,
  owner @{HOME}/@{XDG_DESKTOP_DIR}/*.desktop		rw,
  owner @{HOME}/.config/menus/**.menu			rw,
  owner @{HOME}/.config/menus/applications-merged/	r,
  owner @{HOME}/.config/xfce4/panel/{,**}		rw,
  owner @{HOME}/.config/xfce4/xfce4-notes.gtkrc*	rw,
  owner @{HOME}/.config/xfce4/help.rc			r,
  owner @{HOME_CACHE}/xfce4/				rw,
  owner @{HOME_CACHE}/xfce4/clipman/{,*}		rw,
  owner @{HOME_CACHE}/xfce4/weather/{,*}		rw,
  owner @{HOME}/.local/share/applications/**.desktop	rw,
  owner @{HOME}/.local/share/desktop-directories/{,*.directory} r,
  owner @{HOME}/.local/share/notes/{,**}		rw,
  
  # TEMP -----------------------------------------------
  owner /tmp/*_????-??-??_??-??-??.png			rw,	# xfce4-screenshooter
  owner /tmp/gdkpixbuf-xpm-tmp.*			rw,	# xfce4-whiskermenu-plugin
  
  profile env /bin/env {
    #include <abstractions/base>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/env						mr,
    /usr/bin/wine					Px,
  }
}

profile xfce4-panel.wrapper-2.0 /usr/lib{,32,64}/xfce4/panel/wrapper-2.0 {
  #include <abstractions/base>
  #include <abstractions/freedesktop.org>
  #include <abstractions/fonts>
  #include <abstractions/X>
  #include <abstractions/gtk>
  #include <abstractions/audio>
  #include <abstractions/dbus/system-strict>
  #include <abstractions/dbus/session-strict>
  #include <abstractions/dbus/accessibility-strict>
  #include <abstractions/dbus/at-spi>
  #include <abstractions/dbus/xfconf>
  #include <abstractions/dbus/gvfs>
  #include <abstractions/dbus/notifications>
  #include <abstractions/binary-helper>
  
  # DBUS -----------------------------------------------
  dbus (send, receive)
  	bus=session
  	path="/org/xfce/Panel/Wrapper/[0-9]*"
  	interface="org.xfce.Panel.Wrapper"
  	peer=(name=":[0-9]*.[0-9]*",label="xfce4-panel*"),
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  
  # EXECUTABLES ----------------------------------------
  /usr/lib{,32,64}/xfce4/panel/wrapper-2.0		m,
  /usr/sbin/xfpm-power-backlight-helper			Px,
}

profile xfce4-panel.xfce4-xkb-plugin /usr/lib{,32,64}/xfce4/panel-plugins/xfce4-xkb-plugin {
  #include <abstractions/base>
  #include <abstractions/freedesktop.org>
  #include <abstractions/fonts>
  #include <abstractions/X>
  #include <abstractions/gtk>
  #include <abstractions/dbus/session-strict>
  #include <abstractions/dbus/accessibility-strict>
  #include <abstractions/dbus/at-spi>
  #include <abstractions/dbus/gvfs>
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  @{PROC}/@{pid}/fd/					r,
  
  # EXECUTABLES ----------------------------------------
  /usr/lib{,32,64}/xfce4/panel-plugins/xfce4-xkb-plugin	m,
  /usr/bin/xfce4-keyboard-settings			Px,
  
  # READS/WRITES ---------------------------------------
  /usr/share/xfce4/xkb/flags/*.svg			r,
  
  # USERS ----------------------------------------------
  owner @{HOME}/.config/xfce4/panel/{,*.rc*}		rw,
}

profile xfce4-panel.xfce4-kbdleds-plugin /usr/lib{,32,64}/xfce4/panel-plugins/xfce4-kbdleds-plugin {
  #include <abstractions/base>
  #include <abstractions/freedesktop.org>
  #include <abstractions/fonts>
  #include <abstractions/X>
  #include <abstractions/gtk>
  #include <abstractions/dbus/session-strict>
  #include <abstractions/dbus/accessibility-strict>
  #include <abstractions/dbus/at-spi>
  #include <abstractions/dbus/gvfs>
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  
  # EXECUTABLES ----------------------------------------
  /usr/lib{,32,64}/xfce4/panel-plugins/xfce4-kbdleds-plugin m,
  
  # USERS ----------------------------------------------
  owner @{HOME}/.config/xfce4/panel/{,*.rc*}		rw,
}

profile xfce4-panel.xfce4-sensors-plugin /usr/lib{,32,64}/xfce4/panel-plugins/xfce4-sensors-plugin {
  #include <abstractions/base>
  #include <abstractions/freedesktop.org>
  #include <abstractions/fonts>
  #include <abstractions/X>
  #include <abstractions/gtk>
  #include <abstractions/sensors>
  #include <abstractions/dbus/session-strict>
  #include <abstractions/dbus/accessibility-strict>
  #include <abstractions/dbus/at-spi>
  #include <abstractions/dbus/gvfs>
  
  # PSEUDO ---------------------------------------------
  /dev/tty						rw,
  /dev/tty[0-9]*					rw,
  @{PROC}/@{pid}/fd/					r,
  
  # EXECUTABLES ----------------------------------------
  /usr/lib{,32,64}/xfce4/panel-plugins/xfce4-sensors-plugin m,
  /usr/bin/xfce4-sensors				Px,
  
  # USERS ----------------------------------------------
  owner @{HOME}/.config/xfce4/panel/{,*.rc*}		rw,
}
