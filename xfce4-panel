# ------------------------------------------------------------------
#
#  Copyright (C) 2016-2018 Mikhail Kurinnoi
#
#  This program is free software; you can redistribute it and/or
#  modify it under the terms of version 2 of the GNU General Public
#  License published by the Free Software Foundation.
#
# ------------------------------------------------------------------

#include <local/tunables.d/>

# .png
@{local_ext}=[pP][nN][gG]

# предустановка для abstractions/fs/access-by-user-preset-rwk
@{USERS_DIR_rwk}="[^.]**"
@{USERS_FILE_rwk}="[^.]*.@{local_ext}"  # xfce-extra/xfce4-screenshooter

profile xfce4-panel /usr/bin/xfce4-panel {
  #include <abstractions/base>
  #include <abstractions/freedesktop.org>
  #include <abstractions/fonts>
  #include <abstractions/gtk>
  #include <abstractions/video>
  #include <abstractions/X>
  #include <abstractions/nameservice>
  #include <abstractions/dbus/session-strict>
  #include <abstractions/dbus/accessibility-strict>
  #include <abstractions/dbus/at-spi>
  #include <abstractions/dbus/xfconf>
  #include <abstractions/dbus/gvfs>
  #include <abstractions/dbus/session-bind>
  #include <abstractions/profile_transitions/users-all>
  #include <local/profile_blocks/xfce4-panel.d/>
  
  # DBUS -----------------------------------------------
  dbus send
  	bus=session
  	path="/org/xfce/Panel/Wrapper/[0-9]*"
  	interface="org.xfce.Panel.Wrapper"
  	peer=(name="org.freedesktop.DBus",label="xfce4-panel*"),
  dbus receive
  	bus=session
  	path="/org/xfce/Panel/Wrapper/[0-9]*"
  	interface="org.xfce.Panel.Wrapper"
  	peer=(name=":[0-9]*.[0-9]*",label="xfce4-panel*"),
  dbus (send, receive)
  	bus=session
  	path="/org/xfce/Panel"
  	interface="org.xfce.Panel"
  	peer=(name=":[0-9]*.[0-9]*",label=@{profile_name}),
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  @{PROC_D}/@{pid}/fd/					r,	# IMPROVE! fsuid=$USER ouid=$USER,root
  
  # EXECUTABLES ----------------------------------------
  /usr/bin/xfce4-panel					Pxmr,	# Все парвильно, запуск и mmap.
  /usr/lib{,32,64}/xfce4/panel/wrapper-[1-2].0		Px,
  /usr/lib{,32,64}/xfce4/panel-plugins/xfce4-*-plugin	Px,
  /usr/lib{,32,64}/xfce4/exo-1/exo-helper-1		Px,	# xfce-base/exo
  /usr/bin/exo-desktop-item-edit			Px,	# xfce-base/exo
  /usr/bin/xfce4-session-logout				Px,	# xfce-base/xfce4-session
  /usr/bin/xfce4-session-settings			Px,	# xfce-base/xfce4-session
  /usr/bin/passwd.sh					Px,	# sys-apps/shadow
  
  # READS/WRITES ---------------------------------------
  /etc/xdg/menus/**.menu				r,
  /etc/xdg/menus/applications-merged/			r,
  /etc/xdg/xfce4/helpers.rc				r,
  /usr/share/xfce4/helpers/*.desktop			r,
  /usr/share/xfce4/panel/plugins/{,*.desktop}		r,
  /usr/share/xfce4/panel-plugins/{,*.desktop}		r,
  /usr/share/desktop-directories/*.directory		r,
  /opt/**.png						r,
  
  # USERS ----------------------------------------------
  owner @{HOME}/.config/xfce4/help.rc*			rw,
  owner @{HOME}/.config/xfce4/panel/{,*.rc*}		rw,
  owner @{HOME}/.config/xfce4/panel/launcher-**.desktop	r,
  owner @{HOME}/.config/menus/**.menu			rw,
  owner @{HOME}/.config/menus/applications-merged/	r,
  owner @{HOME}/.config/xfce4/panel/launcher-*/{,**}	rw,
  owner @{HOME}/.config/xfce4/helpers.rc		r,
  owner @{HOME}/.local/share/desktop-directories/*.directory r,
  owner @{HOME}/.local/share/gvfs-metadata/{,*}		r,	# gnome-base/gvfs
  owner @{HOME}/.xfce4-session.verbose-log		w,
}

profile xfce4-panel.wrapper-1.0 /usr/lib{,32,64}/xfce4/panel/wrapper-1.0 {
  #include <abstractions/base>
  #include <abstractions/freedesktop.org>
  #include <abstractions/fonts>
  #include <abstractions/X>
  #include <abstractions/dbus/system-strict>
  #include <abstractions/dbus/session-strict>
  #include <abstractions/dbus/accessibility-strict>
  #include <abstractions/dbus/at-spi>
  #include <abstractions/dbus/xfconf>
  #include <abstractions/dbus/gvfs>
  #include <abstractions/dbus/upower>
  #include <abstractions/gtk>
  #include <abstractions/audio>
  #include <abstractions/nameservice>
  #include <abstractions/fs/access-by-users-preset-rwk>		# xfce-extra/xfce4-screenshooter
  #include <abstractions/fs/deny-by-pattern-internet>		# xfce-extra/xfce4-screenshooter
  #include <abstractions/fs/deny-private-strict>		# xfce-extra/xfce4-screenshooter
  #include <abstractions/profile_transitions/users-all>
  #include <local/profile_blocks/xfce4-panel.d/>
  
  # DBUS -----------------------------------------------
  dbus (send, receive)
  	bus=session
  	path="/org/xfce/Panel/Wrapper/[0-9]*"
  	interface="org.xfce.Panel.Wrapper"
  	peer=(name=":[0-9]*.[0-9]*",label="xfce4-panel*"),
  dbus send
  	bus=session
  	path="/org/xfce/FileManager"
  	interface="org.xfce.Trash"
  	peer=(name="org.xfce.FileManager",label="thunar"),	# xfce-base/thunar
  dbus receive
  	bus=session
  	path="/org/xfce/FileManager"
  	interface="org.xfce.Trash"
  	peer=(name=":[0-9]*.[0-9]*",label="thunar"),		# xfce-base/thunar
  dbus send
  	bus=session
  	path="/org/xfce/SessionManager"
  	interface="org.xfce.Session.Manager"
  	peer=(name="org.xfce.SessionManager",label="xfce4-session"),	# # xfce-base/xfce4-session
  
  # NETWORK --------------------------------------------
  network netlink raw,
  network inet dgram,
  network inet6 dgram,
  network inet stream,
  network inet6 stream,
  
  # PSEUDO ---------------------------------------------
  /dev/tty						rw,
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  @{sys}/devices/system/cpu/cpufreq/policy[0-9]*/scaling_* r,
  @{PROC_D}/uptime					r,
  @{PROC_D}/@{pid}/fd/					r,	# IMPROVE! fsuid=$USER ouid=$USER,root
  
  # EXECUTABLES ----------------------------------------
  /usr/lib{,32,64}/xfce4/panel/wrapper-1.0		m,
  /usr/bin/xflock4					Px,	# xfce-base/xfce4-session
  /usr/bin/alock					Px,	# x11-misc/alock
  /usr/bin/passwd.sh					Px,	# sys-apps/shadow
  /usr/bin/xfce4-notes-settings				Px,	# xfce-extra/xfce4-notes-plugin
  
  # READS/WRITES ---------------------------------------
  /etc/xdg/menus/**.menu				r,
  /etc/xdg/menus/applications-merged/			r,
  /usr/share/alacarte/*					r,	# x11-misc/alacarte
  /usr/share/desktop-directories/{,*.directory}		r,
  /usr/share/xfce4/weather/icons/{,**.info,**.png}	r,	# xfce-extra/xfce4-weather-plugin
  /usr/share/xfce4-notes-plugin/{,**}			r,	# xfce-extra/xfce4-notes-plugin
  
  # USERS ----------------------------------------------
  owner @{HOME}/.face					r,
  owner @{HOME}/@{XDG_DESKTOP_DIR}/*.desktop		rw,
  owner @{HOME}/.config/menus/**.menu			rw,
  owner @{HOME}/.config/menus/applications-merged/	r,
  owner @{HOME}/.config/xfce4/panel/{,**}		rw,
  owner @{HOME}/.config/xfce4/xfce4-notes.gtkrc*	rw,	# xfce-extra/xfce4-notes-plugin
  owner @{HOME}/.config/xfce4/help.rc			r,
  owner @{HOME_CACHE}/xfce4/				rw,
  owner @{HOME_CACHE}/xfce4/weather/{,*}		rw,	# xfce-extra/xfce4-weather-plugin
  owner @{HOME}/.local/share/applications/**.desktop	rw,
  owner @{HOME}/.local/share/desktop-directories/{,*.directory} r,
  owner @{HOME}/.local/share/notes/{,**}		rw,
  
  # TEMP -----------------------------------------------
  owner /tmp/@{TMP_XFCE4_SCR}				rw,	# xfce-extra/xfce4-screenshooter
  audit owner /tmp/gdkpixbuf-xpm-tmp.*			rw,	# xfce-extra/xfce4-whiskermenu-plugin	# FIX ME! audit 25.11.2017	# IMPROVE! Потом работать с xattr, чтобы ограничить только на процесс.
}

profile xfce4-panel.wrapper-2.0 /usr/lib{,32,64}/xfce4/panel/wrapper-2.0 {
  #include <abstractions/base>
  #include <abstractions/freedesktop.org>
  #include <abstractions/fonts>
  #include <abstractions/X>
  #include <abstractions/gtk>
  #include <abstractions/audio>
  #include <abstractions/dbus/system-strict>
  #include <abstractions/dbus/session-strict>
  #include <abstractions/dbus/accessibility-strict>
  #include <abstractions/dbus/session-bind>
  #include <abstractions/dbus/at-spi>
  #include <abstractions/dbus/xfconf>
  #include <abstractions/dbus/gvfs>
  #include <abstractions/dbus/upower>
  #include <abstractions/dbus/notifications>
  #include <abstractions/dbus/mpris2-client>			# xfce-extra/xfce4-pulseaudio-plugin
  #include <abstractions/profile_transitions/users-all>
  #include <local/profile_blocks/xfce4-panel.d/>
  
  # DBUS -----------------------------------------------
  dbus (send, receive)
  	bus=session
  	path="/org/xfce/Panel/Wrapper/[0-9]*"
  	interface="org.xfce.Panel.Wrapper"
  	peer=(name=":[0-9]*.[0-9]*",label="xfce4-panel*"),
  dbus send
  	bus=session
  	path="/org/freedesktop/PowerManagement/Inhibit"
  	interface="org.freedesktop.DBus.Properties"
	member=GetAll
  	peer=(name=":[0-9]*.[0-9]*",label="xfce4-power-manager"),	# xfce-extra/xfce4-power-manager
  dbus send
  	bus=session
  	path="/org/freedesktop/PowerManagement/Inhibit"
  	interface="org.freedesktop.PowerManagement.Inhibit"
  	peer=(name=":[0-9]*.[0-9]*",label="xfce4-power-manager"),	# xfce-extra/xfce4-power-manager
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  @{PROC_D}/uptime					r,	# xfce-extra/xfce4-systemload-plugin
  @{PROC_D}/@{pid}/fd/					r,	# IMPROVE! fsuid=$USER ouid=$USER,root
  
  # EXECUTABLES ----------------------------------------
  /usr/lib{,32,64}/xfce4/panel/wrapper-2.0		m,
  /usr/sbin/xfpm-power-backlight-helper			Px,	# xfce-extra/xfce4-power-manager
  
  # READS/WRITES ---------------------------------------
  /etc/xdg/xfce4/panel/{,**}				r,
  /usr/share/xfce4/xkb/flags/*.svg			r,	# xfce-extra/xfce4-xkb-plugin
  
  # USERS ----------------------------------------------
  owner @{HOME}/.config/xfce4/help.rc			r,
  owner @{HOME}/.config/xfce4/panel/{,**}		rw,
  owner @{HOME_CACHE}/xfce4/notifyd/{,**}		rw,	# xfce-extra/xfce4-notifyd
  owner @{HOME_CACHE}/xfce4/clipman/{,*}		rw,	# xfce-extra/xfce4-clipman-plugin
  owner @{HOME}/.local/share/gvfs-metadata/root{,-@{TMP8}.log} r,	# xfce-extra/xfce4-notifyd, gnome-base/gvfs
}
