# ------------------------------------------------------------------
#
#    Copyright (C) 2016 Mikhail Kurinnoi
#
#    This program is free software; you can redistribute it and/or
#    modify it under the terms of version 2 of the GNU General Public
#    License published by the Free Software Foundation.
#
# ------------------------------------------------------------------

#include <tunables/global>
profile openrc /sbin/openrc flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  
  capability sys_ptrace,
  capability sys_tty_config,
  
  /dev/ptmx rw,
  /dev/pts/[0-9]* rw,
  @{PROC}/ r,
  @{PROC}/cmdline r,
  @{PROC}/@{pid}/environ r,
  @{PROC}/@{pid}/stat r,
  
  /sbin/openrc r,
  # All scripts from "boot" and "default" runlevels must have profiles!
  /etc/init.d/* Px,
  
  /etc/rc.conf r,
  /etc/profile.env r,
  /etc/init.d/ r,
  /etc/conf.d/ r,
  /etc/runlevels/** r,
  
  /var/log/rc.log w,
  /run/**{,.}pid rw,
  /run/openrc/** rwk,
  
}


profile openrc.netmount.init.d /etc/init.d/netmount flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  @{PROC}/@{pid}/mounts r,
  
  /bin/mount Px,
  /bin/umount Px,
  
  /etc/fstab r,
  /etc/init.d/netmount r,
  /etc/conf.d/netmount r,
  
}


profile openrc.consolefont.init.d /etc/init.d/consolefont flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  /dev/tty[0-9]* rw,
  /dev/pts/[0-9]* r,
  
  /usr/bin/setfont ix,
  /bin/bash Cx -> shell,
  
  / r,
  /etc/init.d/consolefont r,
  /etc/conf.d/consolefont r,
  /usr/share/consolefonts/ r,
  /usr/share/consolefonts/** r,
  /lib64/rc/console/font rw,
  
  
  profile shell flags=(complain) {
    #include <abstractions/base>
    
    capability sys_tty_config,
    
    /dev/tty rw,
    /dev/console rw,
    
    /bin/bash r,
    /bin/gzip ix,
    
    /usr/share/consolefonts/ r,
    /usr/share/consolefonts/** r,
    
  }
  
}


profile openrc.local.init.d /etc/init.d/local flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  #include <local/openrc-local-scripts>
  
  /etc/init.d/local r,
  /etc/local.d/ r,
  /etc/local.d/* r,
  
}


profile openrc.hwclock.init.d /etc/init.d/hwclock flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  /dev/ r,
  @{PROC}/devices r,
  
  /bin/uname ix,
  /bin/grep ix,
  /sbin/hwclock Px,
  
  /etc/init.d/hwclock r,
  /etc/conf.d/hwclock r,
  
}


profile openrc.swap.init.d /etc/init.d/swap flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  /bin/umount Px,
  /sbin/swapon Px,
  /sbin/swapoff Px,
  
  /etc/init.d/swap r,
  
}


profile openrc.modules.init.d /etc/init.d/modules flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  /etc/init.d/root-ro Px,
  /bin/uname ix,
  
  /etc/init.d/modules r,
  /etc/conf.d/modules r,
  
}


profile openrc.fsck.init.d /etc/init.d/fsck flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  /etc/init.d/* Px,
  /bin/cat ix,
  /sbin/fsck Px,
  
  /etc/init.d/fsck r,
  /etc/conf.d/fsck r,
  
}


profile openrc.root.init.d /etc/init.d/root flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  @{PROC}/@{pid}/mounts r,
  
  /etc/init.d/mtab Px,
  /bin/rm ix,
  /bin/mount Px,
  
  /etc/fstab r,
  /etc/init.d/root r,
  
}


profile openrc.root-ro.init.d /etc/init.d/root-ro flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  /bin/cat ix,
  
  /etc/init.d/root-ro r,
  
}


profile openrc.mtab.init.d /etc/init.d/mtab flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  /bin/ln ix,
  
  /etc/mtab w,
  /etc/init.d/mtab r,
  /etc/conf.d/mtab r,
  
}


profile openrc.localmount.init.d /etc/init.d/localmount flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  @{PROC}/@{pid}/mounts r,
  
  /etc/init.d/* Px,
  /bin/mount Px,
  /bin/umount Px,
  
  /etc/fstab r,
  /etc/init.d/localmount r,
  /etc/conf.d/localmount r,
  
}


profile openrc.sysctl.init.d /etc/init.d/sysctl flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  /sbin/sysctl Px,
  
  /etc/init.d/sysctl r,
  
}


profile openrc.bootmisc.init.d /etc/init.d/bootmisc flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  #include <abstractions/user-tmp>
  
  capability fsetid,
  capability syslog,
  capability chown,
  
  /dev/kmsg r,
  @{PROC}/@{pid}/mounts r,
  
  /bin/rm ix,
  /bin/readlink ix,
  /bin/mktemp ix,
  /bin/rmdir ix,
  /bin/chgrp ix,
  /bin/chmod ix,
  /bin/dmesg ix,
  /bin/mount Px,
  /bin/umount Px,
  
  /etc/fstab r,
  /etc/init.d/bootmisc r,
  /etc/conf.d/bootmisc r,
  /lib64/rc/console/font w,
  /lib64/rc/console/keymap w,
  /lib64/rc/console/unicode w,
  
  /var/log/dmesg w,
  /run/utmp w,
}


profile openrc.hostname.init.d /etc/init.d/hostname flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  capability sys_admin,
  
  /etc/init.d/syslog-ng Px,
  /bin/hostname ix,
  
  /etc/init.d/hostname r,
  /etc/conf.d/hostname r,
  
}


profile openrc.tmpfiles.init.d /etc/init.d/tmpfiles.setup flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  capability chown,
  
  /lib64/rc/sh/tmpfiles.sh ix,
  /bin/sort ix,
  /usr/bin/find ix,
  
  /etc/init.d/tmpfiles.setup r,
  /etc/conf.d/tmpfiles r,
  
  / r,
  /run/**/ rw,
  /run/tmpfiles.d/kmod.conf r,
  
}


profile openrc.termencoding.init.d /etc/init.d/termencoding flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  /dev/tty[0-9]* w,
  
  /etc/init.d/keymaps Px,
  /etc/init.d/consolefont Px,
  
  /etc/init.d/termencoding r,
  
  /lib64/rc/console/unicode w,
  
}


profile openrc.swapfiles.init.d /etc/init.d/swapfiles flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  @{PROC}/swaps r,
  
  /sbin/swapon Px,
  /sbin/swapoff Px,
  
  /etc/init.d/swapfiles r,
  
}


profile openrc.keymaps.init.d /etc/init.d/keymaps flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  /dev/tty[0-9]* rw,
  /dev/pts/[0-9]* r,
  
  /bin/bash Cxr -> shell,
  /usr/bin/kbd_mode ix,
  /usr/bin/loadkeys ix,
  /usr/bin/dumpkeys ix,
  
  / r,
  /etc/init.d/keymaps r,
  /etc/conf.d/keymaps r,
  /usr/share/keymaps/ r,
  /usr/share/keymaps/** r,
  
  /lib64/rc/console/keymap w,
  
  
  profile shell flags=(complain) {
    #include <abstractions/base>
    
    /dev/tty rw,
    
    /bin/bash r,
    /bin/gzip ix,
    
    /usr/share/keymaps/ r,
    /usr/share/keymaps/** r,
    
  }
  
}


profile openrc.urandom.init.d /etc/init.d/urandom flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  /dev/urandom w,
  @{PROC}/sys/kernel/random/poolsize r,
  
  /bin/cat ix,
  /bin/dd ix,
  /bin/rm ix,
  
  /etc/init.d/urandom r,
  /etc/conf.d/urandom r,
  
  /var/lib/misc/random-seed rw,
  
}


profile openrc.loopback.init.d /etc/init.d/loopback flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  capability net_admin,
  
  /bin/ip ix,
  
  /etc/init.d/loopback r,
  /etc/iproute2/rt_scopes r,
  
}


profile openrc.procfs.init.d /etc/init.d/procfs flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  /etc/init.d/procfs r,
  
}
