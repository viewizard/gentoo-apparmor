# ------------------------------------------------------------------
#
#    Copyright (C) 2016 Mikhail Kurinnoi
#
#    This program is free software; you can redistribute it and/or
#    modify it under the terms of version 2 of the GNU General Public
#    License published by the Free Software Foundation.
#
# ------------------------------------------------------------------

#include <tunables/global>
profile openrc /sbin/openrc flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  
  capability sys_ptrace,
  capability sys_tty_config,
  capability dac_override,
  capability kill,
  
  /dev/ptmx rw,
  /dev/pts/[0-9]* rw,
  @{PROC}/ r,
  @{PROC}/cmdline r,
  @{PROC}/@{pid}/cmdline r,
  @{PROC}/@{pid}/environ r,
  @{PROC}/@{pid}/stat r,
  @{PROC}/@{pid}/mounts r,
  
  /sbin/openrc r,
  /bin/bash Cx -> shell,
  # All scripts from "boot" and "default" runlevels must have profiles!
  /etc/init.d/* Px,
  
  /etc/rc.conf r,
  /etc/profile.env r,
  /etc/fstab r,
  /etc/{conf,init}.d/ r,
  /etc/runlevels/{,**} r,
  /etc/runlevels/*/ w,
  /etc/terminfo/l/linux r,
  /etc/terminfo/x/xterm r,
  
  /var/log/rc.log w,
  /run/**{,.}pid rw,
  /run/openrc/** rwk,
  
  
  profile shell flags=(complain) {
    #include <abstractions/base>
    
    capability sys_tty_config,
    capability dac_override,
    capability dac_read_search,
    
    /dev/tty rw,
    /dev/console rw,
    
    /bin/bash r,
    /lib64/rc/sh/gendepends.sh Px,
    
  }
  
}


profile openrc.gendepends.sh /lib64/rc/sh/gendepends.sh {
  #include <abstractions/base>
  
  capability sys_tty_config,
  capability dac_override,
  capability dac_read_search,
  
  /dev/tty rw,
  /dev/console rw,
  
  /bin/bash r,
  /lib64/rc/sh/gendepends.sh r,
  /bin/sed ixr,
  /bin/grep ixr,
  /sbin/openrc Px,
  /usr/bin/gawk ixr,
  
  /etc/rc.conf r,
  /etc/fstab r,
  /etc/exports r,
  /etc/ssh/sshd_config r,
  /etc/zfs/zfs-functions r,
  /etc/{conf,init}.d/{,*} r,
  /etc/exports.d/{,*} r,
  /usr/libexec/rc.apparmor.functions r,
  
}


profile openrc.netmount.init.d /etc/init.d/netmount {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  @{PROC}/@{pid}/mounts r,
  
  /bin/mount Px,
  /bin/umount Px,
  
  /etc/fstab r,
  /etc/{conf,init}.d/netmount r,
  
}


profile openrc.consolefont.init.d /etc/init.d/consolefont {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  /dev/tty[0-9]* rw,
  /dev/pts/[0-9]* r,
  
  /usr/bin/setfont ix,
  /bin/bash Cx -> shell,
  
  / r,
  /etc/{conf,init}.d/consolefont r,
  /usr/share/consolefonts/{,**} r,
  /lib64/rc/console/font rw,
  
  
  profile shell {
    #include <abstractions/base>
    
    capability sys_tty_config,
    
    /dev/tty rw,
    /dev/console rw,
    
    /bin/bash r,
    /bin/gzip ix,
    /lib64/rc/sh/gendepends.sh Px,
    /usr/share/consolefonts/{,**} r,
    
  }
  
}


profile openrc.local.init.d /etc/init.d/local {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  #include <local/openrc-local-scripts>
  
  /etc/init.d/local r,
  /etc/local.d/{,*} r,
  
}


profile openrc.hwclock.init.d /etc/init.d/hwclock {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  /dev/ r,
  @{PROC}/devices r,
  
  /bin/uname ix,
  /bin/grep ix,
  /sbin/hwclock Px,
  
  /etc/{conf,init}.d/hwclock r,
  
}


profile openrc.swap.init.d /etc/init.d/swap {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  /bin/bash Cx -> shell,
  /bin/umount Px,
  /sbin/swapon Px,
  /sbin/swapoff Px,
  
  /etc/init.d/swap r,
  
  
  profile shell {
    #include <abstractions/base>
    
    /dev/tty rw,
    
    /bin/bash r,
    /lib64/rc/sh/gendepends.sh Px,
    
  }
  
}


profile openrc.modules.init.d /etc/init.d/modules {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  /etc/init.d/root-ro Px,
  /bin/uname ix,
  
  /etc/{conf,init}.d/modules r,
  
}


profile openrc.fsck.init.d /etc/init.d/fsck {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  /etc/init.d/* Px,
  /bin/cat ix,
  /sbin/fsck Px,
  
  /etc/{conf,init}.d/fsck r,
  
}


profile openrc.root.init.d /etc/init.d/root {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  @{PROC}/@{pid}/mounts r,
  
  /etc/init.d/mtab Px,
  /bin/rm ix,
  /bin/mount Px,
  /bin/bash Cx -> shell,
  
  /etc/fstab r,
  /etc/init.d/root r,
  
  
  profile shell {
    #include <abstractions/base>
    
    /dev/tty rw,
    
    /bin/bash r,
    /lib64/rc/sh/gendepends.sh Px,
    
  }
  
}


profile openrc.root-ro.init.d /etc/init.d/root-ro flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  capability chown,
  capability fsetid,
  capability fowner,
  
  /bin/bash Cx -> shell,
  /bin/cat ix,
  /bin/mkdir ix,
  /bin/sed ix,
  /bin/rm ix,
  /bin/mount Px,
  /usr/bin/rsync ix,
  
  /etc/init.d/root-ro r,
  /{etc,media,mnt}/ r,
  /{etc,media,mnt}/** rw,
  /lib64/rc/{,**} r,
  /root/{,**} r,
  
  profile shell {
    #include <abstractions/base>
    
    /dev/tty rw,
    
    /bin/bash r,
    /lib64/rc/sh/gendepends.sh Px,
    
  }
  
}


profile openrc.mtab.init.d /etc/init.d/mtab {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  /bin/ln ix,
  /bin/bash Cx -> shell,
  
  /etc/mtab w,
  /etc/{conf,init}.d/mtab r,
  
  
  profile shell {
    #include <abstractions/base>
    
    /dev/tty rw,
    
    /bin/bash r,
    /lib64/rc/sh/gendepends.sh Px,
    
  }
  
}


profile openrc.localmount.init.d /etc/init.d/localmount {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  @{PROC}/@{pid}/mounts r,
  
  /bin/bash Cx -> shell,
  /etc/init.d/* Px,
  /bin/mount Px,
  /bin/umount Px,
  
  /etc/fstab r,
  /etc/{conf,init}.d/localmount r,
  
  
  profile shell {
    #include <abstractions/base>
    
    /dev/tty rw,
    
    /bin/bash r,
    /lib64/rc/sh/gendepends.sh Px,
    
  }
  
}


profile openrc.sysctl.init.d /etc/init.d/sysctl {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  /bin/bash Cx -> shell,
  /sbin/sysctl Px,
  
  /etc/init.d/sysctl r,
  
  
  profile shell {
    #include <abstractions/base>
    
    /dev/tty rw,
    
    /bin/bash r,
    /lib64/rc/sh/gendepends.sh Px,
    
  }
  
}


profile openrc.bootmisc.init.d /etc/init.d/bootmisc {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  #include <abstractions/user-tmp>
  
  capability fsetid,
  capability syslog,
  capability chown,
  
  /dev/kmsg r,
  @{PROC}/@{pid}/mounts r,
  
  /bin/bash Cx -> shell,
  /bin/rm ix,
  /bin/readlink ix,
  /bin/mktemp ix,
  /bin/rmdir ix,
  /bin/chgrp ix,
  /bin/chmod ix,
  /bin/dmesg ix,
  /bin/mount Px,
  /bin/umount Px,
  
  /etc/fstab r,
  /etc/{conf,init}.d/bootmisc r,
  /lib64/rc/console/{font,keymap,unicode} w,
  
  /var/log/dmesg w,
  /var/log/wtmp w,
  /run/utmp w,
  
  
  profile shell {
    #include <abstractions/base>
    
    /dev/tty rw,
    
    /bin/bash r,
    /lib64/rc/sh/gendepends.sh Px,
    
  }
  
}


profile openrc.hostname.init.d /etc/init.d/hostname {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  capability sys_admin,
  
  /bin/bash Cx -> shell,
  /etc/init.d/syslog-ng Px,
  /bin/hostname ix,
  
  /etc/{conf,init}.d/hostname r,
  
  
  profile shell {
    #include <abstractions/base>
    
    /dev/tty rw,
    
    /bin/bash r,
    /lib64/rc/sh/gendepends.sh Px,
    
  }
  
}


profile openrc.tmpfiles.init.d /etc/init.d/tmpfiles.setup {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  capability chown,
  
  /lib64/rc/sh/tmpfiles.sh ix,
  /bin/sort ix,
  /usr/bin/find ix,
  
  /etc/init.d/tmpfiles.setup r,
  /etc/conf.d/tmpfiles r,
  
  / r,
  /run/**/ rw,
  /run/tmpfiles.d/kmod.conf r,
  
}


profile openrc.termencoding.init.d /etc/init.d/termencoding {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  /dev/tty[0-9]* w,
  
  /bin/bash Cx -> shell,
  /etc/init.d/keymaps Px,
  /etc/init.d/consolefont Px,
  
  /etc/init.d/termencoding r,
  
  /lib64/rc/console/unicode w,
  
  
  profile shell {
    #include <abstractions/base>
    
    /dev/tty rw,
    
    /bin/bash r,
    /lib64/rc/sh/gendepends.sh Px,
    
  }
  
}


profile openrc.swapfiles.init.d /etc/init.d/swapfiles {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  @{PROC}/swaps r,
  
  /sbin/swapon Px,
  /sbin/swapoff Px,
  
  /etc/init.d/swapfiles r,
  
}


profile openrc.keymaps.init.d /etc/init.d/keymaps {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  /dev/tty[0-9]* rw,
  /dev/pts/[0-9]* r,
  
  /bin/bash Cxr -> shell,
  /usr/bin/kbd_mode ix,
  /usr/bin/loadkeys ix,
  /usr/bin/dumpkeys ix,
  
  / r,
  /etc/{conf,init}.d/keymaps r,
  /usr/share/keymaps/{,**} r,
  
  /lib64/rc/console/keymap w,
  
  
  profile shell {
    #include <abstractions/base>
    
    /dev/tty rw,
    
    /bin/bash r,
    /bin/gzip ix,
    /lib64/rc/sh/gendepends.sh Px,
    
    /usr/share/keymaps/{,**} r,
    
  }
  
}


profile openrc.urandom.init.d /etc/init.d/urandom {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  /dev/urandom w,
  @{PROC}/sys/kernel/random/poolsize r,
  
  /bin/cat ix,
  /bin/dd ix,
  /bin/rm ix,
  
  /etc/{conf,init}.d/urandom r,
  
  /var/lib/misc/random-seed rw,
  
}


profile openrc.loopback.init.d /etc/init.d/loopback {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  capability net_admin,
  
  /bin/bash Cx -> shell,
  /bin/ip ix,
  
  /etc/init.d/loopback r,
  /etc/iproute2/rt_scopes r,
  
  
  profile shell {
    #include <abstractions/base>
    
    /dev/tty rw,
    
    /bin/bash r,
    /lib64/rc/sh/gendepends.sh Px,
    
  }
  
}


profile openrc.procfs.init.d /etc/init.d/procfs {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  /etc/init.d/procfs r,
  
}
