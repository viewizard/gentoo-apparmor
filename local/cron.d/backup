# ------------------------------------------------------------------
#
#  Copyright (C) 2017 Mikhail Kurinnoi
#
#  This program is free software; you can redistribute it and/or
#  modify it under the terms of version 2 of the GNU General Public
#  License published by the Free Software Foundation.
#
# ------------------------------------------------------------------

# Важно! Не должен содержать <tunables/global>.
# Уже включен в тело /etc/apparmor.d/2_local профиля.

# Важно! Перезагрузка профиля выполняется командой:
# apparmor_parser -r /etc/apparmor.d/2_local

profile daily_backup.sh.cron.daily /etc/cron.daily/daily_backup.sh {
  #include <abstractions/base>
  
  # CAPABILITIES ---------------------------------------
  capability sys_admin,
  
  # PSEUDO ---------------------------------------------
  /dev/tty						rw,
  /dev/null						w,
  /dev/pts/[0-9]*					rw,
  
  # EXECUTABLES ----------------------------------------
  /etc/cron.daily/daily_backup.sh			r,
  @{shell}						mr,
  /bin/chmod						Cx,	# FS ACCESS! chmod
  /bin/date						Cx,	# FS ACCESS! date
  /bin/tar						Cx,	# FS ACCESS! tar
  /bin/rm						Cx,	# FS ACCESS! rm
  /bin/cat						Cx,	# FS ACCESS! cat
  /bin/mktemp						Cx,	# FS ACCESS! mktemp
  /bin/sort						Cx,	# FS ACCESS! sort
  /bin/grep						Cx,	# FS ACCESS! grep
  /bin/mount						Cx,	# FS ACCESS! mount
  /bin/umount						Cx,	# FS ACCESS! umount
  /bin/basename						Px,
  /sbin/cryptsetup					Px,
  /sbin/lvm						Px,
  /usr/bin/libnotify-notify-send-users			Px,
  /usr/bin/gawk						Cx,	# FS ACCESS! gawk
  /usr/bin/find						Cx,	# FS ACCESS! find
  /usr/bin/mail						Px,
  /usr/bin/logger					Px,
  
  # TEMP -----------------------------------------------
  /tmp/dailyhomebackup.cron.??????			rw,
  /tmp/dailyhomebackup.cron.??????/			r,
  
  profile chmod /bin/chmod {
    #include <abstractions/base>
    
    # EXECUTABLES --------------------------------------
    /bin/chmod						mr,
    
    # READS/WRITES -------------------------------------
    /mnt/backup/Gentoo_Backup/daily_gentoo_home_*.tar	w,
    
    # DENY INHERIT -------------------------------------
    deny /tmp/dailyhomebackup.cron.??????		w,
  }
  
  profile date /bin/date {
    #include <abstractions/base>
    
    # EXECUTABLES --------------------------------------
    /bin/date						mr,
    
    # DENY INHERIT -------------------------------------
    deny /tmp/dailyhomebackup.cron.??????		w,
  }
  
  profile tar /bin/tar {
    #include <abstractions/base>
    #include <abstractions/nameservice>
    
    # CAPABILITIES -------------------------------------
    capability dac_override,
    
    # PSEUDO -------------------------------------------
    @{PROC}/@{pid}/fd/					r,
    
    # EXECUTABLES --------------------------------------
    /bin/tar						mr,
    
    # READS/WRITES -------------------------------------
    /mnt/backup/Gentoo_Backup/daily_gentoo_home_*.tar	w,
    
    # TEMP ---------------------------------------------
    /tmp/dailyhomebackup.cron.??????/{,**}		r,	# Точка монтирования снапшота с /home.
    
    # DENY INHERIT -------------------------------------
    deny /tmp/dailyhomebackup.cron.??????		w,
  }
  
  profile rm /bin/rm {
    #include <abstractions/base>
    
    # EXECUTABLES --------------------------------------
    /bin/rm						mr,
    
    # READS/WRITES -------------------------------------
    /tmp/dailyhomebackup.cron.??????{,/}		rw,
  }
  
  profile cat /bin/cat {
    #include <abstractions/base>
    
    # EXECUTABLES --------------------------------------
    /bin/cat						mr,
    
    # READS/WRITES -------------------------------------
    /tmp/dailyhomebackup.cron.??????			r,
    
    # DENY INHERIT -------------------------------------
    deny /tmp/dailyhomebackup.cron.??????		w,
  }
  
  profile mktemp /bin/mktemp {
    #include <abstractions/base>
    
    # EXECUTABLES --------------------------------------
    /bin/mktemp						mr,
    
    # TEMP ---------------------------------------------
    /tmp/dailyhomebackup.cron.??????{,/}		rw,
  }
  
  profile sort /bin/sort {
    #include <abstractions/base>
    
    # EXECUTABLES --------------------------------------
    /bin/sort						mr,
    
    # DENY INHERIT -------------------------------------
    deny /tmp/dailyhomebackup.cron.??????		w,
  }
  
  profile grep /bin/grep {
    #include <abstractions/base>
    
    # EXECUTABLES --------------------------------------
    /bin/grep						mr,
    
    # TEMP ---------------------------------------------
    /tmp/dailyhomebackup.cron.??????			w,
  }
  
  profile mount /bin/mount {
    #include <abstractions/base>
    
    # CAPABILITIES -------------------------------------
    capability sys_admin,
    
    # MOUNT --------------------------------------------
    mount fstype=ext4 options=(ro) /dev/@{BLOCK_ALL} -> /tmp/dailyhomebackup.cron.*/,
    
    # PSEUDO -------------------------------------------
    /dev/@{BLOCK_VIRT}					r,
    /sys/devices/virtual/block/@{BLOCK_VIRT}/{,**}	r,
    
    # EXECUTABLES --------------------------------------
    /bin/mount						mr,
    
    # READS/WRITES -------------------------------------
    /run/mount/utab					rw,
    
    # DENY INHERIT -------------------------------------
    deny /tmp/dailyhomebackup.cron.??????		w,
  }
  
  profile umount /bin/umount {
    #include <abstractions/base>
    
    # CAPABILITIES -------------------------------------
    capability sys_admin,
    
    # MOUNT --------------------------------------------
    umount /tmp/dailyhomebackup.cron.*/,
    
    # EXECUTABLES --------------------------------------
    /bin/umount						mr,
    
    # READS/WRITES -------------------------------------
    /run/mount/utab					rw,
    
    # DENY INHERIT -------------------------------------
    deny /tmp/dailyhomebackup.cron.??????		w,
  }
  
  profile gawk /usr/bin/gawk {
    #include <abstractions/base>
    
    # EXECUTABLES --------------------------------------
    /usr/bin/gawk					mr,
    
    # TEMP ---------------------------------------------
    /tmp/dailyhomebackup.cron.??????			w,
  }
  
  profile find /usr/bin/find {
    #include <abstractions/base>
    
    # EXECUTABLES --------------------------------------
    /usr/bin/find					mr,
    /bin/rm						Px -> daily_backup_find_rm,	# FS ACCESS! daily_backup_find_rm
    
    # READS/WRITES -------------------------------------
    /							r,
    /mnt/backup/Gentoo_Backup/				r,
    
    # DENY INHERIT -------------------------------------
    deny /tmp/dailyhomebackup.cron.??????		w,
  }
}

# FIX ME! Сейчас (модуль ядра 3.6, утилита 2.11.0) не поддерживаются
# множественные вложенные профили, выносим в отдельный профиль.
profile daily_backup_find_rm flags=(attach_disconnected) {
  #include <abstractions/base>
  
  # EXECUTABLES ----------------------------------------
  /bin/rm						mr,
  
  # READS/WRITES ---------------------------------------
  /mnt/backup/Gentoo_Backup/daily_gentoo_home_*.tar	w,
  
  # DENY INHERIT ---------------------------------------
  deny /apparmor/.null					rw,	# flags=(attach_disconnected)
  deny /tmp/dailyhomebackup.cron.??????			w,
}

profile weekly_backup.sh.cron.weekly /etc/cron.weekly/weekly_backup.sh {
  #include <abstractions/base>
  
  # PSEUDO ---------------------------------------------
  /dev/tty						rw,
  /dev/pts/[0-9]*					rw,
  @{PROC}/@{pid}/fd/					r,
  
  # EXECUTABLES ----------------------------------------
  /etc/cron.weekly/weekly_backup.sh			r,
  @{shell}						mr,
  /bin/chmod						Cx,	# FS ACCESS! chmod
  /bin/date						Cx,	# FS ACCESS! date
  /bin/tar						Cx,	# FS ACCESS! tar
  /bin/rm						Cx,	# FS ACCESS! rm
  /bin/cat						Cx,	# FS ACCESS! cat
  /bin/mktemp						Cx,	# FS ACCESS! mktemp
  /bin/grep						Cx,	# FS ACCESS! grep
  /bin/sort						Cx,	# FS ACCESS! sort
  /bin/mount						Cx,	# FS ACCESS! mount
  /bin/umount						Cx,	# FS ACCESS! umount
  /bin/basename						Px,
  /sbin/lvm						Px,
  /usr/bin/libnotify-notify-send-users			Px,
  /usr/bin/gawk						Cx,	# FS ACCESS! gawk
  /usr/bin/find						Cx,	# FS ACCESS! find
  /usr/bin/mail						Px,
  /usr/bin/logger					Px,
  
  # TEMP -----------------------------------------------
  /tmp/rootbackup.cron.??????				rw,
  /tmp/rootbackup.cron.??????/				r,
  
  profile chmod /bin/chmod {
    #include <abstractions/base>
    
    # EXECUTABLES --------------------------------------
    /bin/chmod						mr,
    
    # READS/WRITES -------------------------------------
    /mnt/backup/Gentoo_Backup/gentoo_root_*.tar		w,
    /mnt/backup/Gentoo_Backup/gentoo_var_*.tar		w,
    
    # DENY INHERIT -------------------------------------
    deny /tmp/rootbackup.cron.??????			w,
  }
  
  profile date /bin/date {
    #include <abstractions/base>
    
    # EXECUTABLES --------------------------------------
    /bin/date						mr,
    
    # DENY INHERIT -------------------------------------
    deny /tmp/rootbackup.cron.??????			w,
  }
  
  profile tar /bin/tar {
    #include <abstractions/base>
    #include <abstractions/nameservice>
    
    # CAPABILITIES -------------------------------------
    capability dac_override,
    
    # PSEUDO -------------------------------------------
    @{PROC}/@{pid}/fd/					r,
    
    # EXECUTABLES --------------------------------------
    /bin/tar						mr,
    
    # READS/WRITES -------------------------------------
    /mnt/backup/Gentoo_Backup/gentoo_root_*.tar		w,
    /mnt/backup/Gentoo_Backup/gentoo_var_*.tar		w,
    
    # TEMP ---------------------------------------------
    /tmp/rootbackup.cron.??????/{,**}			r,	# Точка монтирования снапшота c root и var.
    
    # DENY INHERIT -------------------------------------
    deny /tmp/rootbackup.cron.??????			w,
  }
  
  profile rm /bin/rm {
    #include <abstractions/base>
    
    # EXECUTABLES --------------------------------------
    /bin/rm						mr,
    
    # READS/WRITES -------------------------------------
    /tmp/rootbackup.cron.??????{,/}			rw,
  }
  
  profile cat /bin/cat {
    #include <abstractions/base>
    
    # EXECUTABLES --------------------------------------
    /bin/cat						mr,
    
    # READS/WRITES -------------------------------------
    /tmp/rootbackup.cron.??????				r,
    
    # DENY INHERIT -------------------------------------
    deny /tmp/rootbackup.cron.??????			w,
  }
  
  profile mktemp /bin/mktemp {
    #include <abstractions/base>
    
    # EXECUTABLES --------------------------------------
    /bin/mktemp						mr,
    
    # TEMP ---------------------------------------------
    /tmp/rootbackup.cron.??????{,/}			rw,
  }
  
  profile grep /bin/grep {
    #include <abstractions/base>
    
    # EXECUTABLES --------------------------------------
    /bin/grep						mr,
    
    # TEMP ---------------------------------------------
    /tmp/rootbackup.cron.??????				w,
  }
  
  profile sort /bin/sort {
    #include <abstractions/base>
    
    # EXECUTABLES --------------------------------------
    /bin/sort						mr,
    
    # TEMP ---------------------------------------------
    /tmp/rootbackup.cron.??????				w,
  }
  
  profile mount /bin/mount {
    #include <abstractions/base>
    
    # CAPABILITIES -------------------------------------
    capability sys_admin,
    
    # MOUNT --------------------------------------------
    mount fstype=ext4 options=(ro) /dev/@{BLOCK_ALL} -> /tmp/rootbackup.cron.*/,
    
    # PSEUDO -------------------------------------------
    /dev/@{BLOCK_VIRT}					r,
    /sys/devices/virtual/block/@{BLOCK_VIRT}/{,**}	r,
    
    # EXECUTABLES --------------------------------------
    /bin/mount						mr,
    
    # READS/WRITES -------------------------------------
    /run/mount/utab					rw,
    
    # DENY INHERIT -------------------------------------
    deny /tmp/rootbackup.cron.??????			w,
  }
  
  profile umount /bin/umount {
    #include <abstractions/base>
    
    # CAPABILITIES -------------------------------------
    capability sys_admin,
    
    # MOUNT --------------------------------------------
    umount /tmp/rootbackup.cron.*/,
    
    # EXECUTABLES --------------------------------------
    /bin/umount						mr,
    
    # READS/WRITES -------------------------------------
    /run/mount/utab					rw,
    
    # DENY INHERIT -------------------------------------
    deny /tmp/rootbackup.cron.??????			w,
  }
  
  profile gawk /usr/bin/gawk {
    #include <abstractions/base>
    
    # EXECUTABLES --------------------------------------
    /usr/bin/gawk					mr,
    
    # TEMP ---------------------------------------------
    /tmp/rootbackup.cron.??????				w,
  }
  
  profile find /usr/bin/find {
    #include <abstractions/base>
    
    # EXECUTABLES --------------------------------------
    /usr/bin/find					mr,
    /bin/rm						Px -> weekly_backup_find_rm,	# FS ACCESS! weekly_backup_find_rm
    
    # READS/WRITES -------------------------------------
    /							r,
    /mnt/backup/Gentoo_Backup/				r,
    
    # DENY INHERIT -------------------------------------
    deny /tmp/rootbackup.cron.??????			w,
  }
}

# FIX ME! Сейчас (модуль ядра 3.6, утилита 2.11.0) не поддерживаются
# множественные вложенные профили, выносим в отдельный профиль.
profile weekly_backup_find_rm flags=(attach_disconnected) {
  #include <abstractions/base>
  
  # EXECUTABLES ----------------------------------------
  /bin/rm						mr,
  
  # READS/WRITES ---------------------------------------
  /mnt/backup/Gentoo_Backup/gentoo_root_*.tar		w,
  /mnt/backup/Gentoo_Backup/gentoo_var_*.tar		w,
  
  # DENY INHERIT ---------------------------------------
  deny /apparmor/.null					rw,	# flags=(attach_disconnected)
  deny /tmp/rootbackup.cron.??????			w,
}
