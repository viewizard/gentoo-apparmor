# ------------------------------------------------------------------
#
#    Copyright (C) 2016 Mikhail Kurinnoi
#
#    This program is free software; you can redistribute it and/or
#    modify it under the terms of version 2 of the GNU General Public
#    License published by the Free Software Foundation.
#
# ------------------------------------------------------------------

#include <tunables/global>
profile zfs /sbin/zfs flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  
  capability sys_resource,
  
  /dev/zfs rw,
  /dev/pts/[0-9]* w,
  @{PROC}/@{pid}/mounts r,
  @{PROC}/sys/fs/pipe-max-size r,
  
  /sbin/zfs r,
  /bin/mount Px,
  
  /etc/dfs/sharetab r,
  
  owner @{HOME}/.session.log w,
  
}


profile zfs.mount /sbin/mount.zfs flags=(complain) {
  #include <abstractions/base>
  
  /sbin/mount.zfs r,
  
}

profile zfs.zpool /sbin/zpool flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  
  /dev/zfs rw,
  /dev/pts/[0-9]* w,
  /sys/module/spl/parameters/spl_hostid r,
  @{PROC}/@{pid}/mounts r,
  
  /sbin/zpool r,
  /bin/umount Px,
  /usr/libexec/zfs/zed.d/all-syslog.sh Px,
  
  /etc/dfs/sharetab r,
  /etc/zfs/zpool.cache rw,
  
}


profile zfs.zed /sbin/zed flags=(complain) {
  #include <abstractions/base>
  
  /dev/zfs rw,
  @{PROC}/@{pid}/mounts r,
  
  /sbin/zed r,
  /usr/libexec/zfs/zed.d/all-syslog.sh Px,
  
  /etc/dfs/sharetab r,
  /etc/zfs/zed.d/{,*} r,
  
  /var/lib/run/zed.{pid,state} rwk,
  
}


profile zfs.zed.d /usr/libexec/zfs/zed.d/*.sh {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  
  /dev/tty rw,
  
  /usr/libexec/zfs/zed.d/*.sh r,
  /bin/bash r,
  /usr/bin/logger Px,
  
  /etc/zfs/zed.d/zed-functions.sh r,
  /etc/zfs/zed.d/zed.rc r,
  
}


profile zfs.zfs-zed.init.d /etc/init.d/zfs-zed flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  capability dac_override,
  capability dac_read_search,
  
  /bin/bash Cx -> shell,
  /sbin/zpool Px,
  /sbin/zed Px,
  /bin/rm ix,
  /bin/kmod Pxr,
  
  / r,
  /etc/init.d/zfs-zed r,
  /etc/conf.d/zfs r,
  /etc/zfs/zfs-functions r,
  
  /var/lib/run/zed.pid r,
  
  
  profile shell flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/openrc_shell>
    
  }
  
}


profile zfs.zfs-import.init.d /etc/init.d/zfs-import flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  /bin/bash Cx -> shell,
  /bin/grep ix,
  /bin/uname ix,
  /bin/udevadm Px,
  /bin/kmod Pxr,
  /sbin/zpool Px,
  
  / r,
  /etc/conf.d/zfs r,
  /etc/zfs/zfs-functions r,
  /etc/init.d/zfs-import r,
  
  
  profile shell flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/openrc_shell>
    
  }
  
}
