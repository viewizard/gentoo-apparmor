# ------------------------------------------------------------------
#
#  Copyright (C) 2016,2017 Mikhail Kurinnoi
#
#  This program is free software; you can redistribute it and/or
#  modify it under the terms of version 2 of the GNU General Public
#  License published by the Free Software Foundation.
#
# ------------------------------------------------------------------

#include <tunables/global>

# предустановка для abstractions/fs/access-by-user-preset-{rk,rwk,rwkl}
@{USERS_DIR}="**"
@{USERS_FILE}="**"

# профиль используется службами без аутентификации
profile shell_service @{shell} {
  #include <abstractions/base>
  #include <abstractions/shell>
  #include <abstractions/consoles>
  #include <abstractions/nameservice>
  
  # EXECUTABLES ----------------------------------------
  @{shell}						mr,
  /bin/sed						Cx,
  /bin/uname						Px,
  /sbin/mdadm						Px,
  
  profile sed /bin/sed {
    #include <abstractions/base>
    
    # EXECUTABLES ----------------------------------------
    /bin/sed						mr,
  }
}

# профиль для запуска logcheck
profile shell_logcheck {
  #include <abstractions/base>
  
  # PSEUDO ---------------------------------------------
  /dev/tty						rw,
  /dev/pts/[0-9]*					rw,
  
  # EXECUTABLES ----------------------------------------
  @{shell}						mr,
  /usr/sbin/logcheck					Px,
}

# профиль всех пользователей, прошедших аутентификацию
# профиль терминала по умолчанию
profile shell_users {
  #include <abstractions/base>
  #include <abstractions/shell>
  #include <abstractions/consoles>
  #include <abstractions/nameservice>
  #include <abstractions/fs/access-by-users-preset-rwk>
  #include <abstractions/fs/deny-by-pattern-internet>
  
  # CAPABILITIES ---------------------------------------
  capability setuid,
  capability sys_tty_config,
  capability kill,
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  
  # EXECUTABLES ----------------------------------------
  @{shell}						mr,
  audit @{shell}					ix,	# FIX ME! 23.07.2017 что и как вызывает?
  /bin/ls						Cx,
  /bin/ln						Cx,
  /bin/df						Px,
  /bin/rm						Cx,
  /bin/tty						Px,
  /bin/grep						Cx,
  /bin/ps						Px,
  /bin/passwd						Px,
  /bin/uname						Px,
  /bin/su						Px,
  /bin/rc-status					Px,
  /bin/sleep						Px,
  /usr/bin/which					Px,
  /usr/bin/git						Px,
  /usr/bin/sudo						Px,
  /usr/bin/whoami					Px,
  /usr/bin/id						Px,
  /usr/bin/startx{,fce4}				Px,
  /usr/bin/clear					Px,
  /usr/bin/wine						Px,
  /usr/bin/winecfg					Px,
  /usr/bin/libnotify-notify-send			Px,
  /usr/bin/dircolors					Px,
  
  # READS/WRITES ---------------------------------------
  /etc/profile.env					r,
  /etc/bash/bash_logout					r,
  
  profile grep /bin/grep {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-users-preset-rwk>
    #include <abstractions/fs/deny-by-pattern-internet>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/grep						mr,
  }
  
  profile ln /bin/ln {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-users-preset-rwk>
    #include <abstractions/fs/deny-by-pattern-internet>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/ln						mr,
  }
  
  profile rm /bin/rm {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-users-preset-rwk>
    #include <abstractions/fs/deny-by-pattern-internet>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/rm						mr,
  }
  
  profile ls /bin/ls {
    #include <abstractions/base>
    #include <abstractions/nameservice>
    #include <abstractions/fs/access-by-users-preset-rwk>
    #include <abstractions/fs/deny-by-pattern-internet>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/ls						mr,
  }
}

# профиль специального пользователя root
profile shell_root {
  #include <abstractions/base>
  #include <abstractions/shell>
  #include <abstractions/consoles>
  #include <abstractions/nameservice>
  #include <abstractions/fs/access-by-pattern-filemanager>
  #include <abstractions/fs/access-by-pattern-systemusers>
  
  # CAPABILITIES ---------------------------------------
  audit capability setuid,					# FIX ME! audit 25.07.2017
  audit capability setgid,					# FIX ME! audit 25.07.2017
  audit capability sys_admin,					# FIX ME! audit 25.07.2017
  audit capability chown,					# FIX ME! audit 25.07.2017
  audit capability mknod,					# FIX ME! audit 25.07.2017
  audit capability fsetid,					# FIX ME! audit 25.07.2017
  audit capability fowner,					# FIX ME! audit 25.07.2017
  audit capability sys_tty_config,				# FIX ME! audit 25.07.2017
  audit capability kill,					# FIX ME! audit 25.07.2017
  audit capability setfcap,					# FIX ME! audit 25.07.2017
  
  # SIGNAL ---------------------------------------------
  signal (send) set=(hup, int, kill, term, cont),		# Реакция на нажатия комбинаций кнопок.
  								# FIX ME! Отсылать запущенным в этом шеле.
  
  # EXECUTABLES ----------------------------------------
  @{shell}						mr,
  audit @{shell}					ix,	# FIX ME! 24.07.2017 что и как вызывает?
  /bin/ls						Cx,
  /bin/ln						Cx,
  /bin/df						Px,
  /bin/rm						Cx,
  /bin/cut						Cx,
  /bin/tty						Px,
  /bin/tr						Px,
  /bin/grep						Cx,
  /bin/ps						Px,
  /bin/env						Cx,
  /bin/sed						Cx,
  audit /bin/gzip					Cx,	# FIX ME! audit 25.07.2017
  /bin/mount						Cx,
  /bin/umount						Cx,
  /bin/sleep						Px,
  /bin/passwd						Px,
  /bin/uname						Px,
  /bin/su						Px,
  /bin/cp						Cx,
  /bin/mv						Cx,
  /bin/chown						Cx,
  /bin/chmod						Cx,
  /bin/nano						Cx,
  /bin/kmod						Px,
  /bin/cat						Cx,
  /bin/dd						Cx,
  /bin/ping						Px,
  /bin/ifconfig						Px,
  /bin/rc-status					Px,
  /bin/date						Px,
  /bin/netstat						Px,
  /bin/getfacl						Px,
  /bin/setfacl						Px,
  audit /bin/tar					Cx,	# FIX ME! audit 25.07.2017
  /bin/head						Cx,
  /bin/tail						Cx,
  /bin/getfattr						Px,
  /bin/setfattr						Px,
  /bin/mkdir						Cx,
  /bin/touch						Cx,
  /bin/lsblk						Px,
  /bin/sync						Px,
  /bin/udevadm						Px,
  /bin/dmesg						Px,
  /sbin/mdadm						Px,
  /sbin/shutdown					Px,	# sysvinit
  /sbin/{halt,poweroff,reboot}				Px,	# sysvinit
  /sbin/openrc-shutdown					Px,	# openrc-init
  /sbin/cryptsetup					Px,
  /sbin/apparmor_parser					Px,
  /sbin/{,c}fdisk					Px,
  /sbin/lvm						Px,
  /sbin/e2fsck						Px,
  /sbin/mke2fs						Px,
  /sbin/tune2fs						Px,
  /sbin/mkswap						Px,
  /sbin/rc-update					Px,
  /sbin/fsck						Px,
  /sbin/rc-service					Px,
  /sbin/xtables-multi					Px,
  /sbin/blkid						Px,
  /usr/bin/which					Px,
  /usr/bin/git						Px -> git_root,
  audit /usr/bin/exo-open				Px,	# FIX ME! audit 25.07.2017
  /usr/bin/killall					Px,
  /usr/bin/gsettings					Px,
  /usr/bin/revdep-rebuild				Px,
  /usr/bin/whoami					Px,
  /usr/bin/id						Px,
  /usr/bin/rsync					Cx,
  /usr/bin/htop						Px,
  /usr/bin/mc						Px -> mc_root,
  /usr/bin/eselect					Px,
  /usr/bin/ntpq						Px,
  /usr/bin/genkernel					Px,	# BUILD SYSTEM ONLY!
  /usr/bin/{,g}make					Px,	# BUILD SYSTEM ONLY!
  /usr/bin/stat						Px,
  /usr/bin/file						Cx,
  /usr/bin/lsusb					Px,
  /usr/bin/gpg{,2,-static}				Px,
  /usr/bin/find						Cx,
  /usr/bin/nmap						Px,
  /usr/bin/wget						Px -> wget_root,
  /usr/bin/man						Px,
  /usr/bin/locale					Px,
  /usr/bin/ldd						Px,
  /usr/bin/evmctl					Px,	# BUILD SYSTEM ONLY!
  /usr/bin/gawk						Cx,
  /usr/bin/patch					Cx,
  /usr/bin/diff						Cx,
  /usr/bin/gcc-config					Px,
  audit /usr/bin/libnotify-notify-send			Px,	# FIX ME! audit 25.07.2017
  /usr/bin/ck-list-sessions				Px,
  /usr/bin/dig						Px,
  /usr/bin/dircolors					Px,
  /usr/bin/eix						Px,
  /usr/bin/eix-test-obsolete				Px,
  /usr/bin/eix-sync					Px,
  audit /usr/sbin/logcheck				Px,	# FIX ME! audit 25.07.2017
  /usr/sbin/gdisk					Px,
  /usr/sbin/smartctl					Px,
  /usr/sbin/useradd					Px,
  /usr/sbin/userdel					Px,
  /usr/sbin/usermod					Px,
  /usr/sbin/groupadd					Px,
  /usr/sbin/groupdel					Px,
  /usr/sbin/lspci					Px,
  /usr/sbin/etc-update					Px,
  /usr/sbin/grub-mkconfig				Px,
  /usr/sbin/grub-install				Px,
  /usr/sbin/perl-cleaner				Px,
  /usr/sbin/python-updater				Px,
  /usr/sbin/iftop					Px,
  /usr/sbin/nettop					Px,
  /usr/sbin/firewall					Px,
  @{PYTHON_EXEC_WRAPPER}				Px -> python_exec_root,
  /usr/local/bin/**					Px,
  /usr/local/sbin/**					Px,
  /etc/init.d/*						Px,
  /usr/src/@{kernel}/scripts/*				Px,	# в профиле /etc/apparmor.d/kernel
  /usr/src/IMA/certs/*					Px,	# в профиле /etc/apparmor.d/kernel
  
  # AUDIT EXECUTABLES ----------------------------------
  audit deny /usr/bin/startx*				x,	# RBAC! Запрещаем запуск Xorg-server под root. У нас
  								# нет полноценной ветки профилей для запуска всех
  								# дочерних процессов.
  
  # READS/WRITES ---------------------------------------
  /etc/profile.env					r,
  
  profile ls /bin/ls flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/ls						mr,
  }
  
  profile ln /bin/ln flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/ln						mr,
  }
  
  profile rm /bin/rm flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/rm						mr,
  }
  
  profile cut /bin/cut flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/cut						mr,
  }
  
  profile grep /bin/grep flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # CAPABILITIES -------------------------------------
    capability mknod,
    
    # PSEUDO -------------------------------------------
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/grep						mr,
  }
  
  profile env /bin/env flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/env						mr,
  }
  
  profile sed /bin/sed flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/sed						mr,
  }
  
  profile gzip /bin/gzip flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/gzip						mr,
  }
  
  profile mount /bin/mount {					# BUILD SYSTEM ONLY!
    #include <abstractions/base>
    
    # CAPABILITIES -------------------------------------
    capability sys_admin,
    
    # MOUNT --------------------------------------------	# FIX ME! /etc/fstab
    mount fstype=ext4 options=(rw, noatime, iversion) /dev/@{BLOCK_ALL} -> /boot/,	# BUILD SYSTEM ONLY!
    mount fstype=ext2 options=(rw, nosuid, nodev, noexec, noatime, iversion) /dev/@{BLOCK_ALL} -> /mnt/usbcryptkey/,	# BUILD SYSTEM ONLY!
    
    # PSEUDO -------------------------------------------
    /dev/pts/[0-9]*					rw,
    /sys/devices/virtual/block/@{BLOCK_VIRT}/{,**}	r,
    @{PROC}/@{pid}/mount{s,info}			r,
    
    # EXECUTABLES --------------------------------------
    /bin/mount						mr,
    
    # READS/WRITES -------------------------------------
    /etc/fstab						r,
    /run/mount/utab					rw,
  }
  
  profile umount /bin/umount {					# BUILD SYSTEM ONLY!
    #include <abstractions/base>
    
    # CAPABILITIES -------------------------------------
    capability sys_admin,
    
    # MOUNT --------------------------------------------	# FIX ME! /etc/fstab
    umount /boot/,						# BUILD SYSTEM ONLY!
    umount /mnt/usbcryptkey/,					# BUILD SYSTEM ONLY!
    
    # PSEUDO -------------------------------------------
    /dev/pts/[0-9]*					rw,
    /sys/devices/virtual/block/@{BLOCK_VIRT}/{,**}	r,
    @{PROC}/@{pid}/mountinfo				r,
    
    # EXECUTABLES --------------------------------------
    /bin/umount						mr,
    
    # READS/WRITES -------------------------------------
    /run/mount/utab					rw,
  }
  
  profile cp /bin/cp flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # CAPABILITIES -------------------------------------
    capability fowner,
    capability fsetid,
    capability sys_admin,
    
    # PSEUDO -------------------------------------------
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/cp						mr,
  }
  
  profile mv /bin/mv flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/mv						mr,
  }
  
  profile chown /bin/chown flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # CAPABILITIES -------------------------------------
    capability chown,
    
    # PSEUDO -------------------------------------------
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/chown						mr,
  }
  
  profile chmod /bin/chmod flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # CAPABILITIES -------------------------------------
    capability fowner,
    capability fsetid,
    
    # PSEUDO -------------------------------------------
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/chmod						mr,
  }
  
  profile nano /bin/nano flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/nano						mr,
  }
  
  profile cat /bin/cat flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/cat						mr,
  }
  
  profile dd /bin/dd flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/dd						mr,
  }
  
  profile tar /bin/tar flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/tar						mr,
  }
  
  profile head /bin/head flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/head						mr,
  }
  
  profile tail /bin/tail flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/tail						mr,
  }
  
  profile mkdir /bin/mkdir flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/mkdir						mr,
  }
  
  profile touch /bin/touch flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/touch						mr,
  }
  
  profile rsync /usr/bin/rsync flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /usr/bin/rsync					mr,
  }
  
  profile file /usr/bin/file flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /usr/bin/file					mr,
  }
  
  profile find /usr/bin/find flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /usr/bin/find					mr,
  }
  
  profile gawk /usr/bin/gawk flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /usr/bin/gawk					mr,
  }
  
  profile patch /usr/bin/patch flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # CAPABILITIES ---------------------------------------
    capability chown,
    capability fowner,
    capability fsetid,
    
    # PSEUDO -------------------------------------------
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /usr/bin/patch					mr,
  }
  
  profile diff /usr/bin/diff flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /usr/bin/diff					mr,
  }
}
