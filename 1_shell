# ------------------------------------------------------------------
#
#  Copyright (C) 2016,2017 Mikhail Kurinnoi
#
#  This program is free software; you can redistribute it and/or
#  modify it under the terms of version 2 of the GNU General Public
#  License published by the Free Software Foundation.
#
# ------------------------------------------------------------------

#include <tunables/global>

# предустановка для abstractions/fs/access-by-user-preset-{rk,rwk,rwkl}
@{USERS_DIR}="**"
@{USERS_FILE}="**"

# профиль используется службами без аутентификации
profile shell_service @{shell} {
  #include <abstractions/base>
  #include <abstractions/shell>
  #include <abstractions/consoles>
  #include <abstractions/nameservice>
  
  # EXECUTABLES ----------------------------------------
  @{shell}						mr,
  /bin/sed						Cx,
  /bin/uname						Px,
  /sbin/mdadm						Px,
  
  profile sed /bin/sed {
    #include <abstractions/base>
    
    # EXECUTABLES ----------------------------------------
    /bin/sed						mr,
  }
}

# профиль для запуска logcheck
profile shell_logcheck {
  #include <abstractions/base>
  
  # PSEUDO ---------------------------------------------
  /dev/tty						rw,
  /dev/pts/[0-9]*					rw,
  
  # EXECUTABLES ----------------------------------------
  @{shell}						mr,
  /usr/sbin/logcheck					Px,
}

# профиль всех пользователей, прошедших аутентификацию
# профиль терминала по умолчанию
profile shell_users {
  #include <abstractions/base>
  #include <abstractions/shell>
  #include <abstractions/consoles>
  #include <abstractions/nameservice>
  #include <abstractions/fs/access-by-users-preset-rwk>
  #include <abstractions/fs/deny-by-pattern-internet>
  
  # CAPABILITIES ---------------------------------------
  capability setuid,
  capability sys_tty_config,
  capability kill,
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  
  # EXECUTABLES ----------------------------------------
  @{shell}						mr,
  audit @{shell}					ix,	# FIX ME! 23.07.2017 что и как вызывает?
  /bin/ls						Cx,
  /bin/ln						Cx,
  /bin/df						Px,
  /bin/rm						Cx,
  /bin/tty						Px,
  /bin/grep						Cx,
  /bin/ps						Px,
  /bin/passwd						Px,
  /bin/uname						Px,
  /bin/su						Px,
  /bin/rc-status					Px,
  /bin/sleep						Px,
  /usr/bin/which					Px,
  /usr/bin/git						Px,
  /usr/bin/sudo						Px,
  /usr/bin/whoami					Px,
  /usr/bin/id						Px,
  /usr/bin/startx{,fce4}				Px,
  /usr/bin/clear					Px,
  /usr/bin/wine						Px,
  /usr/bin/winecfg					Px,
  /usr/bin/libnotify-notify-send			Px,
  /usr/bin/dircolors					Px,
  
  # READS/WRITES ---------------------------------------
  /etc/profile.env					r,
  /etc/bash/bash_logout					r,
  
  profile grep /bin/grep {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-users-preset-rwk>
    #include <abstractions/fs/deny-by-pattern-internet>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/grep						mr,
  }
  
  profile ln /bin/ln {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-users-preset-rwk>
    #include <abstractions/fs/deny-by-pattern-internet>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/ln						mr,
  }
  
  profile rm /bin/rm {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-users-preset-rwk>
    #include <abstractions/fs/deny-by-pattern-internet>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/rm						mr,
  }
  
  profile ls /bin/ls {
    #include <abstractions/base>
    #include <abstractions/nameservice>
    #include <abstractions/fs/access-by-users-preset-rwk>
    #include <abstractions/fs/deny-by-pattern-internet>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/ls						mr,
  }
}

# профиль специального пользователя root
profile shell_root {
  #include <abstractions/base>
  #include <abstractions/shell>
  #include <abstractions/consoles>
  #include <abstractions/nameservice>
  #include <abstractions/fs/access-by-pattern-filemanager>
  #include <abstractions/fs/access-by-pattern-systemusers>
  
  # CAPABILITIES ---------------------------------------
  capability setuid,
  capability setgid,
  capability sys_admin,
  capability chown,
  capability mknod,
  capability fsetid,
  capability fowner,
  capability sys_tty_config,
  capability kill,
  capability setfcap,
  
  # SIGNAL ---------------------------------------------
  signal (send) set=(hup, int, kill, term, cont),		# Реакция на нажатия комбинаций кнопок.
  								# FIX ME! Отсылать запущенным в этом шеле.
  
  # EXECUTABLES ----------------------------------------
  @{shell}						mr,
  audit @{shell}					ix,	# FIX ME! 24.07.2017 что и как вызывает?
  /bin/ls						ix,	# FS ACCESS!
  /bin/ln						ix,	# FS ACCESS!
  /bin/df						Px,
  /bin/rm						ix,	# FS ACCESS!
  /bin/cut						ix,	# FS ACCESS!
  /bin/tty						Px,
  /bin/tr						Px,
  /bin/grep						ix,	# FS ACCESS!
  /bin/ps						Px,
  /bin/env						ix,	# ix в основном профиле, т.к. через него
  								# можем запускать другие разрешенные процессы.
  /bin/sed						ix,	# FS ACCESS!
  /bin/gzip						ix,	# FS ACCESS!
  /bin/mount						Cx,
  /bin/umount						Cx,
  /bin/sleep						Px,
  /bin/passwd						Px,
  /bin/uname						Px,
  /bin/su						Px,
  /bin/cp						ix,	# FS ACCESS!
  /bin/mv						ix,	# FS ACCESS!
  /bin/chown						ix,	# FIX ME! Вынести в отдельный профиль.
  /bin/chmod						ix,	# FIX ME! Вынести в отдельный профиль.
  /bin/nano						ix,	# FS ACCESS!
  /bin/kmod						Px,
  /bin/cat						ix,	# FS ACCESS!
  /bin/dd						ix,	# FS ACCESS!
  /bin/ping						Px,
  /bin/ifconfig						Px,
  /bin/rc-status					Px,
  /bin/date						Px,
  /bin/tail						ix,	# FS ACCESS!
  /bin/netstat						Px,
  /bin/getfacl						Px,
  /bin/tar						ix,	# FS ACCESS!
  /bin/head						ix,	# FS ACCESS!
  /bin/tail						ix,	# FS ACCESS!
  /bin/getfattr						ix,	# FIX ME! Вынести в отдельный профиль.
  /bin/setfattr						ix,	# FIX ME! Вынести в отдельный профиль.
  /bin/cpio						ix,	# FS ACCESS!
  /bin/keyctl						ix,	# FS ACCESS!
  /bin/mkdir						ix,	# FS ACCESS!
  /bin/touch						ix,	# FS ACCESS!
  /bin/lsblk						Px,
  /bin/sync						Px,
  /bin/udevadm						Px,
  /bin/dmesg						Px,
  /sbin/mdadm						Px,
  /sbin/shutdown					Px,
  /sbin/{halt,poweroff,reboot}				Px,
  /sbin/cryptsetup					Px,
  /sbin/apparmor_parser					Px,
  /sbin/paxctl						ix,	# FIX ME! Вынести в отдельный профиль.
  /sbin/gradm						Px,
  /sbin/{,c}fdisk					Px,
  /sbin/lvm						Px,
  /sbin/e2fsck						Px,
  /sbin/mke2fs						Px,
  /sbin/tune2fs						Px,
  /sbin/mkswap						Px,
  /sbin/zpool						Px,
  /sbin/zfs						Px,
  /sbin/rc-update					Px,
  /sbin/fsck						Px,
  /sbin/rc-service					Px,
  /sbin/xtables-multi					Px,
  /sbin/blkid						Px,
  /usr/bin/which					Px,
  /usr/bin/git						Px -> git_root,
  /usr/bin/exo-open					Px,
  /usr/bin/killall					Px,
  /usr/bin/gsettings					Px,
  /usr/bin/revdep-rebuild				Px,
  /usr/bin/whoami					Px,
  /usr/bin/id						Px,
  /usr/bin/rsync					ix,	# FS ACCESS!
  /usr/bin/htop						Px,
  /usr/bin/mc						Px -> mc_root,
  /usr/bin/eselect					Px,
  /usr/bin/ntpq						Px,
  /usr/bin/genkernel					Px,	# BUILD SYSTEM ONLY!
  /usr/bin/{,g}make					Px,	# BUILD SYSTEM ONLY!
  /usr/bin/stat						Px,
  /usr/bin/file						ix,	# FS ACCESS!
  /usr/bin/lsusb					Px,
  /usr/bin/gpg{,2,-static}				Px,
  /usr/bin/find						ix,	# FS ACCESS!
  /usr/bin/nmap						Px,
  /usr/bin/wget						Px -> wget_root,
  /usr/bin/man						Px,
  /usr/bin/locale					Px,
  /usr/bin/ldd						Px,
  /usr/bin/evmctl					Px,
  /usr/bin/gawk						ix,	# FS ACCESS!
  /usr/bin/patch					ix,	# FS ACCESS!
  /usr/bin/diff						ix,	# FS ACCESS!
  /usr/bin/gcc-config					Px,
  /usr/bin/libnotify-notify-send			Px,
  /usr/bin/ck-list-sessions				Px,
  /usr/bin/dig						Px,
  /usr/bin/dircolors					Px,
  /usr/sbin/logcheck					Px,
  /usr/sbin/aideinit					Px,
  /usr/sbin/gdisk					Px,
  /usr/sbin/smartctl					Px,
  /usr/sbin/useradd					Px,
  /usr/sbin/userdel					Px,
  /usr/sbin/lspci					Px,
  /usr/sbin/etc-update					Px,
  /usr/sbin/migrate-pax					Px,
  /usr/sbin/revdep-pax					Px,
  /usr/sbin/paxctl-ng					ix,	# FIX ME! Вынести в отдельный профиль.
  /usr/sbin/grub-mkconfig				Px,
  /usr/sbin/grub-install				Px,
  /usr/sbin/perl-cleaner				Px,
  /usr/sbin/python-updater				Px,
  /usr/sbin/iftop					Px,
  /usr/sbin/nettop					Px,
  /usr/sbin/firewall					Px,
  /usr/sbin/sysctl					Px,
  @{PYTHON_EXEC_WRAPPER}				Px -> python_exec_root,
  /usr/local/bin/**					Px,
  /usr/local/sbin/**					Px,
  /etc/init.d/*						Px,
  /usr/src/@{kernel}/scripts/*				Px,	# в профиле /etc/apparmor.d/kernel
  /usr/src/IMA/certs/*					Px,	# в профиле /etc/apparmor.d/kernel
  
  # AUDIT EXECUTABLES ----------------------------------
  audit deny /usr/bin/startx*				x,	# RBAC! Запрещаем запуск Xorg-server под root. У нас
  								# нет полноценной ветки профилей для запуска всех
  								# дочерних процессов.
  
  # READS/WRITES ---------------------------------------
  /etc/profile.env					r,
  
  profile mount /bin/mount {					# BUILD SYSTEM ONLY!
    #include <abstractions/base>
    
    # CAPABILITIES -------------------------------------
    capability sys_admin,
    
    # MOUNT --------------------------------------------	# FIX ME! /etc/fstab
    mount fstype=ext4 options=(rw, noatime, iversion) /dev/@{BLOCK_ALL} -> /boot/,	# BUILD SYSTEM ONLY!
    mount fstype=ext2 options=(rw, nosuid, nodev, noexec, noatime, iversion) /dev/@{BLOCK_ALL} -> /mnt/usbcryptkey/,	# BUILD SYSTEM ONLY!
    
    # PSEUDO -------------------------------------------
    /dev/pts/[0-9]*					rw,
    /sys/devices/virtual/block/@{BLOCK_VIRT}/{,**}	r,
    @{PROC}/@{pid}/mount{s,info}			r,
    
    # EXECUTABLES --------------------------------------
    /bin/mount						mr,
    
    # READS/WRITES -------------------------------------
    /etc/fstab						r,
    /run/mount/utab					rw,
  }
  
  profile umount /bin/umount {					# BUILD SYSTEM ONLY!
    #include <abstractions/base>
    
    # CAPABILITIES -------------------------------------
    capability sys_admin,
    
    # MOUNT --------------------------------------------	# FIX ME! /etc/fstab
    umount /boot/,						# BUILD SYSTEM ONLY!
    umount /mnt/usbcryptkey/,					# BUILD SYSTEM ONLY!
    
    # PSEUDO -------------------------------------------
    /dev/pts/[0-9]*					rw,
    /sys/devices/virtual/block/@{BLOCK_VIRT}/{,**}	r,
    @{PROC}/@{pid}/mountinfo				r,
    
    # EXECUTABLES --------------------------------------
    /bin/umount						mr,
    
    # READS/WRITES -------------------------------------
    /run/mount/utab					rw,
  }
}
