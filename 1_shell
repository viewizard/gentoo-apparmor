# ------------------------------------------------------------------
#
#  Copyright (C) 2016,2017 Mikhail Kurinnoi
#
#  This program is free software; you can redistribute it and/or
#  modify it under the terms of version 2 of the GNU General Public
#  License published by the Free Software Foundation.
#
# ------------------------------------------------------------------

#include <tunables.d/>

# предустановка для abstractions/fs/access-by-user-preset-{rk,rwk,rwkl}
@{USERS_DIR}="**"
@{USERS_FILE}="**"

# профиль используется службами без аутентификации
profile shell_service @{shell} {
  #include <abstractions/base>
  #include <abstractions/shell>
  #include <abstractions/consoles>
  #include <abstractions/nameservice>
  
  # EXECUTABLES ----------------------------------------
  @{shell}						mr,
  /bin/sed						Cx,
  /bin/uname						Px,
  /sbin/mdadm						Px,	# FIX ME! (?) вынести в <local/shell/shell_service.d/>
  
  profile sed /bin/sed {
    #include <abstractions/base>
    
    # EXECUTABLES --------------------------------------
    /bin/sed						mr,
  }
}

# профиль всех пользователей, прошедших аутентификацию
# профиль терминала по умолчанию
profile shell_users {
  #include <abstractions/base>
  #include <abstractions/shell>
  #include <abstractions/consoles>
  #include <abstractions/nameservice>
  #include <abstractions/fs/access-by-users-preset-rwk>
  #include <abstractions/fs/deny-by-pattern-internet>
  
  # CAPABILITIES ---------------------------------------
  capability setuid,
  capability sys_tty_config,
  capability kill,
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  
  # EXECUTABLES ----------------------------------------
  @{shell}						mr,
  /bin/ls						Cx,
  /bin/ln						Cx,
  /bin/df						Px,
  /bin/rm						Cx,
  /bin/tty						Px,
  /bin/grep						Cx,
  /bin/ps						Px,
  /bin/passwd						Px,
  /bin/uname						Px,
  /bin/su						Px,
  /bin/rc-status					Px,
  /bin/sleep						Px,
  /usr/bin/which					Px,
  /usr/bin/git						Px,	# FIX ME! (?) вынести в <local/shell/shell_users.d/>
  /usr/bin/sudo						Px,
  /usr/bin/whoami					Px,
  /usr/bin/id						Px,
  /usr/bin/startx{,fce4}				Px,	# FIX ME! (?) вынести в <local/shell/shell_users.d/>
  /usr/bin/clear					Px,
  /usr/bin/wine						Px,	# FIX ME! (?) вынести в <local/shell/shell_users.d/>
  /usr/bin/winecfg					Px,	# FIX ME! (?) вынести в <local/shell/shell_users.d/>
  /usr/bin/wine-{any,d3d9,staging,vanilla}-[0-9]*	Px,	# FIX ME! (?) вынести в <local/shell/shell_users.d/>
  /usr/bin/winecfg-{any,d3d9,staging,vanilla}-[0-9]*	Px,	# FIX ME! (?) вынести в <local/shell/shell_users.d/>
  /usr/bin/dircolors					Px,
  /usr/bin/libnotify-notify-send			Px,	# /usr/bin/libnotify-notify-send-users запускает в шеле пользователя.
  
  # READS/WRITES ---------------------------------------
  /etc/profile.env					r,
  /etc/bash/bash_logout					r,
  
  profile grep /bin/grep {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-users-preset-rwk>
    #include <abstractions/fs/deny-by-pattern-internet>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/grep						mr,
  }
  
  profile ln /bin/ln {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-users-preset-rwk>
    #include <abstractions/fs/deny-by-pattern-internet>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/ln						mr,
  }
  
  profile rm /bin/rm {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-users-preset-rwk>
    #include <abstractions/fs/deny-by-pattern-internet>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/rm						mr,
  }
  
  profile ls /bin/ls {
    #include <abstractions/base>
    #include <abstractions/nameservice>
    #include <abstractions/fs/access-by-users-preset-rwk>
    #include <abstractions/fs/deny-by-pattern-internet>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/ls						mr,
  }
}

# профиль специального пользователя root
profile shell_root {
  #include <abstractions/base>
  #include <abstractions/shell>
  #include <abstractions/consoles>
  #include <abstractions/nameservice>
  #include <abstractions/fs/access-by-pattern-filemanager>
  #include <abstractions/fs/access-by-pattern-systemusers>
  #include <local/profile/shell_root.d/>
  
  # CAPABILITIES ---------------------------------------
  audit capability setuid,					# FIX ME! audit 25.07.2017
  audit capability setgid,					# FIX ME! audit 25.07.2017
  audit capability sys_admin,					# FIX ME! audit 25.07.2017
  audit capability chown,					# FIX ME! audit 25.07.2017
  audit capability mknod,					# FIX ME! audit 25.07.2017
  audit capability fsetid,					# FIX ME! audit 25.07.2017
  audit capability fowner,					# FIX ME! audit 25.07.2017
  audit capability sys_tty_config,				# FIX ME! audit 25.07.2017
  audit capability kill,					# FIX ME! audit 25.07.2017
  audit capability setfcap,					# FIX ME! audit 25.07.2017
  
  # SIGNAL ---------------------------------------------
  signal (send) set=(hup, int, kill, term, cont),		# Реакция на нажатия комбинаций кнопок.
  								# IMPROVE! Отсылать запущенным в этом шеле.
  
  # EXECUTABLES ----------------------------------------
  @{shell}						mr,
  /bin/ls						Cx,
  /bin/ln						Cx,
  /bin/df						Px,
  /bin/rm						Cx,
  /bin/cut						Cx,
  /bin/tty						Px,
  /bin/tr						Px,
  /bin/grep						Cx,
  /bin/ps						Px,
  /bin/env						Cx,
  /bin/sed						Cx,
  /bin/mount						Cx,
  /bin/umount						Cx,
  /bin/sleep						Px,
  /bin/passwd						Px,
  /bin/uname						Px,
  /bin/su						Px,
  /bin/cp						Cx,
  /bin/mv						Cx,
  /bin/chown						Cx,
  /bin/chmod						Cx,
  /bin/nano						Cx,
  /bin/kmod						Px,
  /bin/cat						Cx,
  /bin/dd						Cx,
  /bin/ping						Px,
  /bin/ifconfig						Px,
  /bin/rc-status					Px,
  /bin/date						Px,
  /bin/netstat						Px,
  /bin/getfacl						Px,
  /bin/setfacl						Px,
  /bin/tar						Cx,
  /bin/head						Cx,
  /bin/tail						Cx,
  /bin/getfattr						Px,
  /bin/setfattr						Px,
  /bin/mkdir						Cx,
  /bin/touch						Cx,
  /bin/lsblk						Px,
  /bin/sync						Px,
  /bin/udevadm						Px,
  /bin/dmesg						Px,
  /sbin/mdadm						Px,	# FIX ME! (?) вынести в <local/shell/shell_root.d/>
  /sbin/shutdown					Px,	# sysvinit
  /sbin/{halt,poweroff,reboot}				Px,	# sysvinit
  /sbin/openrc-shutdown					Px,	# openrc-init
  /sbin/cryptsetup					Px,	# FIX ME! (?) вынести в <local/shell/shell_root.d/>
  /sbin/apparmor_parser					Px,
  /sbin/{,c}fdisk					Px,
  /sbin/lvm						Px,	# FIX ME! (?) вынести в <local/shell/shell_root.d/>
  /sbin/e2fsck						Px,
  /sbin/mke2fs						Px,
  /sbin/tune2fs						Px,
  /sbin/resize2fs					Px,
  /sbin/dumpe2fs					Px,
  /sbin/mkswap						Px,
  /sbin/rc-update					Px,
  /sbin/fsck						Px,
  /sbin/rc-service					Px,
  /sbin/xtables-multi					Px,
  /sbin/blkid						Px,
  /usr/bin/which					Px,
  /usr/bin/git						Px -> git_root,	# FIX ME! (?) вынести в <local/shell/shell_root.d/>
  /usr/bin/killall					Px,
  /usr/bin/gsettings					Px,
  /usr/bin/revdep-rebuild				Px,
  /usr/bin/whoami					Px,
  /usr/bin/id						Px,
  /usr/bin/rsync					Cx,
  /usr/bin/htop						Px,
  /usr/bin/mc						Px -> mc_root,
  /usr/bin/eselect					Px,
  /usr/bin/ntpq						Px,
  /usr/bin/stat						Px,
  /usr/bin/file						Cx,
  /usr/bin/lsusb					Px,
  /usr/bin/gpg{,2,-static}				Px,
  /usr/bin/find						Cx,
  /usr/bin/nmap						Px,
  /usr/bin/wget						Px -> wget_root,
  /usr/bin/man						Px,
  /usr/bin/locale					Px,
  /usr/bin/ldd						Px,
  /usr/bin/evmctl					Px,
  /usr/bin/gawk						Cx,
  /usr/bin/patch					Cx,	# FIX ME! (?) вынести в <local/shell/shell_root.d/> (вместе с профилем!)
  /usr/bin/diff						Cx,	# FIX ME! (?) вынести в <local/shell/shell_root.d/> (вместе с профилем!)
  /usr/bin/gcc-config					Px,
  /usr/bin/ck-list-sessions				Px,
  /usr/bin/dig						Px,
  /usr/bin/dircolors					Px,
  /usr/bin/eix						Px,
  /usr/bin/eix-test-obsolete				Px,
  /usr/bin/eix-sync					Px,
  /usr/bin/gpasswd					Px,
  /usr/sbin/gdisk					Px,
  /usr/sbin/smartctl					Px,
  /usr/sbin/useradd					Px,
  /usr/sbin/userdel					Px,
  /usr/sbin/usermod					Px,
  /usr/sbin/groupadd					Px,
  /usr/sbin/groupdel					Px,
  /usr/sbin/lspci					Px,
  /usr/sbin/etc-update					Px,
  /usr/sbin/grub-mkconfig				Px,	# FIX ME! (?) вынести в <local/shell/shell_root.d/>
  /usr/sbin/grub-install				Px,	# FIX ME! (?) вынести в <local/shell/shell_root.d/>
  /usr/sbin/perl-cleaner				Px,
  /usr/sbin/python-updater				Px,
  /usr/sbin/iftop					Px,
  /usr/sbin/nettop					Px,
  /usr/sbin/firewall					Px,
  @{PYTHON_EXEC_WRAPPER}				Px -> python_exec_root,
  /usr/local/bin/**					Px,	# FIX ME! (?) вынести в <local/shell/shell_root.d/>
  /usr/local/sbin/**					Px,	# FIX ME! (?) вынести в <local/shell/shell_root.d/>
  /etc/init.d/*						Px,
  
  # AUDIT EXECUTABLES ----------------------------------
  audit deny /usr/bin/startx*				x,	# RBAC! Запрещаем запуск Xorg-server под root. У нас
  								# нет полноценной ветки профилей для запуска всех
  								# дочерних процессов.
  
  # READS/WRITES ---------------------------------------
  /etc/profile.env					r,
  
  profile ls /bin/ls flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/ls						mr,
  }
  
  profile ln /bin/ln flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/ln						mr,
  }
  
  profile rm /bin/rm flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/rm						mr,
  }
  
  profile cut /bin/cut flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/cut						mr,
  }
  
  profile grep /bin/grep flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # CAPABILITIES -------------------------------------
    capability mknod,
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/grep						mr,
  }
  
  profile env /bin/env flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/env						mr,
  }
  
  profile sed /bin/sed flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/sed						mr,
  }
  
  profile mount /bin/mount flags=(complain) {
    #include <abstractions/base>
    #include <local/mount/shell_root.d/>
    
    # CAPABILITIES -------------------------------------
    capability sys_admin,
    capability dac_override,
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    /sys/devices/virtual/block/@{BLOCK_VIRT}/{,**}	r,
    @{PROC}/@{pid}/mount{s,info}			r,
    
    # EXECUTABLES --------------------------------------
    /bin/mount						mr,
    
    # READS/WRITES -------------------------------------
    /etc/fstab						r,
    /run/mount/utab					rw,
  }
  
  profile umount /bin/umount flags=(complain) {
    #include <abstractions/base>
    #include <local/mount/shell_root.d/>
    
    # CAPABILITIES -------------------------------------
    capability sys_admin,
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    /sys/devices/virtual/block/@{BLOCK_VIRT}/{,**}	r,
    @{PROC}/@{pid}/mountinfo				r,
    
    # EXECUTABLES --------------------------------------
    /bin/umount						mr,
    
    # READS/WRITES -------------------------------------
    /run/mount/utab					rw,
  }
  
  profile cp /bin/cp flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # CAPABILITIES -------------------------------------
    capability fowner,
    capability fsetid,
    capability sys_admin,
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/cp						mr,
  }
  
  profile mv /bin/mv flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/mv						mr,
  }
  
  profile chown /bin/chown flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # CAPABILITIES -------------------------------------
    capability chown,
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/chown						mr,
  }
  
  profile chmod /bin/chmod flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # CAPABILITIES -------------------------------------
    capability fowner,
    capability fsetid,
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/chmod						mr,
  }
  
  profile nano /bin/nano flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/nano						mr,
  }
  
  profile cat /bin/cat flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/cat						mr,
  }
  
  profile dd /bin/dd flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/dd						mr,
  }
  
  profile tar /bin/tar flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # CAPABILITIES -------------------------------------
    capability mknod,
    capability fowner,
    capability fsetid,
    capability chown,
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/tar						mr,
    /bin/bzip2						ix,
    
    # READS/WRITES -------------------------------------
    owner /**						l,
  }
  
  profile head /bin/head flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/head						mr,
  }
  
  profile tail /bin/tail flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/tail						mr,
  }
  
  profile mkdir /bin/mkdir flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/mkdir						mr,
  }
  
  profile touch /bin/touch flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/touch						mr,
  }
  
  profile rsync /usr/bin/rsync flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /usr/bin/rsync					mr,
  }
  
  profile file /usr/bin/file flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /usr/bin/file					mr,
  }
  
  profile find /usr/bin/find flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /usr/bin/find					mr,
  }
  
  profile gawk /usr/bin/gawk flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /usr/bin/gawk					mr,
  }
  
  profile patch /usr/bin/patch flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # CAPABILITIES ---------------------------------------
    capability chown,
    capability fowner,
    capability fsetid,
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /usr/bin/patch					mr,
  }
  
  profile diff /usr/bin/diff flags=(complain) {
    #include <abstractions/base>
    #include <abstractions/fs/access-by-pattern-filemanager>
    #include <abstractions/fs/access-by-pattern-systemusers>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /usr/bin/diff					mr,
  }
}

# профиль специального пользователя root после переключения chroot
profile shell_chroot {
  # Запрещаем работать с базовой системой:
  audit deny /{,*}					xmrwkl,
  audit deny /bin/{,**}					xmrwkl,
  audit deny /boot/{,**}				xmrwkl,
  audit deny /etc/{,**}					xmrwkl,
  audit deny /home/{,**}				xmrwkl,
  audit deny /lib{,32,64}/{,**}				xmrwkl,
  audit deny /media/{,**}				xmrwkl,
  audit deny /mnt/{,**}					xmrwkl,
  audit deny /opt/{,**}					xmrwkl,
  audit deny /@{PROC}/{,**}				xmrwkl,
  audit deny /root/{,**}				xmrwkl,
  audit deny /run/{,**}					xmrwkl,
  audit deny /sbin/{,**}				xmrwkl,
  audit deny /sys/{,**}					xmrwkl,
  audit deny /tmp/{,**}					xmrwkl,
  audit deny /usr/{,**}					xmrwkl,
  audit deny /var/cache/{,**}				xmrwkl,
  audit deny /var/db/{,**}				xmrwkl,
  audit deny /var/empty/{,**}				xmrwkl,
  audit deny /var/lib/{,**}				xmrwkl,
  audit deny /var/log/{,**}				xmrwkl,
  audit deny /var/spool/{,**}				xmrwkl,
  audit deny /var/tmp/{,**}				xmrwkl,
  # IMPROVE! Неявно запрещаем работать со всем в /dev, кроме консоли.
  # Когда будет возможность - запретить явно, с исключениями для консолей.
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  
  # CAPABILITIES ---------------------------------------
  capability chown,
  capability dac_override,
  capability dac_read_search,
  capability fowner,
  capability fsetid,
  capability kill,
  capability setgid,
  capability setuid,
  capability sys_ptrace,
  capability sys_admin,
  capability sys_nice,
  capability sys_resource,
  capability sys_tty_config,
  capability mknod,
  capability setfcap,
  
  # PTRACE ---------------------------------------------
  ptrace (readby, tracedby),
  ptrace (read, trace) peer=@{profile_name},
  
  # SIGNAL ---------------------------------------------
  signal peer=@{profile_name},
  signal (receive, send) set=("exists"),
  signal (receive) set=(hup, int, kill, term, cont, stop),
  
  # UNIX -----------------------------------------------
  unix peer=(label=@{profile_name}),
  unix (create, getattr, getopt, setopt, shutdown),
  
  # DBUS -----------------------------------------------
  
  # MOUNT ----------------------------------------------
  mount fstype=cgroup options=(rw, nosuid, nodev, noexec) tmpfs -> @{CHROOT}/sys/fs/cgroup/portage/,
  
  # NETWORK --------------------------------------------
  network netlink raw,
  network inet dgram,
  network inet6 dgram,
  network inet stream,
  network inet6 stream,
  
  # PSEUDO ---------------------------------------------	# Т.к. мы передаем /dev, /sys, /proc в новый рут, максимально
  								# ограничиваем доступ к этим участкам.
  @{CHROOT}/dev/{,**}					r,
  @{CHROOT}/dev/tty					w,
  @{CHROOT}/dev/tty[0-9]*				rw,
  @{CHROOT}/dev/pts/[0-9]*				rw,
  @{CHROOT}/dev/ptmx					w,
  @{CHROOT}/dev/log					w,
  @{CHROOT}/dev/null					wk,
  @{CHROOT}/dev/zero					w,
  @{CHROOT}/dev/full					w,
  owner @{CHROOT}/dev/shm/**				wl,
  @{CHROOT}/sys/{,**}					r,
  @{CHROOT}/sys/fs/cgroup/portage/{,**}			w,
  @{CHROOT}/@{PROC}/{,**}				r,
  
  # AUDIT PSEUDO ---------------------------------------
  audit deny @{CHROOT}/dev/@{BLOCK_ALL}			wk,	# Запрещаем работать с блочными устройствами.
  
  # EXECUTABLES ----------------------------------------
  @{CHROOT}/@{shell}					mr,
  @{CHROOT}/bin/**					ix,
  @{CHROOT}/etc/**					ix,
  @{CHROOT}/opt/**					ix,
  @{CHROOT}/sbin/**					ix,
  @{CHROOT}/usr/**					ix,
  @{CHROOT}/var/tmp/portage/*/*/**			ix,
  
  # READS/WRITES ---------------------------------------
  @{CHROOT}/{,*}					rwk,
  @{CHROOT}/bin/{,**}					rwkl,
  @{CHROOT}/boot/{,**}					rwkl,
  @{CHROOT}/etc/{,**}					rwkl,
  @{CHROOT}/lib{,32,64}/{,**}				rwkl,
  @{CHROOT}/lib{,32,64}/ld{,32,64}-*.so{,.*}		m,
  @{CHROOT}/lib{,32,64}/**/ld{,32,64}-*.so{,.*}		m,
  @{CHROOT}/lib{,32,64}/lib*.so{,.*}			m,
  @{CHROOT}/lib{,32,64}/**/lib*.so{,.*}			m,
  @{CHROOT}/opt/{,**}					rwkl,
  @{CHROOT}/run/{,**}					rwkl,
  @{CHROOT}/sbin/{,**}					rwkl,
  @{CHROOT}/usr/{,**}					rwkl,
  @{CHROOT}/usr/lib{,32,64}/*.so{,.*}			m,
  @{CHROOT}/usr/lib{,32,64}/**/lib*.so{,.*}		m,
  @{CHROOT}/usr/lib{,32,64}/locale/**			m,
  @{CHROOT}/usr/lib{,32,64}/gconv/*.so			m,
  @{CHROOT}/usr/lib{,32,64}/gconv/gconv-modules*	m,
  @{CHROOT}/usr/src/@{kernel}/tools/gcc/**.so		m,	# Плагины gcc.
  @{CHROOT}/var/{,**}					rwkl,
  
  # USERS ----------------------------------------------
  @{CHROOT}@{HOME}/{,**}				rwk,
  
  # TEMP -----------------------------------------------
  @{CHROOT}/tmp/{,**}					rwk,
  @{CHROOT}/var/tmp/{,**}				rwk,
}
