# ------------------------------------------------------------------
#
#  Copyright (C) 2016,2017 Mikhail Kurinnoi
#
#  This program is free software; you can redistribute it and/or
#  modify it under the terms of version 2 of the GNU General Public
#  License published by the Free Software Foundation.
#
# ------------------------------------------------------------------

#include <local/tunables.d/>

profile wine.wine-wrapper /usr/bin/wine-{any,d3d9,staging,vanilla}-[0-9]* {
  #include <abstractions/base>
  
  # PSEUDO ---------------------------------------------
  /dev/tty						rw,
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  
  # EXECUTABLES ----------------------------------------
  /usr/bin/wine-{any,d3d9,staging,vanilla}-[0-9]*	r,
  @{shell}						mr,
  /usr/lib{,32,64}/wine-{any,d3d9,staging,vanilla}-[0-9]*/bin/wine Px,
  
  # DENY INHERIT ---------------------------------------
  deny network inet,						# local.home.evelauncher
  deny network netlink,						# local.home.evelauncher
  deny unix,							# local.home.evelauncher
  deny /dev/shm/.org.chromium.Chromium.*		rw,	# local.home.evelauncher
  deny @{HOME}/evelauncher/**				r,	# local.home.evelauncher
  deny @{HOME}/.local/share/CCP/**			rw,	# local.home.evelauncher
  deny @{HOME_CACHE}/CCP/**				rw,	# local.home.evelauncher
}

profile wine /usr/{,lib{,32,64}/wine-{any,d3d9,staging,vanilla}-[0-9]*/}bin/wine flags=(attach_disconnected) {
  #include <abstractions/X>
  #include <abstractions/audio>
  #include <abstractions/base>
  #include <abstractions/fonts>
  #include <abstractions/freedesktop.org>
  #include <abstractions/nameservice>
  #include <abstractions/p11-kit>
  #include <abstractions/fs/deny-private-strict>
  #include <local/profile_blocks/wine.d/>
  
  # CAPABILITIES ---------------------------------------
  capability sys_ptrace,
  
  # NETWORK --------------------------------------------
  network netlink raw,
  network inet stream,
  network inet6 stream,
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  @{PROC}/cpuinfo					r,
  @{PROC}/meminfo					r,
  @{PROC}/scsi/scsi					r,
  owner @{PROC}/@{pid}/mem				r,
  
  # EXECUTABLES ----------------------------------------
  /usr/{,lib{,32,64}/wine-{any,d3d9,staging,vanilla}-[0-9]*/}bin/wine mr,
  /usr/{,lib{,32,64}/wine-{any,d3d9,staging,vanilla}-[0-9]*/}bin/ntlm_auth Px,
  /usr/{,lib{,32,64}/wine-{any,d3d9,staging,vanilla}-[0-9]*/}bin/wine-preloader Px,
  /usr{,lib{,32,64}/wine-{any,d3d9,staging,vanilla}-[0-9]*/}/bin/wineserver Px,
  
  # READS/WRITES ---------------------------------------
  /usr/share/wine/**					rk,
  
  # NOISY ----------------------------------------------
  deny /						r,
  
  # DENY INHERIT ---------------------------------------
  deny unix (send, receive) peer=(label="local.home.evelauncher"),	# local.home.evelauncher
  deny /apparmor/.null					rw,	# flags=(attach_disconnected)
}

profile wine.ntlm_auth /usr/{,lib{,32,64}/wine-{any,d3d9,staging,vanilla}-[0-9]*/}bin/ntlm_auth flags=(attach_disconnected) {
  #include <abstractions/base>
  #include <abstractions/fs/deny-private-strict>
  
  # NETWORK --------------------------------------------
  network netlink raw,
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  
  # EXECUTABLES ----------------------------------------
  /usr/{,lib{,32,64}/wine-{any,d3d9,staging,vanilla}-[0-9]*/}bin/ntlm_auth mr,
  
  # READS/WRITES ---------------------------------------
  /usr/share/samba/codepages/**				r,
  
  # DENY INHERIT ---------------------------------------
  deny network inet,						# local.home.evelauncher
  deny /apparmor/.null					rw,	# flags=(attach_disconnected)
  deny /dev/shm/.org.chromium.Chromium.*		rw,	# local.home.evelauncher
  deny @{HOME}/evelauncher/**				r,	# local.home.evelauncher
  deny @{HOME}/.local/share/CCP/**			rw,	# local.home.evelauncher
  deny @{HOME_CACHE}/CCP/**				rw,	# local.home.evelauncher
}

# IMPROVE! В идеале, иметь профиль на каждую программу, см.
# http://wiki.apparmor.net/index.php/AppArmorWine
# Можно реализовать только в случае использования binfmt_misc.
profile wine.wine-preloader /usr/{,lib{,32,64}/wine-{any,d3d9,staging,vanilla}-[0-9]*/}bin/wine-preloader flags=(attach_disconnected) {
  #include <abstractions/X>
  #include <abstractions/audio>
  #include <abstractions/base>
  #include <abstractions/fonts>
  #include <abstractions/freedesktop.org>
  #include <abstractions/nameservice>
  #include <abstractions/ncurses>
  #include <abstractions/p11-kit>
  #include <abstractions/fs/deny-private-strict>
  #include <abstractions/X>
  #include <abstractions/dbus/system-strict>
  #include <abstractions/dbus/udisks>
  #include <abstractions/video>
  #include <local/profile_blocks/wine.d/>
  
  # PTRACE ---------------------------------------------
  ptrace (trace) peer=@{profile_name},
  
  # SIGNAL ---------------------------------------------
  signal (receive) set=(usr1, quit) peer="wine.wineserver",
  
  # UNIX -----------------------------------------------
  unix (send, receive)
  	type=stream
  	peer=(label="wine.wineserver"),
  
  # DBUS -----------------------------------------------
  dbus receive
  	bus=system
  	path="/org/freedesktop/NetworkManager{,/**}"
  	interface="org.freedesktop.DBus.Properties"
  	member=PropertiesChanged
  	peer=(name=":[0-9]*.[0-9]*",label="networkmanager.NetworkManager"),
  
  # NETWORK --------------------------------------------
  network netlink raw,
  network inet dgram,
  network inet6 dgram,
  network inet stream,
  network inet6 stream,
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  owner /dev/shm/#[0-9]*				rw,	# [0-9]* - очень похоже на внутренний PID в wine
  								# (до 6 символов, только цифры), с PID процесса
  								# системы не совпадает.
  /sys/bus/						r,
  /sys/class/						r,
  /sys/class/hidraw/					r,
  /sys/class/scsi_device/				r,
  /sys/devices/system/cpu/cpu*/cpufreq/*		r,
  /sys/devices/system/cpu/cpu*/cache/index*/*		r,
  /sys/devices/system/cpu/cpufreq/policy*/{scaling_cur_freq,scaling_max_freq,cpuinfo_max_freq} r,
  /sys/devices/system/node/**				r,
  /sys/devices/pci[0-9]**/scsi_generic/			r,
  @{PROC}/{cpu,mem}info					r,
  @{PROC}/scsi/scsi					r,
  @{PROC}/@{pid}/stat{,m}				r,
  @{PROC}/@{pid}/mounts					r,
  @{PROC}/@{pid}/net/dev				r,
  @{PROC}/@{pid}/task/@{pid}/stat			r,
  
  # EXECUTABLES ----------------------------------------
  /usr/{,lib{,32,64}/wine-{any,d3d9,staging,vanilla}-[0-9]*/}bin/wine-preloader Pxmr,	# Все правильно, права на запуск и на mmap.
  								# Если будут отдельные профили для программ - изменить.
  /usr/{,lib{,32,64}/wine-{any,d3d9,staging,vanilla}-[0-9]*/}bin/wine mr,
  /usr/{,lib{,32,64}/wine-{any,d3d9,staging,vanilla}-[0-9]*/}bin/ntlm_auth Px,
  /usr/{,lib{,32,64}/wine-{any,d3d9,staging,vanilla}-[0-9]*/}bin/wineserver Px,
  /usr/{,lib{,32,64}/wine-{any,d3d9,staging,vanilla}-[0-9]*/}bin/xdg-open Px,
  
  # READS/WRITES ---------------------------------------
  /etc/mime.types					r,
  /etc/fstab						r,
  /etc/printcap						r,
  /usr/lib{,32,64}/{,wine-{any,d3d9,staging,vanilla}-[0-9]*/}wine/*.so m,
  /usr/share/{,wine-{any,d3d9,staging,vanilla}-[0-9]*/}wine/** rk,
  /usr/share/icons/**					r,
  
  # USERS ----------------------------------------------
  owner @{HOME_CACHE}/winetricks/			r,
  owner @{HOME_CACHE}/winetricks/**			rw,
  
  # TEMP -----------------------------------------------
  owner /tmp/.wine-[0-9]*/server-*-*/{,lock}		r,
  owner /tmp/.wine-[0-9]*/server-*-*/socket		rw,
  
  # NOISY ----------------------------------------------
  deny /						r,
  deny /etc/fstab					r,
  deny /etc/						r,
  deny /usr/local/					r,
  deny /usr/local/lib{,32,64}/				r,
  
  # DENY INHERIT ---------------------------------------
  deny unix (send, receive) peer=(label="local.home.evelauncher"),	# local.home.evelauncher
  deny /apparmor/.null					rw,	# flags=(attach_disconnected)
}

profile wine.wineserver /usr/{,lib{,32,64}/wine-{any,d3d9,staging,vanilla}-[0-9]*/}bin/wineserver flags=(attach_disconnected) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/X-connection-strict>
  #include <abstractions/fs/deny-private-strict>
  #include <local/profile_blocks/wine.d/>
  
  # CAPABILITIES ---------------------------------------
  capability sys_ptrace,
  
  # PTRACE ---------------------------------------------
  ptrace (trace) peer="wine.wine-preloader",
  
  # SIGNAL ---------------------------------------------
  signal (send) set=(usr1, quit) peer="wine.wine-preloader",
  
  # UNIX -----------------------------------------------
  unix (send, receive)
  	type=stream
  	peer=(label="wine.wine-preloader"),
  
  # NETWORK --------------------------------------------
  network netlink raw,
  network inet dgram,
  network inet6 dgram,
  network inet stream,
  network inet6 stream,
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  owner @{PROC}/@{pid}/mem				r,
  
  # EXECUTABLES ----------------------------------------
  /usr/{,lib{,32,64}/wine-{any,d3d9,staging,vanilla}-[0-9]*/}bin/wineserver mr,
  
  # READS/WRITES ---------------------------------------
  /etc/mime.types					r,
  /usr/lib{,32,64}/wine/*.so				m,
  /usr/share/wine/**					rk,
  
  # USERS ----------------------------------------------
  owner @{HOME}/.local/share/icons/hicolor/**		w,
  owner @{HOME_CACHE}/winetricks/			r,
  owner @{HOME_CACHE}/winetricks/**			rw,
  
  # TEMP -----------------------------------------------
  owner /tmp/.wine-[0-9]*/				rw,
  owner /tmp/.wine-[0-9]*/server-*-*/			rw,
  owner /tmp/.wine-[0-9]*/server-*-*/{lock,socket}	rwk,
  owner /tmp/.wine-[0-9]*/server-*-*/anonmap.*		mrw,
  
  # NOISY ----------------------------------------------
  deny /						r,
  deny /media/*/					r,
  deny /mnt/*/						r,
  deny @{HOME}/						r,
  deny /dev/@{BLOCK_REAL}				r,
  
  # DENY INHERIT ---------------------------------------
  deny unix (send, receive) peer=(label="local.home.evelauncher"),	# local.home.evelauncher
  deny /apparmor/.null					rw,	# flags=(attach_disconnected)
}

profile wine.notepad /usr/{,lib{,32,64}/wine-{any,d3d9,staging,vanilla}-[0-9]*/}bin/notepad {
  #include <abstractions/base>
  
  # PSEUDO ---------------------------------------------
  /dev/tty						rw,
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  
  # EXECUTABLES ----------------------------------------
  /usr/{,lib{,32,64}/wine-{any,d3d9,staging,vanilla}-[0-9]*/}bin/notepad r,
  @{shell}						mr,
  /bin/basename						Px,
  /bin/dirname						Px,
  /usr/{,lib{,32,64}/wine-{any,d3d9,staging,vanilla}-[0-9]*/}bin/wine Px,
}

profile wine.winecfg-wrapper /usr/bin/winecfg-{any,d3d9,staging,vanilla}-[0-9]* {
  #include <abstractions/base>
  
  # PSEUDO ---------------------------------------------
  /dev/tty						rw,
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  
  # EXECUTABLES ----------------------------------------
  /usr/bin/winecfg-{any,d3d9,staging,vanilla}-[0-9]*	r,
  @{shell}						mr,
  /usr/lib{,32,64}/wine-{any,d3d9,staging,vanilla}-[0-9]*/bin/winecfg Px,
}

profile wine.winecfg /usr/{,lib{,32,64}/wine-{any,d3d9,staging,vanilla}-[0-9]*/}bin/winecfg {
  #include <abstractions/base>
  
  # PSEUDO ---------------------------------------------
  /dev/tty						rw,
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  
  # EXECUTABLES ----------------------------------------
  /usr/{,lib{,32,64}/wine-{any,d3d9,staging,vanilla}-[0-9]*/}bin/winecfg r,
  @{shell}						mr,
  /bin/basename						Px,
  /bin/dirname						Px,
  /usr/{,lib{,32,64}/wine-{any,d3d9,staging,vanilla}-[0-9]*/}bin/wine Px,
}
