# ------------------------------------------------------------------
#
#  Copyright (C) 2016,2017 Mikhail Kurinnoi
#
#  This program is free software; you can redistribute it and/or
#  modify it under the terms of version 2 of the GNU General Public
#  License published by the Free Software Foundation.
#
# ------------------------------------------------------------------

#include <local/tunables.d/>

# предустановка для abstractions/fs/access-by-user-preset-rwk
@{USERS_DIR_rwk}="[^.]**"
@{USERS_FILE_rwk}="{[^.],.~}*.{odt,ott,oth,odm,ods,ots,sxw,stw,sxg,sxc,stc,odp,odg,otp,sxi,sti,odg,otg,sxd,std,doc,dot,xml,docx,docm,dotx,dotm,wpd,wps,rtf,txt,csv,sdw,sgl,vor,uot,html,htm,uof,jtd,jtt,hwp,602,pdb,psw,xls,xlw,xlt,xlsx,xlsm,xltx,xltm,xlsb,wk1,wks,123,dif,sdc,dbf,slk,uos,pxl,wb2,ppt,pps,pot,pptx,pptm,potx,potm,sda,sdd,sdp,uop,cgm,pdf,bmp,jpeg,jpg,pcx,psd,sgv,wmf,dxf,met,pgm,ras,svm,xbm,emf,pbm,plt,tga,xpm,eps,pcd,png,tif,tiff,gif,pct,ppm,sgf,bas,ODT,OTT,OTH,ODM,ODS,OTS,SXW,STW,SXG,SXC,STC,ODP,ODG,OTP,SXI,STI,ODG,OTG,SXD,STD,DOC,DOT,XML,DOCX,DOCM,DOTX,DOTM,WPD,WPS,RTF,TXT,CSV,SDW,SGL,VOR,UOT,HTML,HTM,UOF,JTD,JTT,HWD,PDB,PSW,XLS,XLW,XLT,XLSX,XLSM,XLTX,XLTM,XLSB,WK1,WKS,DIF,SDC,DBF,SLK,UOS,PXL,WB2,PPT,PPS,POT,PPTX,PPTM,POTX,POTM,SDA,SDD,SDP,UOP,CGM,PDF,BMP,JPEG,JPG,PCX,PSD,SGC,WMF,DXF,MET,PGM,RAS,SVM,XBM,EMF,PBM,PLT,TGA,XPM,EPS,PCD,PNG,TIF,TIFF,GIF,PCT,PPM,SGF,BAS}{,#}"

profile libreoffice /usr/{bin,lib{,32,64}/libreoffice/program}/soffice {
  #include <abstractions/base>
  
  # PSEUDO ---------------------------------------------
  /dev/tty						rw,
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  
  # EXECUTABLES ----------------------------------------
  @{shell}						mr,
  /bin/dirname						Px,	# sys-apps/coreutils
  /bin/basename						Px,	# sys-apps/coreutils
  /bin/grep						Cx,	# sys-apps/grep
  /bin/uname						Px,	# sys-apps/coreutils
  /bin/ls						Cx,	# sys-apps/coreutils
  /bin/sed						Cx,	# sys-apps/sed
  /usr/lib{,32,64}/libreoffice/program/oosplash		Px,
  
  profile ls /bin/ls {
    #include <abstractions/base>
    #include <abstractions/nameservice>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/ls						mr,
  }
  
  profile grep /bin/grep {
    #include <abstractions/base>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/grep						mr,
  }
  
  profile sed /bin/sed {
    #include <abstractions/base>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/sed						mr,
  }
}

profile libreoffice.oosplash /usr/lib{,32,64}/libreoffice/program/oosplash {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/X-connection-strict>
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  @{sys}/devices/virtual/block/@{BLOCK_VIRT}/queue/rotational r,
  
  # EXECUTABLES ----------------------------------------
  /usr/lib{,32,64}/libreoffice/program/oosplash		m,
  /usr/lib{,32,64}/libreoffice/program/javaldx		Px,
  /usr/lib{,32,64}/libreoffice/program/soffice.bin	Px,
  
  # TEMP -----------------------------------------------
  owner /tmp/OSL_PIPE_@{UID}_SingleOfficeIPC_*		rw,	# * - 31(?) символ
}

profile libreoffice.javaldx /usr/lib{,32,64}/libreoffice/program/javaldx {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  
  # EXECUTABLES ----------------------------------------
  /usr/lib{,32,64}/libreoffice/program/javaldx		m,
  /opt/{oracle-jdk,icedtea}-bin-[0-9]*/bin/java		Px,
  /opt/{oracle-jdk,icedtea}-bin-[0-9]*/jre/bin/java	Px,
  
  # USERS ----------------------------------------------
  owner @{HOME}/.config/libreoffice/{,**}		rw,
  owner @{HOME}/.config/libreoffice/{,**/}*		k,
}

profile libreoffice.bin /usr/lib{,32,64}/libreoffice/program/soffice.bin {
  #include <abstractions/base>
  #include <abstractions/freedesktop.org>
  #include <abstractions/fonts>
  #include <abstractions/dconf>
  #include <abstractions/enchant>
  #include <abstractions/gtk>	# Note, LO use its own vcl that can hook up into
  #include <abstractions/qt>	# GTK and QT to draw native controls (widgets).
  #include <abstractions/video>
  #include <abstractions/X>
  #include <abstractions/dbus/system-strict>
  #include <abstractions/dbus/session-strict>
  #include <abstractions/dbus/accessibility-strict>
  #include <abstractions/dbus/at-spi>
  #include <abstractions/dbus/gvfs>
  #include <abstractions/cups-client>
  #include <abstractions/xdg-open>
  #include <abstractions/fs/access-by-users-preset-rwk>
  #include <abstractions/fs/deny-by-pattern-internet>
  #include <abstractions/nameservice>
  #include <abstractions/unix/gvfsd-smb>
  #include <abstractions/unix/gvfsd-smb-virtual>
  #include <abstractions/unix/gvfsd-smb-browse>
  #include <abstractions/unix/gvfsd-trash>
  #include <abstractions/unix/gvfsd-network>
  
  # NETWORK --------------------------------------------
  network inet dgram,
  network inet6 dgram,
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  @{sys}/devices/system/cpu/				r,
  @{PROC}/version					r,
  @{PROC}/sys/vm/mmap_min_addr				r,
  
  # EXECUTABLES ----------------------------------------
  /usr/lib{,32,64}/libreoffice/program/soffice.bin	m,
  @{shell}						Cx,
  /usr/bin/gpgconf					Px,	# app-crypt/gnupg
  /usr/bin/gpg{,2}					Px,	# app-crypt/gnupg
  /usr/bin/gpgsm					Px,	# app-crypt/gnupg
  /opt/{oracle-jdk,icedtea}-bin-[0-9]*/bin/java		Px,
  /opt/{oracle-jdk,icedtea}-bin-[0-9]*/jre/bin/java	Px,
  
  # READS/WRITES ---------------------------------------
  /etc/OpenCL/vendors/{,*}				r,	# x11-drivers/nvidia-drivers (проверять, возможно и другие)
  /usr/lib{,32,64}/libreoffice/{,**}			r,
  /usr/lib{,32,64}/@{PYTHON}/lib-dynload/*.so		m,
  /usr/share/liblangtag/**				r,	# app-text/liblangtag
  /usr/share/libexttextcat/{,*}				r,	# app-text/libexttextcat
  # jre
  /opt/{oracle-jdk,icedtea}-bin-[0-9]*/{,**}		r,
  /opt/{oracle-jdk,icedtea}-bin-[0-9]*/jre/lib/**.so	rm,
  /usr/							r,
  /usr/lib{,32,64}/					r,
  /usr/lib{,32,64}/jvm/{,**}				r,
  
  # USERS ----------------------------------------------
  owner @{HOME}/.config/libreoffice/{,**}		rw,
  owner @{HOME}/.config/libreoffice/{,**/}*		k,
  owner @{HOME}/.languagetool-ooo.cfg			rw,
  owner @{HOME_CACHE}/fontconfig/{,**/}*		k,	# media-libs/fontconfig
  
  # TEMP -----------------------------------------------
  /tmp/							r,
  owner /tmp/@{TMP6}					rwk,	# IMPROVE! Потом работать с xattr, чтобы ограничить только на процесс.
  owner /tmp/lu@{pids}@{TMP6}.tmp/			rw,	# IMPROVE! Потом работать с xattr, чтобы ограничить только на процесс.
  owner /tmp/lu@{pids}@{TMP6}.tmp/lu@{pids}@{TMP6}.tmp	rwk,	# IMPROVE! Потом работать с xattr, чтобы ограничить только на процесс.
  owner /tmp/OSL_PIPE_@{UID}_SingleOfficeIPC_*		rw,	# * - 31(?) символ
  /var/tmp/						r,
  
  # NOISY ----------------------------------------------
  deny /usr/lib{,32,64}/libreoffice/share/uno_packages/cache/* w,
  deny /usr/lib{,32,64}/libreoffice/program/__pycache__/ w,
  deny @{HOME}/.mozilla/firefox/profiles.ini		r,	# www-client/firefox
  
  profile shell @{shell} {
    #include <abstractions/base>
    #include <abstractions/xdg-open>
    #include <abstractions/cups-client>
    
    # PSEUDO -------------------------------------------
    /dev/tty						rw,
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    @{shell}						mr,
    /bin/uname						Px,	# sys-apps/coreutils
    
    # DENY INHERIT -------------------------------------
    deny @{HOME}/.config/libreoffice/**			rw,	# libreoffice.bin
    deny /tmp/*.tmp/*.tmp				rw,	# libreoffice.bin
  }
}
