# ------------------------------------------------------------------
#
#  Copyright (C) 2016-2018 Mikhail Kurinnoi
#
#  This program is free software; you can redistribute it and/or
#  modify it under the terms of version 2 of the GNU General Public
#  License published by the Free Software Foundation.
#
# ------------------------------------------------------------------

#include <local/tunables.d/>

# .odt, .odm, .ods, .odp, .odg
@{local_ext}=[oO][dD][tTmMsSpPgG]
# .ott, .oth, .ots, .otp, .otg
@{local_ext}+=[oO][tT][tThHsSpPgG]
# .sxw, .sxg, .sxc, .sxi, .sxd
@{local_ext}+=[sS][xX][wWgGcCiIdD]
# .stw, .stc, .sti, .std
@{local_ext}+=[sS][tT][wWcCiIdD]
# .doc, .dot
@{local_ext}+=[dD][oO][cCtT]
# .xml
@{local_ext}+=[xX][mM][lL]
# .docx, .docm, .dotx, .dotm
@{local_ext}+=[dD][oO][cCtT][xXmM]
# .wpd, .wps
@{local_ext}+=[wW][pP][dDsS]
# .rtf
@{local_ext}+=[rR][tT][fF]
# .txt
@{local_ext}+=[tT][xX][tT]
# .csv
@{local_ext}+=[cC][sS][vV]
# .sgl, .sgv, .sgf
@{local_ext}+=[sS][gG][lLvVfF]
# .vor
@{local_ext}+=[vV][oO][rR]
# .uot, .uof, .uos, .uop
@{local_ext}+=[uU][oO][tTfFsSpP]
# .htm, .html
@{local_ext}+=[hH][tT][mM]{,[lL]}
# .jtd, .jtt
@{local_ext}+=[jJ][tT][dDtT]
# .hwp
@{local_ext}+=[hH][wW][pP]
# .602
@{local_ext}+=602
# .pdb
@{local_ext}+=[pP][dD][bB]
# .psw
@{local_ext}+=[pP][sS][wW]
# .xls, .xlw, .xlt
@{local_ext}+=[xX][lL][sSwWtT]
# .xlsx, .xlsm, .xltx, .xltm, .xlsb
@{local_ext}+=[xX][lL]{[sStT][xXmM],[sS][bB]}
# .wk1, .wks
@{local_ext}+=[wW][kK][1sS]
# .123
@{local_ext}+=123
# .dif, .dbf
@{local_ext}+=[dD][iIbB][fF]
# .slk
@{local_ext}+=[sS][lL][kK]
# .pxl
@{local_ext}+=[pP][xX][lL]
# .wb2
@{local_ext}+=[wW][bB]2
# .pps, .ppt
@{local_ext}+=[pP][pP][tTsS]
# .pot
@{local_ext}+=[pP][oO][tT]
# .pptx, .pptm, .potx, .potm
@{local_ext}+=[pP][pPoO][tT][xXmM]
# .sdc, .sda, .sdd, .sdp, .sdw
@{local_ext}+=[sS][dD][cCaAdDpPwW]
# .cgm, .pgm
@{local_ext}+=[cCpP][gG][mM]
# .pdf
@{local_ext}+=[pP][dD][fF]
# .bmp
@{local_ext}+=[bB][mM][pP]
# .jpeg, .jpg, .jpe
@{local_ext}+=[jJ][pP]{[eE][gG],[eEgG]}
# .pcx
@{local_ext}+=[pP][cC][xX]
# .psd
@{local_ext}+=[pP][sS][dD]
# .wmf
@{local_ext}+=[wW][mM][fF]
# .dxf
@{local_ext}+=[dD][xX][fF]
# .met
@{local_ext}+=[mM][eE][tT]
# .pbm, .xbm
@{local_ext}+=[pPxX][bB][mM]
# .ras
@{local_ext}+=[rR][aA][sS]
# .svm
@{local_ext}+=[sS][vV][mM]
# .emf
@{local_ext}+=[eE][mM][fF]
# .plt
@{local_ext}+=[pP][lL][tT]
# .tga
@{local_ext}+=[tT][gG][aA]
# .xpm, .ppm
@{local_ext}+=[xXpP][pP][mM]
# .eps
@{local_ext}+=[eE][pP][sS]
# .pcd
@{local_ext}+=[pP][cC][dD]
# .png
@{local_ext}+=[pP][nN][gG]
# .tiff, .tif
@{local_ext}+=[tT][iI][fF]{,[fF]}
# .gif
@{local_ext}+=[gG][iI][fF]
# .pct
@{local_ext}+=[pP][cC][tT]
# .bas
@{local_ext}+=[bB][aA][sS]

# предустановка для abstractions/fs/access-by-user-preset-rwk
@{USERS_DIR_rwk}="[^.]**"
@{USERS_FILE_rwk}="{[^.],.~}*.@{local_ext}{,#}"

profile libreoffice /usr/{bin,lib{,32,64}/libreoffice/program}/soffice {
  #include <abstractions/base>
  
  # PSEUDO ---------------------------------------------
  /dev/tty						rw,
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  
  # EXECUTABLES ----------------------------------------
  @{shell}						mr,
  /bin/dirname						Px,	# sys-apps/coreutils
  /bin/basename						Px,	# sys-apps/coreutils
  /bin/grep						Cx,	# sys-apps/grep
  /bin/uname						Px,	# sys-apps/coreutils
  /bin/ls						Cx,	# sys-apps/coreutils
  /bin/sed						Cx,	# sys-apps/sed
  /usr/lib{,32,64}/libreoffice/program/oosplash		Px,
  
  profile ls /bin/ls {
    #include <abstractions/base>
    #include <abstractions/nameservice>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/ls						mr,
  }
  
  profile grep /bin/grep {
    #include <abstractions/base>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/grep						mr,
  }
  
  profile sed /bin/sed {
    #include <abstractions/base>
    
    # PSEUDO -------------------------------------------
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    /bin/sed						mr,
  }
}

profile libreoffice.oosplash /usr/lib{,32,64}/libreoffice/program/oosplash {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/X-connection-strict>
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  @{SYS_D}/devices/virtual/block/@{BLOCK_VIRT}/queue/rotational r,
  
  # EXECUTABLES ----------------------------------------
  /usr/lib{,32,64}/libreoffice/program/oosplash		m,
  /usr/lib{,32,64}/libreoffice/program/javaldx		Px,
  /usr/lib{,32,64}/libreoffice/program/soffice.bin	Px,
  
  # TEMP -----------------------------------------------
  owner /tmp/OSL_PIPE_@{UID}_SingleOfficeIPC_*		rw,	# * - 31(?) символ
}

profile libreoffice.javaldx /usr/lib{,32,64}/libreoffice/program/javaldx {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  
  # EXECUTABLES ----------------------------------------
  /usr/lib{,32,64}/libreoffice/program/javaldx		m,
  /opt/{oracle-jdk,icedtea}-bin-[0-9]*/bin/java		Px,
  /opt/{oracle-jdk,icedtea}-bin-[0-9]*/jre/bin/java	Px,
  
  # USERS ----------------------------------------------
  owner @{HOME}/.config/libreoffice/{,**}		rw,
  owner @{HOME}/.config/libreoffice/{,**/}*		k,
}

profile libreoffice.bin /usr/lib{,32,64}/libreoffice/program/soffice.bin {
  #include <abstractions/base>
  #include <abstractions/freedesktop.org>
  #include <abstractions/fonts>
  #include <abstractions/dconf>
  #include <abstractions/enchant>
  #include <abstractions/gtk>	# Note, LO use its own vcl that can hook up into
  #include <abstractions/qt>	# GTK and QT to draw native controls (widgets).
  #include <abstractions/video>
  #include <abstractions/X>
  #include <abstractions/dbus/system-strict>
  #include <abstractions/dbus/session-strict>
  #include <abstractions/dbus/accessibility-strict>
  #include <abstractions/dbus/at-spi>
  #include <abstractions/dbus/gvfs>
  #include <abstractions/cups-client>
  #include <abstractions/xdg-open>
  #include <abstractions/fs/access-by-users-preset-rwk>
  #include <abstractions/fs/deny-by-pattern-internet>
  #include <abstractions/nameservice>
  #include <abstractions/unix/gvfsd-smb>
  #include <abstractions/unix/gvfsd-smb-virtual>
  #include <abstractions/unix/gvfsd-smb-browse>
  #include <abstractions/unix/gvfsd-trash>
  #include <abstractions/unix/gvfsd-network>
  
  # NETWORK --------------------------------------------
  network inet dgram,
  network inet6 dgram,
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  @{SYS_D}/devices/system/cpu/				r,
  @{PROC_D}/version					r,
  @{PROC_D}/sys/vm/mmap_min_addr			r,
  
  # EXECUTABLES ----------------------------------------
  /usr/lib{,32,64}/libreoffice/program/soffice.bin	m,
  @{shell}						Cx,
  /usr/bin/gpgconf					Px,	# app-crypt/gnupg
  /usr/bin/gpg{,2}					Px,	# app-crypt/gnupg
  /usr/bin/gpgsm					Px,	# app-crypt/gnupg
  /opt/{oracle-jdk,icedtea}-bin-[0-9]*/bin/java		Px,
  /opt/{oracle-jdk,icedtea}-bin-[0-9]*/jre/bin/java	Px,
  
  # READS/WRITES ---------------------------------------
  /etc/OpenCL/vendors/{,*}				r,	# x11-drivers/nvidia-drivers (проверять, возможно и другие)
  /usr/lib{,32,64}/libreoffice/{,**}			r,
  /usr/lib{,32,64}/@{PYTHON}/lib-dynload/*.so		m,
  /usr/share/liblangtag/**				r,	# app-text/liblangtag
  /usr/share/libexttextcat/{,*}				r,	# app-text/libexttextcat
  # jre
  /opt/{oracle-jdk,icedtea}-bin-[0-9]*/{,**}		r,
  /opt/{oracle-jdk,icedtea}-bin-[0-9]*/jre/lib/**.so	rm,
  /usr/							r,
  /usr/lib{,32,64}/					r,
  /usr/lib{,32,64}/jvm/{,**}				r,
  
  # USERS ----------------------------------------------
  owner @{HOME}/.config/libreoffice/{,**}		rw,
  owner @{HOME}/.config/libreoffice/{,**/}*		k,
  owner @{HOME}/.languagetool-ooo.cfg			rw,
  owner @{HOME_CACHE}/fontconfig/{,**/}*		k,	# media-libs/fontconfig
  
  # TEMP -----------------------------------------------
  /tmp/							r,
  owner /tmp/@{TMP6}					rwk,	# IMPROVE! Потом работать с xattr, чтобы ограничить только на процесс.
  owner /tmp/lu@{pids}@{TMP6}.tmp/			rw,	# IMPROVE! Потом работать с xattr, чтобы ограничить только на процесс.
  owner /tmp/lu@{pids}@{TMP6}.tmp/lu@{pids}@{TMP6}.tmp	rwk,	# IMPROVE! Потом работать с xattr, чтобы ограничить только на процесс.
  owner /tmp/OSL_PIPE_@{UID}_SingleOfficeIPC_*		rw,	# * - 31(?) символ
  /var/tmp/						r,
  
  # NOISY ----------------------------------------------
  deny /usr/lib{,32,64}/libreoffice/share/uno_packages/cache/* w,
  deny @{HOME}/.mozilla/firefox/profiles.ini		r,	# www-client/firefox
  
  profile shell @{shell} {
    #include <abstractions/base>
    #include <abstractions/xdg-open>
    #include <abstractions/cups-client>
    
    # PSEUDO -------------------------------------------
    /dev/tty						rw,
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    @{shell}						mr,
    /bin/uname						Px,	# sys-apps/coreutils
    
    # DENY INHERIT -------------------------------------
    deny @{HOME}/.config/libreoffice/**			rw,	# libreoffice.bin
    deny /tmp/*.tmp/*.tmp				rw,	# libreoffice.bin
  }
}
