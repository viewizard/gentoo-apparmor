# ------------------------------------------------------------------
#
#  Copyright (C) 2016-2018 Mikhail Kurinnoi
#
#  This program is free software; you can redistribute it and/or
#  modify it under the terms of version 2 of the GNU General Public
#  License published by the Free Software Foundation.
#
# ------------------------------------------------------------------

#include <local/tunables.d/>

# .jpeg, .jpg, .jpe
@{local_ext_image}=[jJ][pP]{[eE][gG],[eEgG]}
# .tga
@{local_ext_image}+=[tT][gG][aA]
# .png
@{local_ext_image}+=[pP][nN][gG]
# .bmp
@{local_ext_image}+=[bB][mM][pP]

profile mate-screensaver /usr/bin/mate-screensaver {
  #include <abstractions/base>
  #include <abstractions/freedesktop.org>
  #include <abstractions/fonts>
  #include <abstractions/X>
  #include <abstractions/gtk>
  #include <abstractions/dconf>
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  @{PROC_D}/@{pid}/fd/					r,	# IMPROVE! fsuid=$USER ouid=$USER,root
  
  # EXECUTABLES ----------------------------------------
  /usr/bin/mate-screensaver				mr,
  /usr/libexec/mate-screensaver-dialog			Px,
  /usr/libexec/mate-screensaver-gl-helper		Px,
  /usr/libexec/mate-screensaver/popsquares		Px,
  /usr/libexec/mate-screensaver/floaters		Px,
  /usr/libexec/mate-screensaver/slideshow		Px,
  
  # READS/WRITES ---------------------------------------
  /etc/xdg/menus/mate-screensavers.menu			r,
  /usr/share/mate-screensaver/{,**}			r,
  /usr/share/{,mate/}desktop-directories/{,*.directory}	r,
  
  # USERS ----------------------------------------------
  owner @{HOME}/.local/share/desktop-directories/{,*.directory} r,
}

profile mate-screensaver.sh /usr/bin/mate-screensaver.sh {
  #include <abstractions/base>
  
  # PSEUDO ---------------------------------------------
  /dev/tty						rw,
  
  # EXECUTABLES ----------------------------------------
  /usr/bin/mate-screensaver.sh				r,
  @{shell}						mr,
  /bin/grep						Cx,	# sys-apps/grep
  /bin/sleep						Px,	# sys-apps/coreutils
  /bin/ps						Px,	# sys-process/procps
  /usr/bin/mate-screensaver				Px,
  /usr/bin/xautolock					Px,	# x11-misc/xautolock
  /usr/bin/killall					Px,	# sys-process/psmisc
  /usr/bin/gsettings					Px,	# dev-libs/glib
  
  profile grep /bin/grep flags=(complain) {
    #include <abstractions/base>
    
    # EXECUTABLES --------------------------------------
    /bin/grep						mr,
  }
}

profile mate-screensaver-preferences /usr/bin/mate-screensaver-preferences {
  #include <abstractions/base>
  #include <abstractions/freedesktop.org>
  #include <abstractions/fonts>
  #include <abstractions/X>
  #include <abstractions/gtk>
  #include <abstractions/dconf>
  
  # PSEUDO ---------------------------------------------
  @{PROC_D}/@{pid}/fd/					r,	# IMPROVE! fsuid=$USER ouid=$USER,root
  
  # EXECUTABLES ----------------------------------------
  /usr/bin/mate-screensaver-preferences			mr,
  /usr/libexec/mate-screensaver-gl-helper		Px,
  /usr/libexec/mate-screensaver/popsquares		Px,
  /usr/libexec/mate-screensaver/floaters		Px,
  /usr/libexec/mate-screensaver/slideshow		Px,
  
  # READS/WRITES ---------------------------------------
  /etc/xdg/menus/mate-screensavers.menu			r,
  /usr/share/mate-screensaver/{,**}			r,
  /usr/share/{,mate/}desktop-directories/{,*.directory}	r,
  
  # USERS ----------------------------------------------
  owner @{HOME}/.local/share/desktop-directories/{,*.directory} r,
}

profile mate-screensaver.popsquares /usr/libexec/mate-screensaver/popsquares {
  #include <abstractions/base>
  #include <abstractions/X>
  #include <abstractions/gtk>
  
  # EXECUTABLES ----------------------------------------
  /usr/libexec/mate-screensaver/popsquares		mr,
}

profile mate-screensaver.floaters /usr/libexec/mate-screensaver/floaters {
  #include <abstractions/base>
  #include <abstractions/freedesktop.org>
  #include <abstractions/X>
  #include <abstractions/gtk>
  
  # EXECUTABLES ----------------------------------------
  /usr/libexec/mate-screensaver/floaters		mr,
  
  # READS/WRITES ---------------------------------------
  /usr/share/pixmaps/gnome-logo-white.svg		r,
  /usr/share/pixmaps/mate-logo-white.svg		r,
}

profile mate-screensaver.slideshow /usr/libexec/mate-screensaver/slideshow {
  #include <abstractions/base>
  #include <abstractions/freedesktop.org>
  #include <abstractions/X>
  #include <abstractions/gtk>
  
  # EXECUTABLES ----------------------------------------
  /usr/libexec/mate-screensaver/slideshow		mr,
  
  # READS/WRITES ---------------------------------------
  /usr/share/backgrounds/cosmos/			r,
  /usr/share/backgrounds/cosmos/*.@{local_ext_image}	r,
  /usr/local/share/backgrounds/				r,
  /usr/local/share/backgrounds/*.@{local_ext_image}	r,
}

profile mate-screensaver-gl-helper /usr/libexec/mate-screensaver-gl-helper {
  #include <abstractions/base>
  #include <abstractions/X>
  #include <abstractions/video>
  
  # EXECUTABLES ----------------------------------------
  /usr/libexec/mate-screensaver-gl-helper		mr,
}

profile mate-screensaver-dialog /usr/libexec/mate-screensaver-dialog {
  #include <abstractions/base>
  #include <abstractions/freedesktop.org>
  #include <abstractions/fonts>
  #include <abstractions/X>
  #include <abstractions/gtk>
  #include <abstractions/dconf>
  #include <abstractions/nameservice>
  #include <abstractions/authentication>
  
  # PSEUDO ---------------------------------------------
  @{PROC_D}/@{pid}/fd/					r,	# IMPROVE! fsuid=$USER ouid=$USER,root
  
  # EXECUTABLES ----------------------------------------
  /usr/libexec/mate-screensaver-dialog			mr,
  @{shell}						Cx,
  /sbin/unix_chkpwd					Px,	# sys-libs/pam
  
  # READS/WRITES ---------------------------------------
  /etc/environment					r,	# sys-libs/pam
  /usr/share/mate-screensaver/{,**}			r,
  /run/utmp						rk,
  
  # USERS ----------------------------------------------
  owner @{HOME}/.face					r,
  
  profile shell @{shell} {
    #include <abstractions/base>
    
    # PSEUDO -------------------------------------------
    /dev/tty						rw,
    
    # EXECUTABLES --------------------------------------
    @{shell}						mr,
    /bin/wc						Px -> mate_screensaver_dialog_wc,	# sys-apps/coreutils
    /usr/bin/pidof					Px,	# sys-process/procps
  }
}

# FIX ME! Сейчас (модуль ядра 3.6, утилита 2.11.0) не поддерживаются
# множественные вложенные профили, выносим в отдельный профиль.
profile mate_screensaver_dialog_wc flags=(complain) {
  #include <abstractions/base>
  
  # EXECUTABLES --------------------------------------
  /bin/wc						mr,
}

profile mate-screensaver-command /usr/bin/mate-screensaver-command {
  #include <abstractions/base>
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*						w,
  /dev/pts/[0-9]*					rw,
  
  # EXECUTABLES ----------------------------------------
  /usr/bin/mate-screensaver-command			mr,
}
