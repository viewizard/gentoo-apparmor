# ------------------------------------------------------------------
#
#  Copyright (C) 2016-2018 Mikhail Kurinnoi
#
#  This program is free software; you can redistribute it and/or
#  modify it under the terms of version 2 of the GNU General Public
#  License published by the Free Software Foundation.
#
# ------------------------------------------------------------------

#include <local/tunables.d/>

# IMPROVE! Скрипт запуска для управления доступом к интернету.
# Когда будет реализована работа с портами - убрать.
profile firefox.start_script /usr/bin/firefox {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  
  # PSEUDO ---------------------------------------------
  /dev/tty						rw,
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  
  # EXECUTABLES ----------------------------------------
  /usr/bin/firefox					r,
  @{shell}						mr,
  /usr/bin/id						Px,	# sys-apps/coreutils
  /usr/bin/newgrp					Px,	# sys-apps/shadow
  /usr/lib{,32,64}/firefox/firefox			Px,
}

profile firefox /usr/lib{,32,64}/firefox/firefox{,-bin} {
  #include <abstractions/base>
  #include <abstractions/freedesktop.org>
  #include <abstractions/fonts>
  #include <abstractions/enchant>
  #include <abstractions/audio>
  #include <abstractions/camera>
  #include <abstractions/cups-client>
  #include <abstractions/gtk>
  #include <abstractions/nameservice>
  #include <abstractions/p11-kit>
  #include <abstractions/video>
  #include <abstractions/dconf>
  #include <abstractions/X>
  #include <abstractions/fs/access-by-pattern-internet>
  #include <abstractions/fs/access-strict>
  #include <abstractions/dbus/system-strict>
  #include <abstractions/dbus/session-strict>
  #include <abstractions/dbus/gvfs>
  #include <abstractions/dbus/notifications>
  #include <abstractions/unix/gvfsd-trash>
  #include <abstractions/unix/gvfsd-network>
  #include <abstractions/profile_transitions/users-mime-related>
  #include <local/profile_blocks/firefox.d>
  
  # SIGNAL ---------------------------------------------
  signal (send) set=(kill) peer="firefox.plugin-container",
  
  # UNIX -----------------------------------------------
  unix (send, receive)
  	type=stream
  	peer=(label="firefox.plugin-container"),
  unix (send, receive)
  	type=stream
  	peer=(label="firefox.plugin-container//shell"),
  
  # NETWORK --------------------------------------------
  network netlink raw,
  network inet dgram,
  network inet6 dgram,
  network inet stream,
  network inet6 stream,
  
  # PSEUDO ---------------------------------------------
  /dev/							r,
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  owner /dev/shm/org.chromium.@{TMP6}			rw,	# Нужено для adobe-flash (ppapi).
  								# IMPROVE! Потом работать с xattr, чтобы ограничить только на процесс.
  @{sys}/devices/system/cpu/{,**}			r,
  @{sys}/devices/pci@{PCI2}/@{PCI4}/**/uevent		r,
  @{PROC_D}/						r,
  @{PROC_D}/filesystems					r,
  @{PROC_D}/@{pid}/fd/					r,	# IMPROVE! fsuid=$USER ouid=$USER,root
  @{PROC_D}/@{pid}/mount{s,info}			r,	# IMPROVE! fsuid=$USER ouid=$USER,root
  @{PROC_D}/@{pid}/stat					r,	# IMPROVE! fsuid=$USER ouid=$USER,root
  owner @{PROC_D}/@{pids}/statm				r,
  owner @{PROC_D}/@{pids}/smaps				r,
  audit owner @{PROC_D}/@{pid}/environ			r,	# FIX ME! @{pid}/@{pids} audit 17.10.2017
  audit owner @{PROC_D}/@{pid}/auxv			r,	# FIX ME! @{pid}/@{pids} audit 17.10.2017
  owner @{PROC_D}/@{pid}/cmdline			r,
  @{PROC_D}/@{pid}/task/@{pids}/stat			r,	# IMPROVE! fsuid=$USER ouid=$USER,root
  @{PROC_D}/@{pid}/net/arp				r,	# IMPROVE! fsuid=$USER ouid=$USER,root
  audit @{PROC_D}/@{pid}/net/if_inet6			r,	# FIX ME! @{pid}/@{pids} audit 17.10.2017
  audit @{PROC_D}/@{pid}/net/ipv6_route			r,	# FIX ME! @{pid}/@{pids} audit 17.10.2017
  audit @{PROC_D}/@{pid}/net/dev			r,	# FIX ME! @{pid}/@{pids} audit 17.10.2017
  audit @{PROC_D}/@{pid}/net/wireless			r,	# FIX ME! @{pid}/@{pids} audit 17.10.2017
  
  # EXECUTABLES ----------------------------------------
  /usr/lib{,32,64}/firefox/firefox{,-bin}		mr,
  /bin/ps						Px,	# sys-process/procps
  /bin/uname						Px,	# sys-apps/coreutils
  /bin/basename						Px,	# sys-apps/coreutils
  /bin/dirname						Px,	# sys-apps/coreutils
  /usr/bin/which					Px,	# sys-apps/which
  /usr/lib{,32,64}/firefox/firefox			Px,	# Перезапуск, после установки обновлений.
  /usr/lib{,32,64}/firefox/plugin-container		Px,
  owner @{HOME}/.mozilla/firefox/@{TMP8}.default/extensions/{,**/}* Px,	# Пользовательские расширения.
  /usr/lib{,32,64}/firefox/browser/extensions/{,**/}*	Px,	# Системные расширения.
  
  # READS/WRITES ---------------------------------------
  /etc/							r,
  /etc/lsb-release					r,	# sys-apps/lsb-release
  /etc/mtab						r,
  /etc/fstab						r,
  /etc/mime.types					r,
  /etc/timezone						r,
  /etc/udev/udev.conf					r,	# sys-fs/eudev
  
  # USERS ----------------------------------------------
  owner @{HOME}/.macromedia/**				rw,
  owner @{HOME}/.local/share/gvfs-metadata/home		r,
  owner @{HOME}/.{firefox,mozilla}/{,**}		rw,
  owner @{HOME}/.{firefox,mozilla}/**/*.{db,parentlock,sqlite}* k,
  owner @{HOME}/.{firefox,mozilla}/{,**/}plugins/**/	r,
  owner @{HOME}/.{firefox,mozilla}/{,**/}plugins/{,**/}* mr,	# IMA! Требуется IMA digsig xattr или исключения по fowner в правилах IMA.
  owner @{HOME_CACHE}/mozilla/{,firefox/}		rw,
  owner @{HOME_CACHE}/mozilla/firefox/**		rw,
  owner @{HOME_CACHE}/mozilla/firefox/**/*.sqlite	k,
  
  # TEMP -----------------------------------------------
  /tmp/							r,
  owner /tmp/*						rw,	# Need for download files with any filename.
  								# IMPROVE! Потом работать с xattr, чтобы ограничить только на процесс.
  owner /tmp/mozilla-temp-[0-9]*			rw,	# [0-9]* - 9 цифр
  audit owner /tmp/mozilla_*/{,**}			rw,	# FIX ME! audit 26.11.2017
  owner /tmp/plugtmp{,-[0-9]*}/				rw,
  owner /tmp/plugtmp{,-[0-9]*}/plugin-*			rw,	# * - имя с расширением файла (PL_HD.txt)
  owner /tmp/firefox_@{USER}/{,**}			rw,
  owner /tmp/firefox_@{USER}/{,**/}*			k,
  /var/tmp/						r,
  owner /var/tmp/@{TMP_SQLITE}				rw,	# IMPROVE! Потом работать с xattr, чтобы ограничить только на процесс.
  
  # DENY INHERIT ---------------------------------------
  deny unix peer=(label="nvidia-drivers.nvidia-modprobe"),	# nvidia-drivers.nvidia-modprobe
}

profile firefox.user_extensions @{HOME}/.mozilla/firefox/@{TMP8}.default/extensions/** {
  #include <abstractions/base>
  
  
}

profile firefox.system_extensions /usr/lib{,32,64}/firefox/browser/extensions/** {
  #include <abstractions/base>
  
  
}

profile firefox.plugin-container /usr/lib{,32,64}/firefox/plugin-container {
  #include <abstractions/base>
  #include <abstractions/freedesktop.org>
  #include <abstractions/fonts>
  #include <abstractions/X>
  #include <abstractions/audio>
  #include <abstractions/video>
  #include <abstractions/gtk>
  #include <abstractions/dbus/session-strict>
  #include <abstractions/dbus/gvfs>
  #include <abstractions/dbus/notifications>
  #include <abstractions/nameservice>
  
  # SIGNAL ---------------------------------------------
  signal (receive) set=(kill) peer="firefox",
  
  # UNIX -----------------------------------------------
  unix (send, receive)
  		type=stream
  		peer=(label="firefox"),
  
  # PSEUDO ---------------------------------------------
  /dev/							r,
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  owner /dev/shm/org.chromium.@{TMP6}			rw,	# Нужно для adobe-flash (ppapi).
  								# IMPROVE! Потом работать с xattr, чтобы ограничить только на процесс.
  @{sys}/devices/system/cpu/{,**}			r,
  owner @{PROC_D}/@{pid}/stat				r,
  owner @{PROC_D}/@{pid}/cmdline			r,
  owner @{PROC_D}/@{pid}/task/@{pids}/stat		r,
  
  # EXECUTABLES ----------------------------------------
  /usr/lib{,32,64}/firefox/plugin-container		m,
  @{shell}						Cx,
  
  # READS/WRITES ---------------------------------------
  /etc/ssl/openssl.cnf					r,	# dev-libs/openssl
  
  # USERS ----------------------------------------------
  owner @{HOME}/.adobe/Flash_Player/{,**}		r,
  owner @{HOME}/.macromedia/Flash_Player/{,**}		rw,
  owner @{HOME}/.mozilla/firefox/{,**}			r,
  owner @{HOME}/.config/freshwrapper-data/{,**}		rw,
  
  # TEMP -----------------------------------------------
  /tmp/							r,
  owner /tmp/FreshStream@{TMP6}				rw,
  owner /tmp/FreshTemp@{TMP6}				rw,
  owner /tmp/mozilla-temp-[0-9]*			rw,	# [0-9]* - 9 цифр
  owner /tmp/plugtmp{,-[0-9]*}/				rw,
  owner /tmp/plugtmp{,-[0-9]*}/plugin-*			rw,	# * - имя с расширением файла (PL_HD.txt)
  /var/tmp/						r,
  
  profile shell @{shell} {
    #include <abstractions/base>
    
    # UNIX -----------------------------------------------
    unix (send, receive)
    		type=stream
    		peer=(label="firefox"),
    
    # PSEUDO -------------------------------------------
    /dev/tty						rw,
    /dev/tty[0-9]*					rw,
    /dev/pts/[0-9]*					rw,
    
    # EXECUTABLES --------------------------------------
    @{shell}						mr,
    /bin/ps						Px,	# sys-process/procps
    
    # DENY INHERIT -------------------------------------
    deny /tmp/FreshStream*				rw,	# firefox.plugin-container
  }
}
