# ------------------------------------------------------------------
#
#  Copyright (C) 2016,2017 Mikhail Kurinnoi
#
#  This program is free software; you can redistribute it and/or
#  modify it under the terms of version 2 of the GNU General Public
#  License published by the Free Software Foundation.
#
# ------------------------------------------------------------------

#include <tunables/global>

# FIX ME! Скрипт запуска для управления доступом к интернету
profile firefox.start_script /usr/bin/firefox {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  
  # PSEUDO ---------------------------------------------
  /dev/tty						rw,
  /dev/tty[0-9]*					rw,
  
  # EXECUTABLES ----------------------------------------
  /usr/bin/firefox					r,
  @{shell}						mr,
  /usr/bin/id						Px,
  /usr/bin/newgrp					Px,
  /usr/lib{,32,64}/firefox/firefox			Px,
}

profile firefox /usr/lib{,32,64}/firefox/firefox{,-bin} {
  #include <abstractions/base>
  #include <abstractions/freedesktop.org>
  #include <abstractions/fonts>
  #include <abstractions/enchant>
  #include <abstractions/audio>
  #include <abstractions/camera>
  #include <abstractions/cups-client>
  #include <abstractions/gtk>
  #include <abstractions/nameservice>
  #include <abstractions/p11-kit>
  #include <abstractions/video>
  #include <abstractions/fs/access-by-pattern-internet>
  #include <abstractions/fs/access-strict>
  #include <abstractions/dconf>
  #include <abstractions/X>
  #include <abstractions/dbus/session-strict>
  #include <abstractions/dbus/gvfs>
  #include <abstractions/dbus/notifications>
  #include <abstractions/binary-helper-strict>
  
  # SIGNAL ---------------------------------------------
  signal (send) set=(kill) peer="firefox.plugin-container",
  
  # UNIX -----------------------------------------------
  unix (send, receive)
  	type=stream
  	peer=(label="firefox.plugin-container"),
  unix (send, receive)
  	type=stream
  	peer=(label="firefox.plugin-container//shell"),
  
  # NETWORK --------------------------------------------
  network netlink raw,
  network inet dgram,
  network inet6 dgram,
  network inet stream,
  network inet6 stream,
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  owner /dev/shm/org.chromium.??????			rw,	# Нужено для adobe-flash (ppapi).
  /sys/devices/system/cpu/{,**}				r,
  /sys/devices/pci[0-9]*/**/uevent			r,
  @{PROC}/						r,
  @{PROC}/@{pid}/fd/					r,
  @{PROC}/@{pid}/mountinfo				r,
  @{PROC}/@{pid}/stat					r,
  @{PROC}/@{pid}/net/arp				r,
  owner @{PROC}/@{pid}/task/@{pid}/stat			r,
  @{PROC}/filesystems					r,
  @{PROC}/@{pid}/net/if_inet6				r,
  @{PROC}/@{pid}/net/ipv6_route				r,
  @{PROC}/@{pid}/net/dev				r,
  @{PROC}/@{pid}/net/wireless				r,
  owner @{PROC}/@{pid}/statm				r,
  owner @{PROC}/@{pid}/smaps				r,
  owner @{PROC}/@{pid}/environ				r,
  owner @{PROC}/@{pid}/auxv				r,
  owner @{PROC}/@{pid}/cmdline				r,
  owner @{PROC}/@{pid}/mounts				r,
  
  # EXECUTABLES ----------------------------------------
  /usr/lib{,32,64}/firefox/firefox{,-bin}		mr,
  /bin/ps						Px,
  /bin/uname						Px,
  /bin/basename						Px,
  /bin/dirname						Px,
  /usr/bin/which					Px,
  /usr/lib{,32,64}/firefox/firefox			Px,	# Перезапуск, после установки обновлений.
  /usr/lib{,32,64}/firefox/plugin-container		Px,
  owner @{HOME}/.mozilla/**/extensions/**		Px,	# Пользовательские расширения.
  /usr/lib{,32,64}/firefox/browser/extensions/**	Px,	# Системные расширения.
  
  # READS/WRITES ---------------------------------------
  /etc/							r,
  /etc/lsb-release					r,
  /etc/mtab						r,
  /etc/fstab						r,
  /etc/mime.types					r,
  /etc/timezone						r,
  /etc/udev/udev.conf					r,
  
  # USERS ----------------------------------------------
  owner @{HOME}/.macromedia/**				rw,
  owner @{HOME}/.local/share/gvfs-metadata/home		r,
  owner @{HOME}/.{firefox,mozilla}/{,**}		rw,
  owner @{HOME}/.{firefox,mozilla}/**/*.{db,parentlock,sqlite}* k,
  owner @{HOME}/.{firefox,mozilla}/{,**/}plugins/**	mr,
  owner @{HOME_CACHE}/mozilla/{,firefox/}		rw,
  owner @{HOME_CACHE}/mozilla/firefox/**		rw,
  owner @{HOME_CACHE}/mozilla/firefox/**/*.sqlite	k,
  
  # TEMP -----------------------------------------------
  /tmp/							r,
  owner /tmp/*						rw,	# Need for download files with any filename.
  owner /tmp/plugtmp/					rw,
  owner /tmp/plugtmp/plugin-*				rw,
  owner /tmp/mozilla-temp-*				rw,
  owner /tmp/mozilla_*/{,**}				rw,
  owner /tmp/firefox_*/{,**}				rwk,
  owner /tmp/gnotifier/{,**}				rw,
  /var/tmp/						r,
  owner /var/tmp/etilqs_*				rw,
  
  # DENY INHERIT ---------------------------------------
  deny unix peer=(label="nvidia-drivers.nvidia-modprobe"),		# nvidia-drivers.nvidia-modprobe
}

profile firefox.user_extensions @{HOME}/.mozilla/**/extensions/** {
  #include <abstractions/base>
  
  
}

profile firefox.system_extensions /usr/lib{,32,64}/firefox/browser/extensions/** {
  #include <abstractions/base>
  
  
}

profile firefox.plugin-container /usr/lib{,32,64}/firefox/plugin-container {
  #include <abstractions/base>
  #include <abstractions/freedesktop.org>
  #include <abstractions/fonts>
  #include <abstractions/X>
  #include <abstractions/audio>
  #include <abstractions/video>
  #include <abstractions/gtk>
  #include <abstractions/dbus/session-strict>
  #include <abstractions/dbus/gvfs>
  #include <abstractions/dbus/notifications>
  #include <abstractions/nameservice>
  
  # SIGNAL ---------------------------------------------
  signal (receive) set=(kill) peer="firefox",
  
  # UNIX -----------------------------------------------
  unix (send, receive)
  		type=stream
  		peer=(label="firefox"),
  
  # PSEUDO ---------------------------------------------
  /dev/							r,
  /dev/tty[0-9]						rw,
  owner /dev/shm/org.chromium.??????			rw,	# Нужено для adobe-flash (ppapi).
  /sys/devices/system/cpu/				r,
  owner @{PROC}/@{pid}/stat				r,
  owner @{PROC}/@{pid}/cmdline				r,
  owner @{PROC}/@{pid}/task/@{pid}/stat			r,
  
  # EXECUTABLES ----------------------------------------
  /usr/lib{,32,64}/firefox/plugin-container		m,
  @{shell}						Cx,
  
  # READS/WRITES ---------------------------------------
  /etc/adobe/mms.cfg					r,
  /etc/ssl/openssl.cnf					r,
  
  # USERS ----------------------------------------------
  owner @{HOME}/.adobe/Flash_Player/{,**}		r,
  owner @{HOME}/.macromedia/Flash_Player/{,**}		rw,
  owner @{HOME}/.mozilla/firefox/{,**}			r,
  owner @{HOME}/.config/freshwrapper-data/{,**}		rw,
  
  # TEMP -----------------------------------------------
  /tmp/							r,
  owner /tmp/FreshStream*				rw,
  owner /tmp/FreshTemp*					rw,
  /var/tmp/						r,
  
  profile shell @{shell} {
    #include <abstractions/base>
    
    # UNIX -----------------------------------------------
    unix (send, receive)
    		type=stream
    		peer=(label="firefox"),
    
    # PSEUDO -------------------------------------------
    /dev/tty						rw,
    /dev/tty[0-9]					rw,
    
    # EXECUTABLES --------------------------------------
    @{shell}						mr,
    /bin/ps						Px,
    audit /bin/grep					Px -> firefox_shell_grep,	# FIX ME! audit 28.06.2017
    
    # DENY INHERIT -------------------------------------
    deny /tmp/FreshStream*				rw,	# firefox.plugin-container
  }
}

# FIX ME! Сейчас (модуль ядра 3.6, утилита 2.11.0) не поддерживаются
# множественные вложенные профили, выносим в отдельный профиль.
profile firefox_shell_grep {
  #include <abstractions/base>
  
  # EXECUTABLES ----------------------------------------
  /bin/grep						mr,
}
