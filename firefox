# ------------------------------------------------------------------
#
#  Copyright (C) 2016,2017 Mikhail Kurinnoi
#
#  This program is free software; you can redistribute it and/or
#  modify it under the terms of version 2 of the GNU General Public
#  License published by the Free Software Foundation.
#
# ------------------------------------------------------------------

#include <tunables/global>

# FIX ME! Скрипт запуска для управления доступом к интернету
profile firefox.start_script /usr/bin/firefox {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  
  # PSEUDO ---------------------------------------------
  /dev/tty						rw,
  
  # EXECUTABLES ----------------------------------------
  /usr/bin/firefox					r,
  @{shell}						mr,
  /usr/bin/id						ix,
  /usr/bin/newgrp					Px,
  /usr/lib{,32,64}/firefox/firefox			Px,
}

profile firefox /usr/lib{,32,64}/firefox/firefox{,-bin} {
  #include <abstractions/base>
  #include <abstractions/freedesktop.org>
  #include <abstractions/fonts>
  #include <abstractions/enchant>
  #include <abstractions/audio>
  #include <abstractions/camera>
  #include <abstractions/cups-client>
  #include <abstractions/gtk>
  #include <abstractions/nameservice>
  #include <abstractions/p11-kit>
  #include <abstractions/nvidia>
  #include <abstractions/user-download>
  #include <abstractions/user-upload>
  #include <abstractions/dconf>
  #include <abstractions/X>
  #include <abstractions/executable-binary-helper>
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					w,
  owner /dev/shm/org.chromium.*				rw,
  /sys/devices/system/cpu/{,**}				r,
  /sys/devices/pci[0-9]*/**/uevent			r,
  @{PROC}/						r,
  @{PROC}/@{pid}/fd/					r,
  @{PROC}/@{pid}/mountinfo				r,
  @{PROC}/@{pid}/stat					r,
  @{PROC}/@{pid}/net/arp				r,
  owner @{PROC}/@{pid}/task/@{pid}/stat			r,
  @{PROC}/filesystems					r,
  @{PROC}/@{pid}/net/if_inet6				r,
  @{PROC}/@{pid}/net/ipv6_route				r,
  @{PROC}/@{pid}/net/dev				r,
  @{PROC}/@{pid}/net/wireless				r,
  owner @{PROC}/@{pid}/statm				r,
  owner @{PROC}/@{pid}/smaps				r,
  owner @{PROC}/@{pid}/environ				r,
  owner @{PROC}/@{pid}/auxv				r,
  
  # EXECUTABLES ----------------------------------------
  /usr/lib{,32,64}/firefox/firefox{,-bin}		mr,
  /bin/which						ixr,
  /bin/ps						Pxr,
  /bin/uname						Pxr,
  /sbin/killall5					Pxr,
  /usr/bin/tr						ixr,
  /usr/bin/basename					ixr,
  /usr/bin/dirname					ixr,
  /usr/bin/pwd						ixr,
  /usr/bin/expr						ix,
  /usr/lib{,32,64}/firefox/plugin-container		Px,
  # Allow 'x' for downloaded extensions, but inherit policy for safety
  owner @{HOME}/.mozilla/**/extensions/**		ixmr,
  /usr/lib{,32,64}/firefox/browser/extensions/**	ixmr,
  
  # READS/WRITES ---------------------------------------
  /etc/							r,
  /etc/lsb-release					r,
  /etc/mtab						r,
  /etc/fstab						r,
  /etc/mime.types					r,
  /etc/timezone						r,
  /etc/udev/udev.conf					r,
  
  # USERS ----------------------------------------------
  owner @{HOME}/.macromedia/**				rw,
  owner @{HOME}/.local/share/gvfs-metadata/home		r,
  owner @{HOME}/.{firefox,mozilla}/{,**}		rw,
  owner @{HOME}/.{firefox,mozilla}/**/*.{db,parentlock,sqlite}* k,
  owner @{HOME}/.{firefox,mozilla}/{,**/}plugins/**	mr,
  owner @{HOME_CACHE}/mozilla/{,firefox/}		rw,
  owner @{HOME_CACHE}/mozilla/firefox/**		rw,
  owner @{HOME_CACHE}/mozilla/firefox/**/*.sqlite	k,
  
  # TEMP -----------------------------------------------
  /tmp/							r,
  owner /tmp/*						rw,	# Need for download files with any filename.
  owner /tmp/plugtmp/					rw,
  owner /tmp/plugtmp/plugin-*				rw,
  owner /tmp/mozilla-temp-*				rw,
  owner /tmp/mozilla_*/{,**}				rw,
  owner /tmp/firefox_*/{,**}				rwk,
  owner /tmp/gnotifier/{,**}				rw,
  /var/tmp/						r,
  owner /var/tmp/etilqs_*				rw,
}

profile firefox.plugin-container /usr/lib{,32,64}/firefox/plugin-container {
  #include <abstractions/base>
  #include <abstractions/freedesktop.org>
  #include <abstractions/fonts>
  #include <abstractions/X>
  #include <abstractions/audio>
  #include <abstractions/nvidia>
  #include <abstractions/gtk>
  #include <abstractions/nameservice>
  
  # PSEUDO ---------------------------------------------
  /dev/							r,
  /dev/tty[0-9]						w,
  owner /dev/shm/org.chromium.*				rw,
  /sys/devices/system/cpu/				r,
  owner @{PROC}/@{pid}/stat				r,
  owner @{PROC}/@{pid}/task/@{pid}/stat			r,
  
  # EXECUTABLES ----------------------------------------
  /usr/lib{,32,64}/firefox/plugin-container		m,
  @{shell}						Cx,
  
  # READS/WRITES ---------------------------------------
  /etc/adobe/mms.cfg					r,
  /etc/ssl/openssl.cnf					r,
  
  # USERS ----------------------------------------------
  owner @{HOME}/.adobe/Flash_Player/{,**}		r,
  owner @{HOME}/.macromedia/Flash_Player/{,**}		rw,
  owner @{HOME}/.mozilla/firefox/{,**}			r,
  owner @{HOME}/.config/freshwrapper-data/{,**}		rw,
  
  # TEMP -----------------------------------------------
  /tmp/							r,
  owner /tmp/.gl*					rw,
  owner /tmp/FreshStream*				rw,
  owner /tmp/FreshTemp*					rw,
  /var/tmp/						r,
  
  profile shell @{shell} {
    #include <abstractions/base>
    
    # PSEUDO -------------------------------------------
    /dev/tty						rw,
    /dev/tty[0-9]					w,
    
    # EXECUTABLES --------------------------------------
    @{shell}						mr,
    /bin/ps						Px,
    /bin/grep						ix,
    
    # USERS --------------------------------------------
    owner @{HOME}/.session.log				w,	# XFCE4, <abstractions/X>
  }
}
