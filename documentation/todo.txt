http://wiki.apparmor.net/index.php/Documentation
out of tree patches (kernel) git://kernel.ubuntu.com/jj/apparmor-backports
out of tree patches (user-space) git://git.launchpad.net/~jjohansen/apparmor


- Setuid rules (непонятно когда будет работать)
requires capability setuid
 setuid -> fred,
 setuid -> (fred, george)
2 options:
 setuid rule embedded within the cap making it a limited cap
   capability setuid (fred, george),  remains backwards compat


- confined init (выключение SECURITY_APPARMOR_UNCONFINED_INIT на 22.04.2017 вообще не работает)
# В коде lsm.c ошибка, не похоже, чтобы вообще кто-то собирал ядро без
# SECURITY_APPARMOR_UNCONFINED_INIT (вообще не тестировали похоже)
# Если выключаем SECURITY_APPARMOR_UNCONFINED_INIT не можем выполнить aa-status
# apparmor module is loaded.
# Traceback (most recent call last):
#   File "/usr/lib/python-exec/python3.4/aa-status", line 255, in <module>
#     commands[cmd]()
#   File "/usr/lib/python-exec/python3.4/aa-status", line 59, in cmd_verbose
#     profiles = get_profiles()
#   File "/usr/lib/python-exec/python3.4/aa-status", line 149, in get_profiles
#     profiles[match.group(1)] = match.group(2)
# AttributeError: 'NoneType' object has no attribute 'group'


- extended conditionals
'if' <condition> '{' <rules> '}'
1) Например, через tunables управлять видео, звуком, аутентификацией (kerberos,...) и т.п., открывая только нужное.
2) Устанавливать блоки кода для систем инициализации (openrc, systemd). Пока не понятно, можно ли будет работать с профилями, или только правила профилей (содержанием профилей).
http://wiki.apparmor.net/index.php/AppArmor_Core_Policy_Reference#extended_conditionals


- Stacking (уже доступен с 3.5 версии изменений ядра, 2.11 утилиты) Работает по принципу пересечения профилей (логическое "И" для правил профилей). Непонятно как это будет работать, если у нас все так же ограничение всего на 12 переходов на другие профили.
    /bin/** px -> &two,
Will compute the profile transition as per
    /bin/** px,
and then stack the profile two on top of that transition.
    /bin/** ix -> &two,
is equivalent to
    /bin/** px -> @{profile_name}//&two,
http://wiki.apparmor.net/index.php/AppArmorStacking
http://wiki.apparmor.net/index.php/StackingConfiningUsers


- Delegation (будет примерно в 4-5 версии изменений ядра), т.к. убунтовские патчи убирают 100% делегейшен на открытые ресурсы в дочерний процесс, надо прописывать это отдельно (указывать какие ресурсы открытые в основном процессе может использовать дочерний). Не совсем понятно, когда это будет доступно хотя бы в утилите, но описание уже есть:
1) указываем ресурс для любого профиля который в последствии может быть вызван
	http://wiki.apparmor.net/index.php/AppArmor_Core_Policy_Reference#Delegation
2) при вызове на исполнение, объединение профилей
<path> <qualifier>'x' [[' ->' <profile name>] ['+' <profile name>]] ','
<path> 'x' '->' <profile list> ',' (not yet supported)
http://wiki.apparmor.net/index.php/AppArmorDelegation#How_Delegation_is_Expressed
http://wiki.apparmor.net/index.php/AppArmor_Core_Policy_Reference#Execute_rules
http://wiki.apparmor.net/index.php/AppArmorProfileSpec


- Namespaces. Работают, можно делать переходы, например:
	/bin/sleep	Pxr -> :user:sleep,
но зона видимости профилей - только текущий неймспейс. Т.е. если как в примере перешли в неймспейс :user:, то больше недоступны профили из базового неймспейса. Работает только в иерархической структуре, из неймспейса видно только дочерний (профили в нем).
Возможно, если будет возможность работать с переходами в другие неймспейсы, будет иметь смысл использовать их для RBAC. Сейчас они ориентированны только на создания ограничний для контейнеров (собственно, это основная цель у разработчиков).
** In AppArmor 4 it is possible to have the view be a namespace that is different from the current namespace.
http://wiki.apparmor.net/index.php/AppArmorNamespaces
http://wiki.apparmor.net/index.php/AppArmorStacking#Using_Stacking_in_combination_with_Policy_Namespaces
** the current namespace is always the namespace of the profile in the stack having its permissions evaluated
- Позже сделать для неймспейсов ограничения в base абстракции, чтобы сингалы, и прочее не передавались туда-сюда просто так.


- Using AppArmor to confine and secure X Windows applications (4.0 AppArmor kernel, 2.?? AppArmor user space)
Нужен будет пропатченный иксовый сервер - git://git.launchpad.net/~jjohansen/xorg-server
http://wiki.apparmor.net/index.php/AppArmorXace


- Using AppArmor to confine and secure DConf/GSettings for Desktop applications (вообще непонятно когда будет)
http://wiki.apparmor.net/index.php/AppArmorGSettings


- Базовый deny на неподдерживаемые файлы.
У программ, с явным перечнем расширений, блокировать через deny обращение к открытию файлов не имеющие расширений вообще, начинающиеся с точки. Уменьшить вывод предупреждений в лог.
(?) делать по фиксированным путям, чтобы исключить блокировку нужных файлов?


- portage.emerge улучшение ограничений в следующих версиях AppArmor.
Когда будет введен режим исключения в правилах, откорректировать:
/usr/** rwl, # FIX ME! exclude "/usr/local" with {*^}/{**^}, when this features will be available
/var/** rwk, # FIX ME! exclude "/var/log" (allow only subfolder creation and .keep* files) with {*^}/{**^}, when this features will be available


- network улучшение ограничений в следующих версиях AppArmor.
<address_expr> ::= [('source'|'src') <domain_addr> ['on' <iface>]] [('destination'|'dst' <domain_addr>]
<domain_addr> ::= (<ipv4_addr> | <ipv6_addr> | ..)
 network tcp src 192.168.1.1:80 dst 170.1.1.0:80,
 <ipv4_addr> ::= [<ipv4_??>['/'(<ipv_??>|<num>)]][':'<ports>]
 <ipv4_??> ::= <??_expr>'.'<??_expr>'.'<??_expr>'.'<??_expr>
 <??_expr> ::= (<num>|<range>|'*')
 <ports> ::= (<num>|<range>)(','<num>|<range>])*
 <range> ::= <num> '-' <num>
 192.168.1.1
 192.168.1.1-254
 192.168.1.1:80
 192.168.1.1:80,81
 192.168.1.1:80,81,100-200


- "owner" улучшение ограничений в следующих версиях AppArmor.
extended ownership tests (not currently supported)
 eg.
 owner=fred
 owner=1001
 owner=(fred)
 owner=(fred george)
 owner=(fred 1001)
/etc/apparmor.d/abstractions/authentication, например, хорошо бы сделать с owner=0


- mount улучшение ограничений в следующих версиях AppArmor.
Add the ability for apparmor to do mediation of mount operations. Mount
rules require an updated apparmor_parser (2.8 series) for policy compilation.
The basic form of the rules are.
  [audit] [deny] mount [conds]* [device] [ -> [conds] path],
  [audit] [deny] remount [conds]* [path],
  [audit] [deny] umount [conds]* [path],
  [audit] [deny] pivotroot [oldroot=<value>] <path>
  remount is just a short cut for mount options=remount
  where [conds] can be
    fstype=<expr>
    options=<expr>
Example mount commands
  mount,        # allow all mounts, but not umount or pivotroot
  mount fstype=procfs,  # allow mounting procfs anywhere
  mount options=(bind, ro) /foo -> /bar,  # readonly bind mount
  mount /dev/sda -> /mnt,
  mount /dev/sd** -> /mnt/**,
  mount fstype=overlayfs options=(rw,upperdir=/tmp/upper/,lowerdir=/) -> /mnt/
  umount,
  umount /m*,


