# ------------------------------------------------------------------
#
#  Copyright (C) 2016,2017 Mikhail Kurinnoi
#
#  This program is free software; you can redistribute it and/or
#  modify it under the terms of version 2 of the GNU General Public
#  License published by the Free Software Foundation.
#
# ------------------------------------------------------------------

#include <tunables/global>

profile util-linux.mount /bin/mount flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <local/mount>					# fstab, pam_mount, cryptsetup, udisks и т.п.
  
  # CAPABILITIES ---------------------------------------
  capability sys_admin,
  capability dac_override,
  capability dac_read_search,
  capability chown,
  capability setgid,
  capability setuid,
  
  # MOUNT ----------------------------------------------
  mount
  	options=(rw, nosuid, remount)
  -> /dev/,
  mount
  	fstype=mqueue
  	options=(rw, nosuid, nodev, noexec)
  	mqueue
  -> /dev/mqueue/,
  mount
  	fstype=securityfs
  	options=(rw, nosuid, nodev, noexec)
  	securityfs
  -> /sys/kernel/security/,
  mount
  	fstype=configfs
  	options=(rw, nosuid, nodev, noexec)
  	configfs
  -> /sys/kernel/config/,
  mount
  	fstype=fusectl
  	options=(rw, nosuid, nodev, noexec)
  	fusectl
  -> /sys/fs/fuse/connections/,
  mount
  	fstype=tmpfs
  	options=(rw, nosuid, nodev, noexec)
  	cgroup_root
  -> /sys/fs/cgroup/,
  mount
  	fstype=cgroup
  	options=(rw, nosuid, nodev, noexec)
  	openrc
  -> /sys/fs/cgroup/openrc/,
  mount
  	fstype=cgroup
  	options=(rw, nosuid, nodev, noexec)
  	cpuset
  -> /sys/fs/cgroup/cpuset/,
  mount
  	fstype=cgroup
  	options=(rw, nosuid, nodev, noexec)
  	cpu
  -> /sys/fs/cgroup/cpu/,
  mount
  	fstype=cgroup
  	options=(rw, nosuid, nodev, noexec)
  	cpuacct
  -> /sys/fs/cgroup/cpuacct/,
  mount
  	fstype=cgroup
  	options=(rw, nosuid, nodev, noexec)
  	freezer
  -> /sys/fs/cgroup/freezer/,
  mount
  	fstype=cgroup
  	options=(rw, nosuid, nodev, noexec)
  	net_cls
  -> /sys/fs/cgroup/net_cls/,
  mount
  	fstype=cgroup
  	options=(rw, nosuid, nodev, noexec)
  	tmpfs
  -> /sys/fs/cgroup/portage/,
  
  # PSEUDO ---------------------------------------------
  /dev/							r,
  /dev/tty[0-9]*					rw,
  /dev/console						rw,
  /dev/pts/[0-9]*					rw,
  /dev/@{BLOCK_ALL}					r,
  /dev/loop-control					rw,
  /sys/block/						r,
  /sys/devices/virtual/block/@{BLOCK_VIRT}/{,**}	r,
  /sys/devices/pci[0-9]*/**/{ata,usb}[0-9]*/**/block/@{BLOCK_REAL}/{,**} r,
  @{PROC}/partitions					r,
  @{PROC}/cgroups					r,
  @{PROC}/@{pid}/mountinfo				r,
  
  # EXECUTABLES ----------------------------------------
  /bin/mount						mr,
  /sbin/mount.zfs					Px,
  /usr/bin/ntfs-3g					Px,
  
  # READS/WRITES ---------------------------------------
  /etc/fstab						r,
  /etc/filesystems					r,
  /run/mount/						w,
  /run/mount/utab					rw,
  /run/mount/utab.*					rwk,
  /run/blkid/blkid.tab*					rw,
#  /run/blkid/blkid.tab*				l,	# FIX ME!
  
  # TEMP -----------------------------------------------
  owner /tmp/lynis.cron.*				w,	# DELEGATION! lynis.cron.daily
  owner /tmp/dailyhomebackup.cron.*			w,	# DELEGATION! daily_backup.sh.cron.daily
  owner /tmp/homebackup.cron.*				w,	# DELEGATION! weekly_backup.sh.cron.weekly
  owner /tmp/rootbackup.cron.*				w,	# DELEGATION! monthly_backup.sh.cron.monthly
  
  # DENY INHERIT ---------------------------------------
  deny /etc/conf.d/dmcrypt				r,	# cryptsetup.init.d
}

profile util-linux.umount /bin/umount flags=(complain) {
  #include <abstractions/base>
  
  # CAPABILITIES ---------------------------------------
  capability sys_admin,
  capability chown,
  capability dac_override,
  capability dac_read_search,
  
  # MOUNT ----------------------------------------------
  umount,							# Разрешаем все размонтировать.
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  /dev/console						rw,
  /dev/pts/[0-9]*					rw,
  /sys/devices/virtual/block/@{BLOCK_VIRT}/{,**}	r,
  /sys/devices/pci[0-9]*/**/{ata,usb}[0-9]*/**/block/@{BLOCK_REAL}/{,**} r,
  @{PROC}/@{pid}/mountinfo				r,
  
  # EXECUTABLES ----------------------------------------
  /bin/umount						mr,
  
  # READS/WRITES ---------------------------------------
  /run/mount/utab					rw,
  /run/mount/utab.*					rwk,
  
  # TEMP -----------------------------------------------
  owner /tmp/dailyhomebackup.cron.*			w,	# DELEGATION! daily_backup.sh.cron.daily
  owner /tmp/homebackup.cron.*				w,	# DELEGATION! weekly_backup.sh.cron.weekly
  owner /tmp/rootbackup.cron.*				w,	# DELEGATION! monthly_backup.sh.cron.monthly
  
  # DENY INHERIT ---------------------------------------
  deny @{PROC}/@{pid}/mounts				r,	# lvm2.dmeventd
  deny /etc/conf.d/dmcrypt				r,	# cryptsetup.init.d
  deny /dev/mapper/control				rw,	# lvm2.dmeventd
  deny /run/lvm/lvmetad.socket				rw,	# lvm2.dmeventd
}

profile util-linux.mkswap /sbin/mkswap flags=(complain) {
  #include <abstractions/base>
  
  # CAPABILITIES ---------------------------------------
  capability mknod,
  
  # PSEUDO ---------------------------------------------
  /dev/pts/[0-9]*					rw,
  /dev/@{BLOCK_ALL}					rw,
  /sys/devices/virtual/block/@{BLOCK_VIRT}/{,**}	r,
  /sys/devices/pci[0-9]*/**/{ata,usb}[0-9]*/**/block/@{BLOCK_REAL}/{,**} r,
  @{PROC}/swaps						r,
  @{PROC}/@{pid}/mounts					r,
  
  # EXECUTABLES ----------------------------------------
  /sbin/mkswap						mr,
}

profile util-linux.swapon /sbin/swap{on,off} flags=(complain) {
  #include <abstractions/base>
  
  # CAPABILITIES ---------------------------------------
  capability sys_admin,
  
  # PSEUDO ---------------------------------------------
  /dev/console						rw,
  /dev/pts/[0-9]*					rw,
  /dev/@{BLOCK_ALL}					rw,
  /sys/devices/virtual/block/@{BLOCK_VIRT}/{,**}	r,
  /sys/devices/pci[0-9]*/**/{ata,usb}[0-9]*/**/block/@{BLOCK_REAL}/{,**} r,
  @{PROC}/swaps						r,
  
  # EXECUTABLES ----------------------------------------
  /sbin/swap{on,off}					mr,
  
  # READS/WRITES ---------------------------------------
  /etc/fstab						r,
}

profile util-linux.lsblk /bin/lsblk flags=(complain) {
  #include <abstractions/base>
  
  # PSEUDO ---------------------------------------------
  /dev/pts/[0-9]*					rw,
  /sys/block/						r,
  /sys/devices/pci[0-9]*/**/{ata,usb}[0-9]*/**		r,
  /sys/devices/virtual/block/@{BLOCK_VIRT}/{,**}	r,
  @{PROC}/swaps 					r,
  @{PROC}/@{pid}/mountinfo				r,
  
  # EXECUTABLES ----------------------------------------
  /bin/lsblk						mr,
  
  # READS/WRITES ---------------------------------------
  /etc/udev/udev.conf					r,
  /run/udev/data/*:[0-9]*				r,
  /run/mount/utab					r,
  
  # TEMP -----------------------------------------------
  owner /tmp/dailyhomebackup.cron.*			w,	# DELEGATION! daily_backup.sh.cron.daily
  owner /tmp/homebackup.cron.*				w,	# DELEGATION! weekly_backup.sh.cron.weekly
  owner /tmp/rootbackup.cron.*				w,	# DELEGATION! monthly_backup.sh.cron.monthly
}

profile util-linux.agetty /sbin/agetty {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  
  # CAPABILITIES ---------------------------------------
  capability sys_admin,
  capability sys_tty_config,
  capability fsetid,
  capability chown,
  capability dac_override,
  capability dac_read_search,
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  /dev/console						rw,
  
  # EXECUTABLES ----------------------------------------
  /sbin/agetty						mr,
  /bin/login						Px,
  
  # READS/WRITES ---------------------------------------
  /etc/issue						r,
  /run/utmp						rwk,
  /run/agetty.reload					rw,
  /var/log/wtmp						wk,
}

profile util-linux.fsck /sbin/fsck flags=(complain) {
  #include <abstractions/base>
  
  # PSEUDO ---------------------------------------------
  /dev/							r,
  /dev/console						rw,
  /dev/pts/[0-9]*					rw,
  /dev/@{BLOCK_ALL}					r,
  /sys/block/						r,
  /sys/devices/virtual/block/@{BLOCK_VIRT}/{,**}	r,
  /sys/devices/pci[0-9]*/**/{ata,usb}[0-9]*/**/block/@{BLOCK_REAL}/{,**} r,
  @{PROC}/partitions					r,
  
  # EXECUTABLES ----------------------------------------
  /sbin/fsck						mr,
  /sbin/e2fsck						Px,
  /usr/sbin/fsck.fat					Px,
  
  # READS/WRITES ---------------------------------------
  /etc/fstab						r,
  /run/blkid/blkid.tab*					rw,
  link subset /run/blkid/blkid.tab*			-> /run/blkid/blkid.tab*,
}

profile util-linux.hwclock /sbin/hwclock flags=(complain) {
  #include <abstractions/base>
  
  # CAPABILITIES ---------------------------------------
  capability sys_time,
  
  # PSEUDO ---------------------------------------------
  /dev/console						rw,
  /dev/rtc0						rw,
  
  # EXECUTABLES ----------------------------------------
  /sbin/hwclock						mr,
}

profile util-linux.logger /usr/bin/logger flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  
  # PSEUDO ---------------------------------------------
  /dev/pts/[0-9]*					rw,
  @{PROC}/@{pid}/loginuid r,
  
  # EXECUTABLES ----------------------------------------
  /usr/bin/logger					mr,
}

profile util-linux.fdisk /sbin/{,c}fdisk flags=(complain) {
  #include <abstractions/base>
  
  # PSEUDO ---------------------------------------------
  /dev/pts/[0-9]*					rw,
  /dev/@{BLOCK_ALL}					rw,
  /sys/devices/virtual/block/@{BLOCK_VIRT}/{,**}	r,
  /sys/devices/pci[0-9]*/**/{ata,usb}[0-9]*/**/block/@{BLOCK_REAL}/{,**} r,
  
  # EXECUTABLES ----------------------------------------
  /sbin/{,c}fdisk					mr,
  
  # READS/WRITES ---------------------------------------
  /etc/terminfo/x/xterm					r,
}

profile util-linux.eject /usr/bin/eject flags=(complain) {
  #include <abstractions/base>
  
  # CAPABILITIES ---------------------------------------
  capability sys_rawio,
  capability sys_admin,
  
  # PSEUDO ---------------------------------------------
  /dev/@{BLOCK_REAL}					rw,
  /sys/devices/virtual/block/@{BLOCK_VIRT}/{,**}	r,
  /sys/devices/pci[0-9]*/**/{ata,usb}[0-9]*/**/block/@{BLOCK_REAL}/{,**} r,
  @{PROC}/@{pid}/mountinfo				r,
  
  # EXECUTABLES ----------------------------------------
  /usr/bin/eject					mr,
  
  # READS/WRITES ---------------------------------------
  /run/mount/utab					r,
}

profile util-linux.blkid /sbin/blkid flags=(complain) {
  #include <abstractions/base>
  
  # CAPABILITIES ---------------------------------------
  capability mknod,
  
  # PSEUDO ---------------------------------------------
  /dev/							r,
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  /dev/@{BLOCK_ALL}					r,
  /sys/block/						r,
  /sys/devices/virtual/block/**				r,
  /sys/devices/pci[0-9]*/**/{ata,usb}[0-9]*/**/block/**	r,
  @{PROC}/partitions					r,
  
  # EXECUTABLES ----------------------------------------
  /sbin/blkid						mr,
  
  # READS/WRITES ---------------------------------------
  /run/blkid/blkid.tab*					rw,
  link subset /run/blkid/blkid.tab*			-> /run/blkid/blkid.tab*,
}

profile util-linux.switch_root /sbin/switch_root flags=(complain) {
  #include <abstractions/base>
  
  # EXECUTABLES ----------------------------------------
  /sbin/switch_root					mr,
  /sbin/init						Px,
}

profile util-linux.blockdev /sbin/blockdev flags=(complain) {
  #include <abstractions/base>
  
  # PSEUDO ---------------------------------------------
  /dev/@{BLOCK_ALL}					r,
  
  # EXECUTABLES ----------------------------------------
  /sbin/blockdev					mr,
}
