# ------------------------------------------------------------------
#
#    Copyright (C) 2016 Mikhail Kurinnoi
#
#    This program is free software; you can redistribute it and/or
#    modify it under the terms of version 2 of the GNU General Public
#    License published by the Free Software Foundation.
#
# ------------------------------------------------------------------

#include <tunables/global>
profile util-linux.mount /bin/mount flags=(complain) {
  #include <abstractions/base>
  
  capability sys_admin,
  capability dac_override,
  capability dac_read_search,
  capability chown,
  capability setgid,
  capability setuid,
  
  /dev/tty[0-9]* w,
  /dev/pts/[0-9]* w,
  /dev/sd[a-z]{,[0-9]*} r,
  /dev/dm-[0-9]* r,
  /sys/devices/pci[0-9]*/**/block/sd[a-z]/{,dev} r,
  /sys/devices/pci[0-9]*/**/block/sd[a-z]/sd[a-z][0-9]*/{,size,start} r,
  /sys/devices/virtual/block/dm-[0-9]*/ r,
  /sys/devices/virtual/block/dm-[0-9]*/dm/{name,uuid} r,
  @{PROC}/@{pid}/mountinfo r,
  
  /bin/mount mr,
  /sbin/mount.zfs Px,
  /usr/bin/ntfs-3g Px,
  
  /etc/fstab r,
  
  /run/mount/ w,
  /run/mount/utab rw,
  /run/mount/utab.* rwk,
  
}


profile util-linux.umount /bin/umount flags=(complain) {
  #include <abstractions/base>
  
  capability sys_admin,
  capability chown,
  capability dac_override,
  capability dac_read_search,
  
  /dev/tty[0-9]* w,
  /dev/pts/[0-9]* w,
  /sys/devices/virtual/block/dm-*/dm/name r,
  @{PROC}/@{pid}/mountinfo r,
  
  /bin/umount mr,
  
  /run/mount/utab rw,
  /run/mount/utab.* rwk,
  
}


profile util-linux.mkswap /sbin/mkswap flags=(complain) {
  #include <abstractions/base>
  
  /dev/pts/[0-9]* w,
  /dev/{dm-,loop,md,sd[a-z],zd}[0-9]* rw,
  /sys/devices/virtual/block/dm-[0-9]*/ r,
  /sys/devices/virtual/block/dm-[0-9]*/dm/uuid r,
  
  @{PROC}/swaps r,
  @{PROC}/@{pid}/mounts r,
  
  /sbin/mkswap mr,
  
}


profile util-linux.swapon /sbin/swap{on,off} flags=(complain) {
  #include <abstractions/base>
  
  capability sys_admin,
  
  /dev/{dm-,loop,md,sd[a-z],zd}[0-9]* rw,
  /sys/devices/virtual/block/dm-[0-9]*/dm/name r,
  @{PROC}/swaps r,
  
  /sbin/swap{on,off} mr,
  
  /etc/fstab r,
  
}


profile util-linux.lsblk /bin/lsblk flags=(complain) {
  #include <abstractions/base>
  
  /dev/pts/[0-9]* w,
  /sys/block/ r,
  /sys/devices/pci[0-9]*/**/{ata,usb}[0-9]*/**/type r,
  /sys/devices/pci[0-9]*/**/{ata,usb}[0-9]*/**/block/{sd[a-z],sr[0-9]*}/{,**} r,
  /sys/devices/virtual/block/md[0-9]*/{,**} r,
  /sys/devices/virtual/block/{dm-,loop,zd}[0-9]*/{,**} r,
  @{PROC}/swaps r,
  @{PROC}/@{pid}/mountinfo r,
  
  /bin/lsblk mr,
  
}


profile util-linux.agetty /sbin/agetty {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  
  capability sys_admin,
  capability sys_tty_config,
  capability fsetid,
  capability chown,
  capability dac_override,
  capability dac_read_search,
  
  /dev/tty[0-9]* rw,
  
  /sbin/agetty mr,
  /bin/login Px,
  
  /etc/issue r,
  
  /run/utmp rwk,
  /run/agetty.reload rw,
  /var/log/wtmp wk,
  
}


profile util-linux.fsck /sbin/fsck flags=(complain) {
  #include <abstractions/base>
  
  /dev/pts/[0-9]* w,
  /dev/sd{[a-z],[a-z][0-9]*} r,
  /sys/devices/virtual/block/dm-[0-9]*/{,**} r,
  /sys/devices/pci[0-9]*/**/{ata,usb}[0-9]*/**/block/sd[a-z]/{,**} r,
  
  /sbin/fsck mr,
  /sbin/e2fsck Px,
  /usr/sbin/fsck.fat Px,
  
  /etc/fstab r,
  
}


profile util-linux.hwclock /sbin/hwclock flags=(complain) {
  #include <abstractions/base>
  
  capability sys_time,
  
  /dev/rtc0 rw,
  
  /sbin/hwclock mr,
  
}


profile util-linux.logger /usr/bin/logger flags=(complain) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  
  @{PROC}/@{pid}/loginuid r,
  
  /usr/bin/logger mr,
  
}


profile util-linux.fdisk /sbin/{,c}fdisk flags=(complain) {
  #include <abstractions/base>
  
  /dev/pts/[0-9]* rw,
  /dev/dm-[0-9]* rw,
  /sys/devices/virtual/block/dm-[0-9]*/ r,
  /sys/devices/virtual/block/dm-[0-9]*/dm/uuid r,
  
  /sbin/{,c}fdisk mr,
  
  /etc/terminfo/x/xterm r,
  
}


profile util-linux.eject /usr/bin/eject flags=(complain) {
  #include <abstractions/base>
  
  capability sys_rawio,
  capability sys_admin,
  
  /dev/sd[a-z] rw,
  /sys/devices/virtual/block/dm-[0-9]*/dm/name r,
  /sys/devices/pci[0-9]*/**/usb[0-9]*/**/block/sd[a-z]/{,removable} r,
  @{PROC}/@{pid}/mountinfo r,
  
  /usr/bin/eject mr,
  
}
