# ------------------------------------------------------------------
#
#  Copyright (C) 2016,2017 Mikhail Kurinnoi
#
#  This program is free software; you can redistribute it and/or
#  modify it under the terms of version 2 of the GNU General Public
#  License published by the Free Software Foundation.
#
# ------------------------------------------------------------------

#include <local/tunables.d/>

profile util-linux.mkswap /sbin/mkswap {
  #include <abstractions/base>
  
  # CAPABILITIES ---------------------------------------
  capability mknod,
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  /dev/@{BLOCK_ALL}					rw,
  /sys/devices/virtual/block/@{BLOCK_VIRT}/{,**}	r,
  /sys/devices/pci[0-9]*/**/{ata,usb}[0-9]*/**/block/@{BLOCK_REAL}/{,**} r,
  @{PROC}/swaps						r,
  audit @{PROC}/@{pid}/mounts				r,	# FIX ME! @{pid}/@{pids} audit 20.10.2017
  
  # EXECUTABLES ----------------------------------------
  /sbin/mkswap						mr,
}

profile util-linux.swapon /sbin/swap{on,off} {
  #include <abstractions/base>
  
  # CAPABILITIES ---------------------------------------
  capability sys_admin,
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  /dev/console						rw,
  /dev/pts/[0-9]*					rw,
  /dev/@{BLOCK_ALL}					rw,
  /sys/devices/virtual/block/@{BLOCK_VIRT}/{,**}	r,
  /sys/devices/pci[0-9]*/**/{ata,usb}[0-9]*/**/block/@{BLOCK_REAL}/{,**} r,
  @{PROC}/swaps						r,
  
  # EXECUTABLES ----------------------------------------
  /sbin/swap{on,off}					mr,
  
  # READS/WRITES ---------------------------------------
  /etc/fstab						r,
}

profile util-linux.lsblk /bin/lsblk {
  #include <abstractions/base>
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  /sys/block/						r,
  /sys/devices/pci[0-9]*/**/{ata,usb}[0-9]*/**		r,
  /sys/devices/virtual/block/@{BLOCK_VIRT}/{,**}	r,
  @{PROC}/swaps 					r,
  owner @{PROC}/@{pid}/mountinfo			r,
  
  # EXECUTABLES ----------------------------------------
  /bin/lsblk						mr,
  
  # READS/WRITES ---------------------------------------
  /etc/udev/udev.conf					r,
  /run/udev/data/*:[0-9]*				r,
  /run/mount/utab					r,
  
  # TEMP -----------------------------------------------
  owner /tmp/dailyhomebackup.cron.*			w,	# DELEGATION! backup_daily.sh.cron.daily
  owner /tmp/rootbackup.cron.*				w,	# DELEGATION! backup_weekly.sh.cron.weekly
}

profile util-linux.agetty /sbin/agetty {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  
  # CAPABILITIES ---------------------------------------
  capability sys_admin,
  capability sys_tty_config,
  capability fsetid,
  capability chown,
  capability dac_override,
  capability dac_read_search,
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  /dev/console						rw,
  
  # EXECUTABLES ----------------------------------------
  /sbin/agetty						mr,
  /bin/login						Px,
  
  # READS/WRITES ---------------------------------------
  /etc/issue						r,
  /run/utmp						rwk,
  /run/agetty.reload					rw,
  /var/log/wtmp						wk,
}

profile util-linux.fsck /sbin/fsck {
  #include <abstractions/base>
  
  # PSEUDO ---------------------------------------------
  /dev/							r,
  /dev/tty[0-9]*					rw,
  /dev/console						rw,
  /dev/pts/[0-9]*					rw,
  /dev/@{BLOCK_ALL}					r,
  /sys/block/						r,
  /sys/devices/virtual/block/@{BLOCK_VIRT}/{,**}	r,
  /sys/devices/pci[0-9]*/**/{ata,usb}[0-9]*/**/block/@{BLOCK_REAL}/{,**} r,
  @{PROC}/partitions					r,
  
  # EXECUTABLES ----------------------------------------
  /sbin/fsck						mr,
  /sbin/e2fsck						Px,
  /usr/sbin/fsck.fat					Px,
  
  # READS/WRITES ---------------------------------------
  /etc/fstab						r,
  /run/blkid/blkid.tab*					rw,
  link subset /run/blkid/blkid.tab*			-> /run/blkid/blkid.tab*,
}

profile util-linux.hwclock /sbin/hwclock {
  #include <abstractions/base>
  
  # CAPABILITIES ---------------------------------------
  capability sys_time,
  
  # PSEUDO ---------------------------------------------
  /dev/console						rw,
  /dev/rtc0						rw,
  
  # EXECUTABLES ----------------------------------------
  /sbin/hwclock						mr,
}

profile util-linux.logger /usr/bin/logger {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  owner @{PROC}/@{pid}/loginuid				r,
  
  # EXECUTABLES ----------------------------------------
  /usr/bin/logger					mr,
}

profile util-linux.fdisk /sbin/{,c}fdisk {
  #include <abstractions/base>
  #include <abstractions/ncurses>
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  /dev/@{BLOCK_ALL}					rw,
  /sys/devices/virtual/block/@{BLOCK_VIRT}/{,**}	r,
  /sys/devices/pci[0-9]*/**/{ata,usb}[0-9]*/**/block/@{BLOCK_REAL}/{,**} r,
  @{PROC}/partitions					r,
  
  # EXECUTABLES ----------------------------------------
  /sbin/{,c}fdisk					mr,
}

profile util-linux.eject /usr/bin/eject {
  #include <abstractions/base>
  
  # CAPABILITIES ---------------------------------------
  capability sys_rawio,
  capability sys_admin,
  
  # PSEUDO ---------------------------------------------
  /dev/@{BLOCK_REAL}					rw,
  /sys/devices/virtual/block/@{BLOCK_VIRT}/{,**}	r,
  /sys/devices/pci[0-9]*/**/{ata,usb}[0-9]*/**/block/@{BLOCK_REAL}/{,**} r,
  owner @{PROC}/@{pid}/mountinfo			r,
  
  # EXECUTABLES ----------------------------------------
  /usr/bin/eject					mr,
  
  # READS/WRITES ---------------------------------------
  /run/mount/utab					r,
}

profile util-linux.blkid /sbin/blkid {
  #include <abstractions/base>
  
  # CAPABILITIES ---------------------------------------
  capability mknod,
  capability sys_rawio,
  
  # PSEUDO ---------------------------------------------
  /dev/							r,
  /dev/tty						rw,
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  /dev/@{BLOCK_ALL}					r,
  /sys/block/						r,
  /sys/devices/virtual/block/**				r,
  /sys/devices/pci[0-9]*/**/{ata,usb}[0-9]*/**/block/**	r,
  @{PROC}/partitions					r,
  
  # EXECUTABLES ----------------------------------------
  /sbin/blkid						mr,
  
  # READS/WRITES ---------------------------------------
  /run/blkid/blkid.tab*					rw,
  link subset /run/blkid/blkid.tab*			-> /run/blkid/blkid.tab*,
}

profile util-linux.switch_root /sbin/switch_root {
  #include <abstractions/base>
  
  # EXECUTABLES ----------------------------------------
  /sbin/switch_root					mr,
  /sbin/init						Px,
}

profile util-linux.blockdev /sbin/blockdev {
  #include <abstractions/base>
  
  # PSEUDO ---------------------------------------------
  /dev/@{BLOCK_ALL}					r,
  
  # EXECUTABLES ----------------------------------------
  /sbin/blockdev					mr,
}

profile util-linux.mcookie /usr/bin/mcookie {
  #include <abstractions/base>
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  
  # EXECUTABLES ----------------------------------------
  /usr/bin/mcookie					mr,
}

profile util-linux.cal /usr/bin/cal {
  #include <abstractions/base>
  #include <abstractions/ncurses>
  
  # PSEUDO ---------------------------------------------
  /dev/tty						rw,
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  
  # EXECUTABLES ----------------------------------------
  /usr/bin/cal						mr,
  
  # DENY INHERIT ---------------------------------------
  deny network inet dgram,					# conky_shell
  deny network inet6 dgram,					# conky_shell
  deny @{PROC}/uptime					r,	# conky_shell
  deny @{PROC}/@{pids}/net/dev				r,	# conky_shell
}

profile util-linux.getopt /usr/bin/getopt flags=(attach_disconnected) {
  #include <abstractions/base>
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  
  # EXECUTABLES ----------------------------------------
  /usr/bin/getopt					mr,
  
  # DENY INHERIT ---------------------------------------
  deny /apparmor/.null					rw,	# flags=(attach_disconnected)
}

profile util-linux.dmesg /bin/dmesg {
  #include <abstractions/base>
  
  # CAPABILITIES ---------------------------------------
  capability syslog,
  
  # PSEUDO ---------------------------------------------
  /dev/kmsg						r,
  /dev/tty[0-9]*					rw,
  /dev/console						rw,
  /dev/pts/[0-9]*					rw,
  
  # EXECUTABLES ----------------------------------------
  /bin/dmesg						mr,
  
  # READS/WRITES ---------------------------------------
  # В общем профиле доступ к файлам (для параметра --file) не даем.
  /var/log/dmesg					w,	# openrc.bootmisc.init.d
}

profile util-linux.renice /usr/bin/renice {
  #include <abstractions/base>
  
  # CAPABILITIES ---------------------------------------
  capability mknod,
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  
  # EXECUTABLES ----------------------------------------
  /usr/bin/renice					mr,
}

profile util-linux.wipefs /sbin/wipefs {
  #include <abstractions/base>
  
  # PSEUDO ---------------------------------------------
  /dev/@{BLOCK_ALL}					rw,
  /sys/devices/virtual/block/@{BLOCK_VIRT}/{,**}	r,
  /sys/devices/pci[0-9]*/**/{ata,usb}[0-9]*/**/block/@{BLOCK_REAL}/{,**} r,
  
  # EXECUTABLES ----------------------------------------
  /sbin/wipefs						mr,
}

profile util-linux.sfdisk /sbin/sfdisk {
  #include <abstractions/base>
  
  # CAPABILITIES ---------------------------------------
  capability sys_admin,
  
  # PSEUDO ---------------------------------------------
  /dev/@{BLOCK_ALL}					rw,
  /sys/devices/virtual/block/@{BLOCK_VIRT}/{,**}	r,
  /sys/devices/pci[0-9]*/**/{ata,usb}[0-9]*/**/block/@{BLOCK_REAL}/{,**} r,
  
  # EXECUTABLES ----------------------------------------
  /sbin/sfdisk						mr,
}
