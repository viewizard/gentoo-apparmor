# ------------------------------------------------------------------
#
#  Copyright (C) 2016,2017 Mikhail Kurinnoi
#
#  This program is free software; you can redistribute it and/or
#  modify it under the terms of version 2 of the GNU General Public
#  License published by the Free Software Foundation.
#
# ------------------------------------------------------------------

#include <tunables/global>

profile apparmor-utils.aa-status @{PYTHON_EXEC}/aa-status {
  #include <abstractions/base>
  #include <abstractions/python>
  
  # CAPABILITIES ---------------------------------------
  capability sys_ptrace,
  
  # PSEUDO ---------------------------------------------
  /dev/pts/[0-9]*					w,
  /sys/kernel/security/apparmor/*			r,
  @{PROC}/						r,
  @{PROC}/@{pid}/attr/{current,prev,exec}		r,
  @{PROC}/@{pid}/mounts					r,
  
  # READS/WRITES ---------------------------------------
  @{PYTHON_PACKAGES}/apparmor/**.pyc{,.*}		w,
}

profile apparmor-utils.aa-unconfined @{PYTHON_EXEC}/aa-unconfined {
  #include <abstractions/base>
  #include <abstractions/python>
  
  # CAPABILITIES ---------------------------------------
  capability sys_ptrace,
  
  # PSEUDO ---------------------------------------------
  /dev/pts/[0-9]*					w,
  @{PROC}/@{pid}/fd/					r,
  @{PROC}/@{pid}/mounts					r,
  @{PROC}/@{pid}/attr/{current,prev,exec}		r,
  
  # EXECUTABLES ----------------------------------------
  /bin/env						mr,
  @{shell}						Cx,
  /bin/cat						ix,
  /bin/netstat						Px,
  
  # READS/WRITES ---------------------------------------
  /etc/apparmor/logprof.conf				r,
  /etc/inputrc						r,
  /etc/terminfo/x/xterm					r,
  @{PYTHON_PACKAGES}/apparmor/**.pyc{,.*}		w,
  @{PYTHON_PACKAGES}/LibAppArmor/**.pyc{,.*}		w,
  
  # TEMP -----------------------------------------------
  owner /tmp/{,tmp}??????				rw,
  owner /tmp/????????					rw,
  owner /var/tmp/????????				rw,
  
  profile shell @{shell} flags=(complain) {
    #include <abstractions/base>
    
    # CAPABILITIES -------------------------------------
    capability sys_ptrace,
    
    # PSEUDO -------------------------------------------
    /dev/tty						rw,
    @{PROC}/						r,
    @{PROC}/@{pid}/fd/					r,
    @{PROC}/@{pid}/cmdline				r,
    @{PROC}/@{pid}/net/*				r,
    
    # EXECUTABLES --------------------------------------
    @{shell}						mr,
    /bin/netstat					Px,
  }
}

profile apparmor-utils.aa-complain @{PYTHON_EXEC}/aa-complain {
  #include <abstractions/base>
  #include <abstractions/python>
  
  # PSEUDO ---------------------------------------------
  /dev/pts/[0-9]*					w,
  
  # EXECUTABLES ----------------------------------------
  /bin/env						mr,
  /sbin/apparmor_parser					Px,
  
  # READS/WRITES ---------------------------------------
  /etc/inputrc						r,
  /etc/terminfo/x/xterm					r,
  /etc/apparmor/logprof.conf				r,
  /etc/apparmor.d/{,**}					r,
  /etc/apparmor.d/*					w,
  @{PYTHON_PACKAGES}/apparmor/**.pyc{,.*}		w,
  @{PYTHON_PACKAGES}/LibAppArmor/**.pyc{,.*}		w,
  
  # TEMP -----------------------------------------------
  owner /tmp/{,tmp}??????				rw,
}

profile apparmor-utils.aa-enforce @{PYTHON_EXEC}/aa-enforce {
  #include <abstractions/base>
  #include <abstractions/python>
  
  # PSEUDO ---------------------------------------------
  /dev/pts/[0-9]*					w,
  
  # EXECUTABLES ----------------------------------------
  /bin/env						mr,
  /sbin/apparmor_parser					Px,
  
  # READS/WRITES ---------------------------------------
  /etc/inputrc						r,
  /etc/terminfo/x/xterm					r,
  /etc/apparmor/logprof.conf				r,
  /etc/apparmor.d/{,**}					r,
  /etc/apparmor.d/*					w,
  @{PYTHON_PACKAGES}/apparmor/**.pyc{,.*}		w,
  @{PYTHON_PACKAGES}/LibAppArmor/**.pyc{,.*}		w,
  
  # TEMP -----------------------------------------------
  owner /tmp/{,tmp}??????				rw,
}

profile apparmor-utils.aa-disable @{PYTHON_EXEC}/aa-disable {
  #include <abstractions/base>
  #include <abstractions/python>
  
  # PSEUDO ---------------------------------------------
  /dev/pts/[0-9]*					w,
  
  # EXECUTABLES ----------------------------------------
  /bin/env						mr,
  /sbin/apparmor_parser					Px,
  
  # READS/WRITES ---------------------------------------
  /etc/inputrc						r,
  /etc/terminfo/x/xterm					r,
  /etc/apparmor/logprof.conf				r,
  /etc/apparmor.d/{,**}					r,
  /etc/apparmor.d/disable/*				w,
  @{PYTHON_PACKAGES}/apparmor/**.pyc{,.*}		w,
  @{PYTHON_PACKAGES}/LibAppArmor/**.pyc{,.*}		w,
  
  # TEMP -----------------------------------------------
  owner /tmp/{,tmp}??????				rw,
}
