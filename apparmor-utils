# ------------------------------------------------------------------
#
#  Copyright (C) 2016,2017 Mikhail Kurinnoi
#
#  This program is free software; you can redistribute it and/or
#  modify it under the terms of version 2 of the GNU General Public
#  License published by the Free Software Foundation.
#
# ------------------------------------------------------------------

#include <tunables/global>

profile apparmor-utils.aa-status @{PYTHON_EXEC}/aa-status flags=(attach_disconnected) {
  #include <abstractions/base>
  #include <abstractions/python>
  
  # CAPABILITIES ---------------------------------------
  capability sys_ptrace,
  
  # PTRACE ---------------------------------------------
  ptrace (trace),
  
  # PSEUDO ---------------------------------------------
  /dev/pts/[0-9]*					rw,
  /sys/kernel/security/apparmor/*			r,
  @{PROC}/						r,
  @{PROC}/@{pid}/attr/{current,prev,exec}		r,
  @{PROC}/@{pid}/mounts					r,
  
  # READS/WRITES ---------------------------------------
  @{PYTHON_PACKAGES}/apparmor/**.pyc{,.*}		w,
  
  # TEMP -----------------------------------------------
  owner /tmp/????????					rw,
  owner /tmp/apparmor-bugreport-*.txt			rw,
  
  # DENY INHERIT ---------------------------------------
  deny /apparmor/.null					rw,	# flags=(attach_disconnected)
}

profile apparmor-utils.aa-unconfined @{PYTHON_EXEC}/aa-unconfined {
  #include <abstractions/base>
  #include <abstractions/python>
  #include <abstractions/ncurses>
  
  # CAPABILITIES ---------------------------------------
  capability sys_ptrace,
  
  # PTRACE ---------------------------------------------
  ptrace (trace),
  
  # PSEUDO ---------------------------------------------
  /dev/pts/[0-9]*					rw,
  @{PROC}/						r,
  @{PROC}/@{pid}/cmdline				r,
  @{PROC}/@{pid}/fd/					r,
  @{PROC}/@{pid}/mounts					r,
  @{PROC}/@{pid}/attr/{current,prev,exec}		r,
  
  # EXECUTABLES ----------------------------------------
  /bin/env						mr,
  @{shell}						Cx,
  audit /bin/cat					Cx,	# FIX ME! audit 28.06.2017
  /bin/netstat						Px,
  
  # READS/WRITES ---------------------------------------
  /etc/apparmor/logprof.conf				r,
  /etc/inputrc						r,
  @{PYTHON_PACKAGES}/apparmor/**.pyc{,.*}		w,
  @{PYTHON_PACKAGES}/LibAppArmor/**.pyc{,.*}		w,
  
  # TEMP -----------------------------------------------
  owner /tmp/{,tmp}??????				rw,
  owner /tmp/????????					rw,
  owner /tmp/apparmor-bugreport-*.txt			rw,
  owner /var/tmp/????????				rw,
  
  profile shell @{shell} {
    #include <abstractions/base>
    
    # CAPABILITIES -------------------------------------
    capability sys_ptrace,
    
    # PTRACE -------------------------------------------
    ptrace (trace),
    
    # PSEUDO -------------------------------------------
    /dev/tty						rw,
    @{PROC}/						r,
    @{PROC}/@{pid}/fd/					r,
    @{PROC}/@{pid}/cmdline				r,
    @{PROC}/@{pid}/net/*				r,
    
    # EXECUTABLES --------------------------------------
    @{shell}						mr,
    /bin/netstat					Px,
  }
  
  profile cat /bin/cat {
    #include <abstractions/base>
    
    # EXECUTABLES --------------------------------------
    /bin/cat						mr,
  }
}

profile apparmor-utils.aa-complain @{PYTHON_EXEC}/aa-complain {
  #include <abstractions/base>
  #include <abstractions/python>
  #include <abstractions/ncurses>
  
  # PSEUDO ---------------------------------------------
  /dev/pts/[0-9]*					rw,
  
  # EXECUTABLES ----------------------------------------
  /bin/env						mr,
  /sbin/apparmor_parser					Px,
  
  # READS/WRITES ---------------------------------------
  /etc/inputrc						r,
  /etc/apparmor/logprof.conf				r,
  /etc/apparmor.d/{,**}					r,
  /etc/apparmor.d/*					w,
  @{PYTHON_PACKAGES}/apparmor/**.pyc{,.*}		w,
  @{PYTHON_PACKAGES}/LibAppArmor/**.pyc{,.*}		w,
  
  # TEMP -----------------------------------------------
  owner /tmp/{,tmp}??????				rw,
}

profile apparmor-utils.aa-enforce @{PYTHON_EXEC}/aa-enforce {
  #include <abstractions/base>
  #include <abstractions/python>
  #include <abstractions/ncurses>
  
  # PSEUDO ---------------------------------------------
  /dev/pts/[0-9]*					rw,
  
  # EXECUTABLES ----------------------------------------
  /bin/env						mr,
  /sbin/apparmor_parser					Px,
  
  # READS/WRITES ---------------------------------------
  /etc/inputrc						r,
  /etc/apparmor/logprof.conf				r,
  /etc/apparmor.d/{,**}					r,
  /etc/apparmor.d/*					w,
  @{PYTHON_PACKAGES}/apparmor/**.pyc{,.*}		w,
  @{PYTHON_PACKAGES}/LibAppArmor/**.pyc{,.*}		w,
  
  # TEMP -----------------------------------------------
  owner /tmp/{,tmp}??????				rw,
}

profile apparmor-utils.aa-disable @{PYTHON_EXEC}/aa-disable {
  #include <abstractions/base>
  #include <abstractions/python>
  #include <abstractions/ncurses>
  
  # PSEUDO ---------------------------------------------
  /dev/pts/[0-9]*					rw,
  
  # EXECUTABLES ----------------------------------------
  /bin/env						mr,
  /sbin/apparmor_parser					Px,
  
  # READS/WRITES ---------------------------------------
  /etc/inputrc						r,
  /etc/apparmor/logprof.conf				r,
  /etc/apparmor.d/{,**}					r,
  /etc/apparmor.d/disable/*				w,
  @{PYTHON_PACKAGES}/apparmor/**.pyc{,.*}		w,
  @{PYTHON_PACKAGES}/LibAppArmor/**.pyc{,.*}		w,
  
  # TEMP -----------------------------------------------
  owner /tmp/{,tmp}??????				rw,
}

profile apparmor-utils.aa-logprof @{PYTHON_EXEC}/aa-logprof {
  #include <abstractions/base>
  #include <abstractions/python>
  #include <abstractions/ncurses>
  
  # PSEUDO ---------------------------------------------
  /dev/pts/[0-9]*					rw,
  @{PROC}/@{pid}/mounts					r,
  
  # EXECUTABLES ----------------------------------------
  /bin/env						mr,
  
  # READS/WRITES ---------------------------------------
  /etc/inputrc						r,
  /etc/apparmor/logprof.conf				r,
  /etc/apparmor.d/{,**}					r,
  
  # TEMP -----------------------------------------------
  owner /tmp/????????					rw,
}
