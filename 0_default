# ------------------------------------------------------------------
#
#  Copyright (C) 2017 Mikhail Kurinnoi
#
#  This program is free software; you can redistribute it and/or
#  modify it under the terms of version 2 of the GNU General Public
#  License published by the Free Software Foundation.
#
# ------------------------------------------------------------------

# Важно!
# В случае выключенного SECURITY_APPARMOR_UNCONFINED_INIT, заменит
# системный профиль "default".

# Важно!
# Обязательно сохранять имя профиля 0_default, используется в скриптах
# initramfs для замены ("--replace") "default" профиля.

#include <tunables/global>

profile default {
  
  # CAPABILITIES ---------------------------------------
  capability mknod,
  capability dac_override,
  
  # PTRACE ---------------------------------------------
  ptrace (tracedby),
  
  # SIGNAL ---------------------------------------------
  signal (send, receive) peer="default",
  
  # NETWORK --------------------------------------------
  network netlink raw,
  
  # PSEUDO ---------------------------------------------
  @{PROC}/sys/kernel/printk				w,
  
  # EXECUTABLES ----------------------------------------
  /bin/kmod						Px,
  /bin/initramfs_busybox				Cx,
  /bin/grep						Cx,
  /bin/udevadm						Px,
  /lib{,32,64}/rc/sh/cgroup-release-agent.sh		Px,	# openrc
  /usr/lib{,32,64}/portage/@{PYTHON}/cgroup-release-agent Px,	# portage
  
  # READS/WRITES ---------------------------------------
  /run/udev/control					w,
  
  profile initramfs.grep /bin/grep {
    
    # PSEUDO -------------------------------------------
    @{PROC}/@{pid}/mounts				r,
    
    # EXECUTABLES --------------------------------------
    /bin/grep						mr,
    
    # READS/WRITES -------------------------------------
    /etc/ld.so.cache					r,
    /lib{,32,64}/ld{,32,64}-*.so{,.*}			mr,
    /lib{,32,64}/lib*.so{,.*}				mr,
  }
  
  profile initramfs.busybox /bin/initramfs_busybox {
    
    # CAPABILITIES -------------------------------------
    capability sys_admin,
    capability sys_chroot,
    
    # PSEUDO -------------------------------------------
    @{PROC}/sys/kernel/printk				w,
    
    # MOUNT --------------------------------------------
    mount options=(rw, move) /newroot/ -> /,
    mount options=(rw, move) /run/ -> /newroot/run/,
    mount options=(rw, move) /dev/ -> /newroot/dev/,
    mount options=(rw, move) /sys/ -> /newroot/sys/,
    mount options=(rw, move) /proc/ -> /newroot/proc/,
    umount /sys/kernel/security/,
    
    # EXECUTABLES --------------------------------------
    /bin/initramfs_busybox				mr,
    /sbin/init						Px,	# sysvinit
    /sbin/openrc-init					Px,	# openrc-init
    
    # READS/WRITES -------------------------------------
    /							r,
    /{init,lib64}					w,
    /{bin,dev,etc,lib{,32,64},mnt,proc,run,sbin,sys,tmp,temp,usr,var}/{,**} rw,
  }
}
