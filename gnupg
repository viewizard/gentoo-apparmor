# ------------------------------------------------------------------
#
#  Copyright (C) 2016,2017 Mikhail Kurinnoi
#
#  This program is free software; you can redistribute it and/or
#  modify it under the terms of version 2 of the GNU General Public
#  License published by the Free Software Foundation.
#
# ------------------------------------------------------------------

#include <local/tunables.d/>

profile gnupg.gpg-agent /usr/bin/gpg-agent {
  #include <abstractions/base>
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  owner @{PROC}/@{pid}/fd/				r,
  
  # EXECUTABLES ----------------------------------------
  /usr/bin/gpg-agent					mr,
  /usr/bin/pinentry-*					Px,	# app-crypt/pinentry
  
  # READS/WRITES ---------------------------------------
  owner /run/user/@{UID}/gnupg/{,**}			rw,
  /var/lib/gentoo/gkeys/keyrings/gentoo/release/**	rw,
  
  # USERS ----------------------------------------------
  owner @{HOME_CACHE}/gpg-agent-info			rw,
  owner @{HOME}/.gnupg/private-keys-*/{,**}		w,
}

profile gnupg.gpg /usr/bin/gpg{,2,-static} {
  #include <abstractions/base>
  #include <abstractions/ncurses>
  
  # PSEUDO ---------------------------------------------
  /dev/tty						rw,
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  owner @{PROC}/@{pid}/fd/				r,
  
  # EXECUTABLES ----------------------------------------
  /usr/bin/gpg{,2,-static}				mr,
  /usr/bin/gpg-agent					Px,
  
  # READS/WRITES ---------------------------------------
  /etc/inputrc						r,
  /run/openrc/dm-crypt-remdev.*/*			r,
  /run/user/@{UID}/gnupg/{,*}				rw,
  /var/lib/gentoo/gkeys/keyrings/gentoo/release/	r,
  /var/lib/gentoo/gkeys/keyrings/gentoo/release/**	rw,
  owner link subset /var/lib/gentoo/gkeys/keyrings/gentoo/release/**	-> /var/lib/gentoo/gkeys/keyrings/gentoo/release/**,
  
  # USERS ----------------------------------------------
  owner @{HOME}/.gnupg/					rw,
  owner @{HOME}/.gnupg/**				rwk,
  owner link subset @{HOME}/.gnupg/**			-> /{home/*,root}/.gnupg/**,	# TARGET! @{HOME}
  
  # TEMP -----------------------------------------------
  owner /var/tmp/portage/webrsync-@{TMP6}/portage-*	r,	# DELEGATION! portage.emerge-webrsync
  
  # NOISY ----------------------------------------------
  deny /.gnupg/{,**}					r,	# В некоторых случаях, если HOME пользователя не определен, лезет в корень.
}

profile gnupg.gpgconf /usr/bin/gpgconf {
  #include <abstractions/base>
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  owner @{PROC}/@{pid}/fd/				r,
  
  # EXECUTABLES ----------------------------------------
  /usr/bin/gpgconf					mr,
  
  # READS/WRITES ---------------------------------------
  /run/user/@{UID}/gnupg/{,**}				w,
  
  # USERS ----------------------------------------------
  owner @{HOME}/.gnupg/{,**}				rw,
}

profile gnupg.gpgsm /usr/bin/gpgsm {
  #include <abstractions/base>
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  
  # EXECUTABLES ----------------------------------------
  /usr/bin/gpgsm					mr,
}
