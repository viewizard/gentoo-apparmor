# ------------------------------------------------------------------
#
#  Copyright (C) 2016-2018 Mikhail Kurinnoi
#
#  This program is free software; you can redistribute it and/or
#  modify it under the terms of version 2 of the GNU General Public
#  License published by the Free Software Foundation.
#
# ------------------------------------------------------------------

#include <local/tunables.d/>

profile gnupg.gpg-agent /usr/bin/gpg-agent {
  #include <abstractions/base>
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  @{PROC_D}/@{pid}/fd/					r,	# IMPROVE! fsuid=$USER ouid=$USER,root
  
  # EXECUTABLES ----------------------------------------
  /usr/bin/gpg-agent					mr,
  /usr/bin/pinentry-*					Px,	# app-crypt/pinentry
  
  # READS/WRITES ---------------------------------------
  owner /run/user/@{UID}/gnupg/{,**}			rw,
  /var/lib/gentoo/gkeys/keyrings/gentoo/release/**	rw,
  
  # USERS ----------------------------------------------
  owner @{HOME_CACHE_D}/gpg-agent-info			rw,
  owner @{HOME_D}/.gnupg/private-keys-*/{,**}		w,
}

profile gnupg.gpg /usr/bin/gpg{,2,-static} {
  #include <abstractions/base>
  #include <abstractions/ncurses>
  
  # NETWORK --------------------------------------------
  network inet stream,						# Импорт идентификатора ключа.
  network inet6 stream,						# Импорт идентификатора ключа.
  
  # PSEUDO ---------------------------------------------
  /dev/tty						rw,
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  @{PROC_D}/@{pid}/fd/					r,	# IMPROVE! fsuid=$USER ouid=$USER,root
  
  # EXECUTABLES ----------------------------------------
  /usr/bin/gpg{,2,-static}				mr,
  /usr/bin/gpg-agent					Px,
  /usr/bin/dirmngr					Px,
  
  # READS/WRITES ---------------------------------------
  /etc/inputrc						r,
  /run/openrc/dm-crypt-remdev.*/*			r,
  /run/user/@{UID}/gnupg/{,*}				rw,
  /var/lib/gentoo/gkeys/keyrings/gentoo/release/	r,
  /var/lib/gentoo/gkeys/keyrings/gentoo/release/**	rw,
  owner link subset /var/lib/gentoo/gkeys/keyrings/gentoo/release/{,**/}* -> /var/lib/gentoo/gkeys/keyrings/gentoo/release/{,**/}*,
  
  # USERS ----------------------------------------------
  owner @{HOME_D}/.gnupg/{,**}				rw,
  owner @{HOME_D}/.gnupg/{,**/}*			k,
  owner link subset @{HOME_D}/.gnupg/{,**/}*		-> @{HOME_D}/.gnupg/{,**/}*,
  
  # TEMP -----------------------------------------------
  owner /var/tmp/portage/webrsync-@{TMP6}/portage-*	r,	# DELEGATION! portage.emerge-webrsync
  
  # NOISY ----------------------------------------------
  deny /.gnupg/{,**}					r,	# В некоторых случаях, если HOME пользователя не определен, лезет в корень.
}

profile gnupg.gpgconf /usr/bin/gpgconf {
  #include <abstractions/base>
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  @{PROC_D}/@{pid}/fd/					r,	# IMPROVE! fsuid=$USER ouid=$USER,root
  
  # EXECUTABLES ----------------------------------------
  /usr/bin/gpgconf					mr,
  
  # READS/WRITES ---------------------------------------
  /run/user/@{UID}/gnupg/{,**}				w,
  
  # USERS ----------------------------------------------
  owner @{HOME_D}/.gnupg/{,**}				rw,
}

profile gnupg.gpgsm /usr/bin/gpgsm {
  #include <abstractions/base>
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  
  # EXECUTABLES ----------------------------------------
  /usr/bin/gpgsm					mr,
}

profile gnupg.dirmngr /usr/bin/dirmngr {
  #include <abstractions/base>
  
  # NETWORK --------------------------------------------
  network inet stream,						# Импорт идентификатора ключа.
  network inet6 stream,						# Импорт идентификатора ключа.
  network inet dgram,						# Импорт идентификатора ключа.
  network inet6 dgram,						# Импорт идентификатора ключа.
  
  # PSEUDO ---------------------------------------------
  /dev/tty[0-9]*					rw,
  /dev/pts/[0-9]*					rw,
  @{PROC_D}/@{pid}/task/@{pids}/comm			rw,
  
  # EXECUTABLES ----------------------------------------
  /usr/bin/dirmngr					mr,
  
  # READS/WRITES ---------------------------------------
  /etc/hosts						r,
  /etc/ssl/certs/{,**}					r,
  /usr/share/gnupg/{,**}				r,
  owner /run/user/@{UID}/gnupg/S.dirmngr		rw,
  
  # USERS ----------------------------------------------
  owner @{HOME_D}/.gnupg/{,**}				rw,
}
