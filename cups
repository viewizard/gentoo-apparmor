# ------------------------------------------------------------------
#
#    Copyright (C) 2016 Mikhail Kurinnoi
#
#    This program is free software; you can redistribute it and/or
#    modify it under the terms of version 2 of the GNU General Public
#    License published by the Free Software Foundation.
#
# ------------------------------------------------------------------

#include <tunables/global>
profile cups /usr/sbin/cupsd {
  #include <abstractions/base>
  #include <abstractions/bash>
  #include <abstractions/dbus>
  #include <abstractions/fonts>
  #include <abstractions/nameservice>
  #include <abstractions/perl>
  #include <abstractions/authentication>
  
  capability chown,
  capability dac_override,
  capability dac_read_search,
  capability fowner,
  capability fsetid,
  capability net_bind_service,
  capability setgid,
  capability setuid,
  capability kill,
  
  /bin/bash ixr, # FIX ME!
  /bin/cat ix,
  /usr/bin/pmount Px,
  /usr/bin/pumount Px,
  
  /usr/bin/foomatic-rip ixr,
  /etc/foomatic/** r,
  
  /usr/bin/gs ix,
  /usr/bin/pdftops ix,
  /usr/lib/ghostscript/** m,
  /usr/lib64/ghostscript/** m,
  /usr/share/ghostscript/** r,
  /usr/share/ppd/{,**} r,
  /usr/share/gutenprint/{,**} r,
  /usr/libexec/cups/notifier/ r,
  /usr/libexec/cups/driver/ r,
  /usr/libexec/cups/driver/* ix,
  /usr/libexec/cups/daemon/* ix,
  /usr/libexec/cups/cgi-bin/* ix,
  /usr/libexec/cups/filter/* ix,
  /etc/ghostscript/** r,
  
  # web-admin part
  /etc/environment r,
  /usr/libexec/cups/backend/ r,
  /usr/libexec/cups/backend/* ix,
  # usb backend
  /dev/ r,
  /dev/bus/usb/ r,
  /etc/udev/udev.conf r,
  /sys/bus/ r,
  /sys/bus/usb/devices/ r,
  /sys/class/ r,
  /sys/devices/pci**/usb**/ r,
  /sys/devices/pci**/usb**/* r,
  
  /dev/lp0 rw,
  /dev/tty rw,
  /dev/ttyS? w,
  /etc/cups rw,
  /etc/cups/ r,
  /etc/cups/** r,
  /etc/cups/certs w,
  /etc/cups/certs/* w,
  /etc/cups/*.conf* rw,
  /etc/cups/ppd/{,**} rw,
  /etc/papersize r,
  /etc/printcap rw,
  /etc/cups/printcap rw,
  /etc/cups/ssl rw,
  /etc/cups/yes/* rw,
  /etc/hosts.allow r,
  /etc/hosts.deny r,
  @{PROC}/meminfo r,
  @{PROC}/sys/dev/parport/** r,
  /sys/class/usb r,
  /usr/bin/perl ix,
  /usr/bin/smbspool ixr,
  /usr/lib/cups/backend/* ixr,
  /usr/lib/cups/filter/* ixr,
  /usr/lib64/gutenprint/**.so m,
  /usr/sbin/cupsd mixr,
  /usr/share/cups/** r,
  /var/log/cups/ rw,
  /var/log/cups/access_log rw,
  /var/log/cups/error_log rw,
  /var/log/cups/page_log rw,
  /var/spool/cups rw,
  /var/spool/cups/** rw,
  /var/spool/cups/tmp w,
  /var/spool/cups/tmp/ r,
  /{,var/}run/cups/ rw,
  /{,var/}run/cups/** rw,
  /var/cache/cups/ rw,
  /var/cache/cups/** rwk,
  
}


profile cups.init.d /etc/init.d/cupsd {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openrc>
  
  capability fsetid,
  capability chown,
  capability dac_override,
  capability dac_read_search,
  
  /usr/sbin/cupsd Px,
  /bin/bash Cx -> shell,
  
  /etc/init.d/cupsd r,
  
  /var/cache/cups/ w,
  /run/cups/ w,
  /run/cups/certs/ w,
  
  
  profile shell {
    #include <abstractions/base>
    
    /dev/tty rw,
    
    /bin/bash r,
    /lib64/rc/sh/gendepends.sh Px,
    
  }
  
}
